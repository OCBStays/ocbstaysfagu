<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays - Food Menu</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    /* Your existing styles here */
  </style>
</head>
<body class="bg-light">
  <div class="container py-5 menu-wrapper">
    <h1 class="mb-4">üçΩÔ∏è OCB Stays ‚Äì Food Menu</h1>
    <p class="text-muted mb-4">Select items below. Orders will be delivered to your room.</p>
    <h5 id="roomHeader" class="text-primary mb-4"></h5>
    <div id="menuContainer"></div>

    <div id="confirmationMsg" class="alert alert-success mt-4 d-none">
      ‚úÖ Order placed successfully!
    </div>
  </div>

  <div id="floatingControls">
    <div id="floatingSearch">
      <input id="menuSearch" class="form-control" type="text" placeholder="Search items..." />
    </div>
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Categories
      </button>
      <ul class="dropdown-menu dropdown-menu-scrollable" id="categoryDropdown"></ul>
    </div>
    <button id="floatingCart" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cartModal">
      üõí <span id="cartCount">0</span> | ‚Çπ<span id="cartTotal">0</span>
    </button>
  </div>

  <button id="scrollTopBtn" class="scroll-button">‚Üë</button>
  <button id="scrollBottomBtn" class="scroll-button">‚Üì</button>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">üõí Your Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="confirmationMsgModal" class="alert alert-success mt-2 d-none">
            ‚úÖ Order placed successfully!
          </div>
          <div id="cartItems"></div>
          <div class="mt-3">
            <label for="instructions" class="form-label">Special Instructions</label>
            <textarea id="instructions" class="form-control" rows="3"></textarea>
          </div>
          <div class="mt-3">
            <strong>Total: ‚Çπ<span id="cartTotalModal">0</span></strong>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="placeOrder" class="btn btn-primary">
            Place Order
            <span id="orderSpinner" class="loading-spinner" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const MENU_SHEET_URL = 'https://opensheet.elk.sh/12TG5XURaO5WIhFH2f1z9RG9sjCMCRiVDdzZWDHIdrGs/Sheet1';
    const AIRTABLE_TOKEN = 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980';
    const BASE_ID = 'app2UvEfKduRwGjfR';
    const ORDERS_TABLE = 'Orders';
    const GUESTS_TABLE = 'Guests';

    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || '';
    const guestID = params.get('guestID') || '';
    document.getElementById('roomHeader').textContent = `Room: ${room}`;
    let cart = {};

    async function getGuestRecordID(guestID) {
      try {
        const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${GUESTS_TABLE}?filterByFormula={GuestID}="${guestID}"`, {
          headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
        });
        const data = await response.json();
        return data.records[0]?.id || null;
      } catch (error) {
        console.error('Error fetching guest record ID:', error);
        return null;
      }
    }

    document.getElementById('placeOrder').addEventListener('click', async () => {
      const placeOrderBtn = document.getElementById('placeOrder');
      const spinner = document.getElementById('orderSpinner');
      const instructions = document.getElementById('instructions').value;

      if (Object.keys(cart).length === 0) {
        alert('Your cart is empty!');
        return;
      }

      placeOrderBtn.disabled = true;
      spinner.style.display = 'inline-block';

      try {
        const orderItems = Object.values(cart).map(item => ({
          name: item.name,
          price: item.price,
          quantity: item.quantity
        }));

        const totalAmount = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const guestRecordID = await getGuestRecordID(guestID);

        if (!guestRecordID) {
          throw new Error('Invalid guest record ID.');
        }

        const orderResponse = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${ORDERS_TABLE}`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${AIRTABLE_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: {
              OrderID: `ORD-${Date.now().toString().slice(-6)}`,
              Guest: [guestRecordID],
              Room: room,
              Items: JSON.stringify(orderItems),
              TotalAmount: totalAmount,
              SpecialInstructions: instructions,
              Status: "Pending"
            }
          })
        });

        if (!orderResponse.ok) {
          throw new Error('Failed to save order.');
        }

        document.getElementById('confirmationMsg').classList.remove('d-none');
        document.getElementById('confirmationMsgModal').classList.remove('d-none');
        setTimeout(() => {
          document.getElementById('confirmationMsg').classList.add('d-none');
        }, 5000);

        cart = {};
        updateCartUI();

        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
          modal.hide();
          document.getElementById('confirmationMsgModal').classList.add('d-none');
        }, 2000);
      } catch (error) {
        console.error('Order error:', error);
        alert('Failed to place order. Please try again.');
      } finally {
        placeOrderBtn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    // Initialize
    loadMenu();
  </script>
</body>
</html>

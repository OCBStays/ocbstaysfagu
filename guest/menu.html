<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCB Stays - Food Menu</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .menu-category {
      margin-top: 2rem;
    }
    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 0.75rem 0;
    }
    .menu-item-name {
      font-weight: 500;
    }
    .menu-item-price {
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">üçΩÔ∏è OCB Stays ‚Äì Food Menu</h1>
    <div id="menu"></div>

    <div class="mt-5">
      <h4>Your Order</h4>
      <ul id="cart" class="list-group mb-3"></ul>
      <div class="mb-3">
        <label class="form-label">Special Instructions</label>
        <textarea class="form-control" id="instructions" rows="2"></textarea>
      </div>
      <button class="btn btn-success" onclick="submitOrder()">Place Order</button>
      <div class="text-success mt-3 d-none" id="confirmation">Order placed successfully!</div>
    </div>
  </div>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/12TG5XURaO5WIhFH2f1z9RG9sjCMCRiVDdzZWDHIdrGs/gviz/tq?tqx=out:json';
    const cart = [];

    function renderMenu(data) {
      const categories = {};
      data.forEach(row => {
        if (row[4] === 'Yes') {
          if (!categories[row[0]]) categories[row[0]] = [];
          categories[row[0]].push({ name: row[1], description: row[2], price: row[3] });
        }
      });

      const menuDiv = document.getElementById('menu');
      Object.entries(categories).forEach(([category, items]) => {
        const section = document.createElement('div');
        section.classList.add('menu-category');
        section.innerHTML = `<h4>${category}</h4>`;
        items.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.classList.add('menu-item');
          itemDiv.innerHTML = `
            <div>
              <div class="menu-item-name">${item.name}</div>
              <div class="text-muted small">${item.description}</div>
            </div>
            <div>
              <span class="menu-item-price">‚Çπ${item.price}</span>
              <button class="btn btn-sm btn-primary ms-2" onclick='addToCart("${item.name}", ${item.price})'>Add</button>
            </div>
          `;
          section.appendChild(itemDiv);
        });
        menuDiv.appendChild(section);
      });
    }

    function addToCart(name, price) {
      const existing = cart.find(i => i.name === name);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ name, price, qty: 1 });
      }
      renderCart();
    }

    function renderCart() {
      const cartEl = document.getElementById('cart');
      cartEl.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          ${item.name} (x${item.qty})
          <span>‚Çπ${item.price * item.qty}</span>
        `;
        cartEl.appendChild(li);
      });
    }

    function submitOrder() {
      const instructions = document.getElementById('instructions').value;
      const orderData = {
        room: new URLSearchParams(window.location.search).get('room'),
        cart,
        instructions
      };
      console.log('Order:', orderData);

      // TODO: Send this to Google Apps Script
      document.getElementById('confirmation').classList.remove('d-none');
    }

    async function fetchMenu() {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
      renderMenu(rows.slice(1)); // skip header
    }

    fetchMenu();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays – Host Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #1a1c23;
      --card-bg: #2d2f3b;
      --text-color: #e2e8f0;
      --secondary-text: #94a3b8;
      --border-color: #4b5563;
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --accent-gradient: linear-gradient(45deg, #3b82f6, #8b5cf6);
      --shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
    }

    [data-theme="light"] {
      --bg-color: #ffffff;
      --card-bg: #f8fafc;
      --text-color: #1e293b;
      --secondary-text: #64748b;
      --border-color: #e2e8f0;
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      padding: 1rem;
      margin: 0 auto;
      max-width: 1600px;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }

    .container {
      flex: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: var(--accent-gradient);
    }

    .clock {
      font-size: 0.875rem;
      color: var(--secondary-text);
    }

    .theme-toggle {
      cursor: pointer;
      font-size: 1rem;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 50%;
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .dashboard-card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      max-height: 400px;
      overflow-y: auto;
    }

    .dashboard-card.no-scroll {
      max-height: none;
      overflow-y: visible;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    .dashboard-card h6 {
      margin-bottom: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .dashboard-card .card-content {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .dashboard-card .card-content > div {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }

    .dashboard-card .card-content > div:last-child {
      border-bottom: none;
    }

    .action-icon {
      font-size: 0.875rem;
      padding: 0.375rem;
      border-radius: 0.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
    }

    .copy-icon {
      color: var(--secondary-text);
      font-size: 0.75rem;
      margin-left: 0.25rem;
      cursor: pointer;
    }

    .copy-icon:hover {
      color: var(--primary-color);
    }

    .calendar-icon {
      font-size: 0.875rem;
      padding: 0.375rem;
      border-radius: 0.5rem;
      cursor: pointer;
      background: var(--primary-color);
      color: white;
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
    }

    .guest-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      background: var(--card-bg);
      max-height: 400px;
      overflow-y: auto;
    }

    .guest-list-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }

    .guest-list-item:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }

    .guest-list-item.active {
      background: var(--accent-gradient);
      color: white;
    }

    .guest-details-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .guest-details-container {
        grid-template-columns: 1fr 2fr;
      }
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 0.75rem;
      border: none;
      box-shadow: var(--shadow);
    }

    .form-control, .form-select {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--accent-gradient);
      border: none;
      border-radius: 0.5rem;
      transition: transform 0.2s;
      font-size: 0.875rem;
      padding: 0.375rem 0.75rem;
    }

    .nav-tabs {
      border: none;
      background: var(--card-bg);
      border-radius: 0.5rem;
      padding: 0.25rem;
    }

    .nav-link {
      color: var(--secondary-text);
      border: none;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }

    .nav-link.active {
      background: var(--accent-gradient);
      color: white !important;
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1100;
    }

    .flatpickr-day.booked {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .calendar-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 992px) {
      .calendar-container {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container"></div>
  <div class="container mx-auto">
    <div class="header">
      <div>
        <h1 class="text-xl font-bold text-white">OCB Stays – Host Management</h1>
        <div class="clock" id="currentTime" aria-live="polite"></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
          <i class="fas fa-user-plus"></i> Register Guest
        </button>
        <i class="fas fa-sun theme-toggle" id="themeToggle" title="Toggle Theme" aria-label="Toggle Theme"></i>
      </div>
    </div>

    <div class="manage-content">
      <ul class="nav nav-tabs mb-3" id="manageTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-guests" type="button" role="tab" aria-controls="active-guests" aria-selected="false">Current Guests</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-guests" type="button" role="tab" aria-controls="past-guests" aria-selected="false">Past Guests</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="dashboard-card relative">
              <h6>Current Guests</h6>
              <div id="currentGuestsCount" class="mb-1 text-sm"><strong>0</strong> guests</div>
              <div id="currentGuestsList" class="card-content space-y-1"></div>
            </div>
            <div class="dashboard-card relative">
              <h6>Upcoming Bookings</h6>
              <div id="upcomingBookings" class="card-content space-y-1"></div>
            </div>
            <div class="dashboard-card relative">
              <h6>Room Occupancy</h6>
              <i class="fas fa-calendar-alt calendar-icon" data-bs-toggle="modal" data-bs-target="#calendarModal" title="View Occupancy Calendar"></i>
              <div id="roomOccupancy" class="card-content space-y-1"></div>
            </div>
            <div class="dashboard-card relative">
              <h6>Revenue Snapshot</h6>
              <div id="revenueSummary" class="card-content space-y-1"></div>
            </div>
            <div class="dashboard-card relative">
              <h6>Pending Balances</h6>
              <div id="pendingBalances" class="card-content space-y-1"></div>
            </div>
            <div class="dashboard-card relative">
              <h6>Recent Food Orders</h6>
              <div id="recentOrders" class="card-content space-y-1"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="active-guests" role="tabpanel" aria-labelledby="active-tab">
          <div class="guest-details-container">
            <div>
              <label class="block text-sm font-medium mb-1">Current Guests</label>
              <div class="guest-list" id="guestList">
                <div class="text-center py-2"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>
              </div>
            </div>
            <div id="selectedGuestInfo" class="hidden">
              <div class="dashboard-card relative no-scroll">
                <i class="fas fa-edit edit-icon-btn absolute top-3 right-3 cursor-pointer text-gray-400 hover:text-blue-500" id="editGuestBtn"></i>
                <div id="guestDetailsContent"></div>
              </div>
              <div class="flex gap-1 mt-2 flex-wrap">
                <a class="action-icon bg-green-600 text-white" id="callGuest" title="Call Guest"><i class="fas fa-phone"></i></a>
                <div class="action-icon bg-green-500 text-white" id="sendWhatsappToGuest" title="Send WhatsApp"><i class="fab fa-whatsapp"></i></div>
                <div class="action-icon bg-blue-600 text-white" id="sendEmailToGuest" title="Send Email"><i class="fas fa-envelope"></i></div>
                <div class="action-icon bg-gray-600 text-white" id="copyGuestLink" title="Copy Link"><i class="fas fa-copy"></i></div>
                <div class="action-icon bg-red-500 text-white" id="placeOrder" title="Place Food Order"><i class="fas fa-utensils"></i></div>
                <button id="generateBill" class="btn btn-primary"><i class="fas fa-file-invoice"></i> Generate Bill</button>
                <button id="checkoutGuest" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Checkout</button>
              </div>
              <div id="billOutput" class="mt-2"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="past-guests" role="tabpanel" aria-labelledby="past-tab">
          <div class="guest-details-container">
            <div>
              <label class="block text-sm font-medium mb-1">Past Guests</label>
              <div class="guest-list" id="pastGuestList">
                <div class="text-center py-2"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>
              </div>
            </div>
            <div id="selectedPastGuestInfo" class="hidden">
              <div class="dashboard-card no-scroll">
                <div id="pastGuestDetailsContent"></div>
              </div>
              <div class="flex gap-1 mt-2 flex-wrap">
                <button id="generatePastBill" class="btn btn-primary"><i class="fas fa-file-invoice"></i> Generate Bill</button>
              </div>
              <div id="pastBillOutput" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals (same as before but with updated styling) -->
  <!-- Register Modal, Edit Guest Modal, Checkout Modal, Food Orders Modal, Calendar Modal, Registration Success Modal, Revenue Breakdown Modal -->
  <!-- Content remains the same but with updated class names for consistency -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Configuration
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: { guests: 'Guests', bills: 'Bills', orders: 'Orders' }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"],
      paymentModes: ["UPI", "Cash", "Card", "NetBanking"]
    };

    // Utility Functions
    const utils = {
      generateGuestId: () => 'GST' + Array(5).fill().map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      formatDate: date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
      formatDateTime: date => new Date(date).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true }),
      today: () => new Date().toISOString().split('T')[0],
      nextWeek: () => new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      datesOverlap: (start1, end1, start2, end2) => {
        const d1 = new Date(start1), d2 = new Date(end1), d3 = new Date(start2), d4 = new Date(end2);
        return d1 < d4 && d3 < d2;
      },
      calculateNights: (checkin, checkout) => Math.round(Math.abs(new Date(checkin) - new Date(checkout)) / (24 * 60 * 60 * 1000)),
      fetchAirtable: async (endpoint, options = {}) => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
        try {
          const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${config.airtable.token}`, 'Content-Type': 'application/json' },
            ...options
          });
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API request failed');
          return response.json();
        } catch (error) {
          console.error('Airtable API error:', error);
          throw error;
        }
      },
      showToast: (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type === 'success' ? 'green' : type === 'warning' ? 'yellow' : 'red'}-500 border-0`;
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.querySelector('.toast-container').appendChild(toast);
        new bootstrap.Toast(toast).show();
        setTimeout(() => toast.remove(), 5000);
      },
      updateElement: (id, content) => document.getElementById(id).innerHTML = content
    };

    // Core Application Logic
    const app = {
      cachedGuests: null,
      cachedOrders: null,
      calendarInstances: [],
      async loadDashboard() {
        try {
          const today = utils.today();
          const nextWeek = utils.nextWeek();
          this.cachedGuests = await utils.fetchAirtable(`${config.airtable.tables.guests}?sort[0][field]=checkin`);
          this.cachedOrders = await utils.fetchAirtable(`${config.airtable.tables.orders}?sort[0][field]=OrderDate&sort[0][direction]=desc&maxRecords=3`);

          // Current Guests (only those with status = Active)
          const currentGuests = this.cachedGuests.records.filter(r => {
            const checkin = new Date(r.fields.checkin);
            const checkout = new Date(r.fields.checkout);
            const todayDate = new Date(today);
            return (r.fields.status === 'Active') && checkin <= todayDate && checkout >= todayDate;
          });
          
          utils.updateElement('currentGuestsCount', `<strong>${currentGuests.length}</strong> guests`);
          utils.updateElement('currentGuestsList', currentGuests.length ? currentGuests.map(r => `
            <div class="flex justify-between items-center">
              <span>${r.fields.name || 'Unnamed Guest'}</span>
              <span class="text-xs text-gray-400">${r.fields.room}</span>
            </div>
          `).join('') : '<div class="text-gray-400">No current guests</div>');

          // Upcoming Bookings
          const upcomingGuests = this.cachedGuests.records.filter(r => new Date(r.fields.checkin) > new Date(today) && new Date(r.fields.checkin) <= new Date(nextWeek));
          utils.updateElement('upcomingBookings', upcomingGuests.length ? upcomingGuests.map(r => `
            <div class="flex justify-between items-center">
              <span>${r.fields.name || 'Unnamed Guest'}</span>
              <span class="text-xs text-gray-400">${utils.formatDate(r.fields.checkin)}</span>
            </div>
          `).join('') : '<div class="text-gray-400">No upcoming bookings</div>');

          // Room Occupancy
          const occupiedRooms = new Set(currentGuests.map(r => r.fields.room));
          utils.updateElement('roomOccupancy', config.rooms.map(room => `
            <div class="flex justify-between items-center">
              <span>${room}</span>
              <span class="text-xs ${occupiedRooms.has(room) ? 'text-red-500' : 'text-green-500'}">${occupiedRooms.has(room) ? 'Occupied' : 'Available'}</span>
            </div>
          `).join(''));

          // Revenue Snapshot
          const advanceTotal = this.cachedGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.advanceAmount) || 0), 0);
          const balanceTotal = this.cachedGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.balanceAmount) || 0), 0);
          const foodTotal = this.cachedOrders.records.reduce((sum, r) => sum + (parseFloat(r.fields.TotalAmount) || 0), 0);
          utils.updateElement('revenueSummary', `
            <div class="flex justify-between items-center">
              <span>Advance Payments</span>
              <span>₹${advanceTotal.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span>Balance Payments</span>
              <span>₹${balanceTotal.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span>Food Orders</span>
              <span>₹${foodTotal.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center font-semibold mt-1 pt-1 border-t border-gray-600">
              <span>Total Revenue</span>
              <span>₹${(advanceTotal + balanceTotal + foodTotal).toFixed(2)}</span>
            </div>
          `);

          // Recent Food Orders
          utils.updateElement('recentOrders', this.cachedOrders.records.length ? this.cachedOrders.records.map(r => {
            const guest = this.cachedGuests.records.find(g => g.fields.guestID === r.fields.Guest);
            const items = JSON.parse(r.fields.Items || '[]');
            const totalAmount = r.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            return `
              <div class="flex justify-between items-center">
                <span>${guest?.fields.name || 'Guest'}</span>
                <span class="text-xs text-gray-400">₹${totalAmount.toFixed(2)}</span>
              </div>
            `;
          }).join('') : '<div class="text-gray-400">No recent orders</div>');

        } catch (error) {
          utils.showToast('Error loading dashboard: ' + error.message, 'danger');
          console.error('Dashboard error:', error);
        }
      },

      // Updated initOccupancyCalendar to show two months on desktop
      initOccupancyCalendar() {
        const calendarContainer = document.getElementById('occupancyCalendar');
        calendarContainer.innerHTML = '';
        
        // Create two calendar instances
        const now = new Date();
        const nextMonth = new Date(now);
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        
        [now, nextMonth].forEach((date, index) => {
          const calendarDiv = document.createElement('div');
          calendarDiv.className = 'mb-4';
          calendarContainer.appendChild(calendarDiv);
          
          const monthHeader = document.createElement('div');
          monthHeader.className = 'text-center font-semibold mb-2';
          monthHeader.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
          calendarDiv.appendChild(monthHeader);
          
          const instance = flatpickr(calendarDiv, {
            inline: true,
            defaultDate: date,
            dateFormat: 'Y-m-d',
            onDayCreate: (dObj, dStr, fp, dayElem) => {
              const date = dayElem.dateObj.toISOString().split('T')[0];
              const bookings = this.cachedGuests.records.filter(r => {
                const checkin = new Date(r.fields.checkin);
                const checkout = new Date(r.fields.checkout);
                const currentDate = new Date(date);
                return checkin <= currentDate && currentDate <= checkout;
              });
              if (bookings.length) {
                const roomFilter = document.getElementById('calendarRoomFilter').value;
                const filteredBookings = roomFilter ? bookings.filter(b => b.fields.room === roomFilter) : bookings;
                if (filteredBookings.length) {
                  dayElem.classList.add('booked');
                  dayElem.title = filteredBookings.map(b => `${b.fields.room} (${b.fields.name || 'Unnamed Guest'})`).join('\n');
                }
              }
            }
          });
          this.calendarInstances.push(instance);
        });
        
        document.getElementById('prevMonth').onclick = () => this.calendarInstances.forEach(inst => inst.changeMonth(-1));
        document.getElementById('nextMonth').onclick = () => this.calendarInstances.forEach(inst => inst.changeMonth(1));
        document.getElementById('calendarRoomFilter').onchange = () => {
          const roomFilter = document.getElementById('calendarRoomFilter').value;
          this.calendarInstances.forEach(inst => inst.redraw());
        };
      },

      // Rest of the application logic remains the same but with updated styling
      // ...
    };

    // Initialize the application
    (async () => {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.dataset.theme = savedTheme;
      document.getElementById('themeToggle').className = `fas fa-${savedTheme === 'dark' ? 'sun' : 'moon'} theme-toggle`;
      
      // Theme toggle event
      document.getElementById('themeToggle').onclick = () => {
        const isDark = document.documentElement.dataset.theme === 'dark';
        document.documentElement.dataset.theme = isDark ? 'light' : 'dark';
        document.getElementById('themeToggle').className = `fas fa-${isDark ? 'moon' : 'sun'} theme-toggle`;
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      };

      // Clock
      setInterval(() => {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit', 
          second: '2-digit', 
          hour12: true 
        });
      }, 1000);

      await app.loadDashboard();
      await app.loadGuests('current');
      await app.loadGuests('past');
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays – Host Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #1a1c23;
      --card-bg: #2d2f3b;
      --text-color: #e2e8f0;
      --secondary-text: #94a3b8;
      --border-color: #4b5563;
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --accent-gradient: linear-gradient(45deg, #3b82f6, #8b5cf6);
      --shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
    }

    [data-theme="light"] {
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-color: #1f2937;
      --secondary-text: #6b7280;
      --border-color: #e5e7eb;
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      padding: 2rem;
      margin: 0 auto;
      max-width: 1600px;
      display: flex;
      flex-direction: column;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Orbitron', sans-serif;
    }

    .container {
      flex: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem 2rem;
      border-radius: 12px;
      background: var(--accent-gradient);
    }

    .clock {
      font-size: 1rem;
      color: var(--secondary-text);
      font-family: 'Orbitron', sans-serif;
    }

    .theme-toggle {
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 50%;
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .dashboard-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .dashboard-card.no-scroll {
      max-height: none;
      overflow-y: visible;
    }

    .dashboard-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .dashboard-card h6 {
      margin-bottom: 1rem;
      font-size: 1.125rem;
      font-weight: 600;
      line-height: 1.5;
    }

    .dashboard-card .card-content {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-top: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .dashboard-card .card-content > div {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-card .card-content > div:last-child {
      border-bottom: none;
    }

    .action-icon {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
    }

    .action-icon:hover {
      transform: translateY(-2px);
    }

    .copy-icon {
      color: var(--secondary-text);
      font-size: 0.9rem;
      margin-left: 0.5rem;
      cursor: pointer;
    }

    .copy-icon:hover {
      color: var(--primary-color);
    }

    .calendar-icon {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      background: var(--primary-color);
      color: white;
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    .calendar-icon:hover {
      background: var(--primary-hover);
    }

    .guest-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      max-height: 600px;
      overflow-y: auto;
      width: 35%;
    }

    .guest-list-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      gap: 0.75rem;
    }

    .guest-list-item:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }

    .guest-list-item.active {
      background: var(--accent-gradient);
      color: white;
    }

    .guest-info {
      width: 65%;
      padding-left: 1rem;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow);
    }

    .form-control, .form-select {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    .btn-primary {
      background: var(--accent-gradient);
      border: none;
      border-radius: 8px;
      transition: transform 0.2s;
    }

    .btn-primary:hover {
      transform: scale(1.05);
    }

    .nav-tabs {
      border: none;
      background: #2d2f3b;
      border-radius: 8px;
      padding: 0.5rem;
    }

    .nav-link {
      color: var(--secondary-text);
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      transition: background-color 0.2s, color 0.2s;
    }

    .nav-link:hover {
      color: var(--text-color);
      background: rgba(59, 130, 246, 0.1);
    }

    .nav-link.active {
      background: var(--accent-gradient);
      color: white !important;
      border-bottom: 2px solid white;
      font-weight: bold;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }

    .flatpickr-day.booked {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    .flatpickr-day.booked:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    .selection-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }
    .selection-toolbar .left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .select-all {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .danger-text {
      color: #f87171;
    }
    .hidden {
      display: none !important;
    }
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="toast-container"></div>
  <div class="container mx-auto">
    <div class="header">
      <div>
        <h1 class="text-2xl font-bold text-white">OCB Stays – Host Management</h1>
        <div class="clock" id="currentTime" aria-live="polite"></div>
      </div>
      <div class="flex items-center gap-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
          <i class="fas fa-user-plus"></i> Register Guest
        </button>
        <i class="fas fa-sun theme-toggle" id="themeToggle" title="Toggle Theme" aria-label="Toggle Theme"></i>
      </div>
    </div>

    <div class="manage-content">
      <ul class="nav nav-tabs mb-4" id="manageTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-guests" type="button" role="tab" aria-controls="active-guests" aria-selected="false">Current Guests</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-guests" type="button" role="tab" aria-controls="past-guests" aria-selected="false">Past Guests</button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Dashboard -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Current Guests (by dates)</h6>
              <div id="currentGuestsCount" class="mb-2 text-xl"><strong>0</strong> guests</div>
              <div id="currentGuestsList" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Upcoming Bookings (next 7 days)</h6>
              <div id="upcomingBookings" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Room Occupancy</h6>
              <i class="fas fa-calendar-alt calendar-icon" data-bs-toggle="modal" data-bs-target="#calendarModal" title="View Occupancy Calendar"></i>
              <div id="roomOccupancy" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Revenue Snapshot</h6>
              <div id="revenueSummary" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Pending Balances</h6>
              <div id="pendingBalances" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Ongoing Food Orders</h6>
              <div id="recentOrders" class="card-content"></div>
            </div>
            <div class="dashboard-card relative">
              <h6 class="text-lg font-semibold">Check-Outs Today</h6>
              <div id="checkoutsToday" class="card-content"></div>
            </div>
          </div>
        </div>

        <!-- Active Guests Manage -->
        <div class="tab-pane fade" id="active-guests" role="tabpanel" aria-labelledby="active-tab">
          <div class="flex flex-row gap-4">
            <div class="guest-list" style="width:35%;">
              <div class="selection-toolbar">
                <div class="left">
                  <label class="select-all"><input type="checkbox" id="selectAllCurrent"> <span>Select all</span></label>
                  <button class="btn btn-sm btn-danger" id="deleteSelectedCurrent"><i class="fas fa-trash"></i> Delete Selected</button>
                </div>
                <span id="currentSelectedCount" class="text-sm text-gray-400">0 selected</span>
              </div>
              <div id="guestList">
                <div class="text-center py-3"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>
              </div>
            </div>
            <div class="guest-info" id="selectedGuestInfo" class="hidden">
              <div class="dashboard-card relative no-scroll">
                <i class="fas fa-edit edit-icon-btn absolute top-4 right-4 cursor-pointer text-gray-400 hover:text-blue-500" id="editGuestBtn"></i>
                <div id="guestDetailsContent"></div>
              </div>
              <div class="flex gap-2 mt-4 flex-wrap">
                <a class="action-icon bg-green-600 text-white" id="callGuest" title="Call Guest"><i class="fas fa-phone"></i></a>
                <div class="action-icon bg-green-500 text-white" id="sendWhatsappToGuest" title="Send WhatsApp"><i class="fab fa-whatsapp"></i></div>
                <div class="action-icon bg-blue-600 text-white" id="sendEmailToGuest" title="Send Email"><i class="fas fa-envelope"></i></div>
                <div class="action-icon bg-gray-600 text-white" id="copyGuestLink" title="Copy Link"><i class="fas fa-copy"></i></div>
                <div class="action-icon bg-red-500 text-white" id="placeOrder" title="Place Food Order"><i class="fas fa-utensils"></i></div>
                <button id="generateBill" class="btn btn-primary"><i class="fas fa-file-invoice"></i> Generate Bill <span id="billSpinner" class="loading-spinner hidden"></span></button>
                <button id="checkoutGuest" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Checkout <span id="checkoutSpinner" class="loading-spinner hidden"></span></button>
              </div>
              <div id="billOutput" class="mt-4"></div>
            </div>
          </div>
        </div>

        <!-- Past Guests Manage -->
        <div class="tab-pane fade" id="past-guests" role="tabpanel" aria-labelledby="past-tab">
          <div class="flex flex-row gap-4">
            <div class="guest-list" style="width:35%;">
              <div class="selection-toolbar">
                <div class="left">
                  <label class="select-all"><input type="checkbox" id="selectAllPast"> <span>Select all</span></label>
                  <button class="btn btn-sm btn-danger" id="deleteSelectedPast"><i class="fas fa-trash"></i> Delete Selected</button>
                </div>
                <span id="pastSelectedCount" class="text-sm text-gray-400">0 selected</span>
              </div>
              <div id="pastGuestList">
                <div class="text-center py-3"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>
              </div>
            </div>
            <div class="guest-info" id="selectedPastGuestInfo" class="hidden">
              <div class="dashboard-card no-scroll">
                <div id="pastGuestDetailsContent"></div>
              </div>
              <div class="flex gap-2 mt-4 flex-wrap">
                <button id="generatePastBill" class="btn btn-primary"><i class="fas fa-file-invoice"></i> Generate Bill <span id="pastBillSpinner" class="loading-spinner hidden"></span></button>
              </div>
              <div id="pastBillOutput" class="mt-4"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Register New Guest</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="guestForm">
            <div class="mb-4">
              <label for="dateRange" class="form-label">Dates</label>
              <input type="text" class="form-control" id="dateRange" placeholder="Select check-in and check-out dates" required>
            </div>
            <div class="mb-4">
              <label for="room" class="form-label">Room</label>
              <select class="form-select" id="room" required disabled>
                <option value="">Select dates first</option>
              </select>
            </div>
            <div id="availabilityStatus" class="text-sm"></div>
            <div class="mb-4">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-4">
              <label for="mobile" class="form-label">Mobile Number</label>
              <div class="relative">
                <input type="tel" class="form-control" id="mobile" required>
                <span class="copy-icon absolute right-3 top-1/2 -translate-y-1/2" onclick="navigator.clipboard.writeText(document.getElementById('mobile').value);utils.showToast('Mobile copied!', 'success');"><i class="fas fa-copy"></i></span>
              </div>
            </div>
            <div class="mb-4">
              <label class="form-label">Advance Payment</label>
              <div class="flex gap-2">
                <input type="number" class="form-control flex-2" id="advanceAmount" placeholder="Amount (₹)">
                <select class="form-select flex-1 min-w-[120px]" id="advanceMode">
                  <option value="">Payment Mode</option>
                  <option value="UPI">UPI</option>
                  <option value="Cash">Cash</option>
                  <option value="Card">Card</option>
                  <option value="NetBanking">Net Banking</option>
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label for="balanceAmount" class="form-label">Balance Amount (₹)</label>
              <input type="number" class="form-control" id="balanceAmount">
            </div>
            <div class="mb-4">
              <label for="comments" class="form-label">Notes</label>
              <textarea class="form-control" id="comments" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="registerBtn" form="guestForm">
            Register <span id="registerSpinner" class="loading-spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Guest Modal -->
  <div class="modal fade" id="editGuestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Edit Guest Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editGuestForm">
            <div class="mb-4">
              <label for="editName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="mb-4">
              <label for="editMobile" class="form-label">Mobile Number</label>
              <div class="relative flex items-center gap-2">
                <input type="tel" class="form-control flex-1" id="editMobile" required>
                <a class="action-icon bg-green-600 text-white" id="editCallMobile" title="Call"><i class="fas fa-phone"></i></a>
                <div class="action-icon bg-green-500 text-white" id="editWhatsappMobile" title="WhatsApp"><i class="fab fa-whatsapp"></i></div>
                <div class="action-icon bg-gray-600 text-white" id="editCopyMobile" title="Copy Number"><i class="fas fa-copy"></i></div>
              </div>
            </div>
            <div class="mb-4">
              <label for="editRoom" class="form-label">Room</label>
              <select class="form-select" id="editRoom" required>
                <option value="">Select Room</option>
                <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
                <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
                <option value="A Frame Cottage">A Frame Cottage</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="editCheckin" class="form-label">Check-in Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckin" required>
            </div>
            <div class="mb-4">
              <label for="editCheckout" class="form-label">Check-out Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckout" required>
            </div>
            <div class="mb-4">
              <label class="form-label">Advance Payment</label>
              <div class="flex gap-2">
                <input type="number" class="form-control flex-2" id="editAdvance" placeholder="Amount (₹)">
                <select class="form-select flex-1 min-w-[120px]" id="editAdvanceMode">
                  <option value="">Payment Mode</option>
                  <option value="UPI">UPI</option>
                  <option value="Cash">Cash</option>
                  <option value="Card">Card</option>
                  <option value="NetBanking">Net Banking</option>
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label for="editBalance" class="form-label">Balance Amount (₹)</label>
              <input type="number" class="form-control" id="editBalance">
            </div>
            <div class="mb-4">
              <label for="editComments" class="form-label">Notes</label>
              <textarea class="form-control" id="editComments" rows="2"></textarea>
            </div>
            <input type="hidden" id="editGuestId">
          </form>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveGuestChanges">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Confirmation Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Confirm Checkout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="checkoutForm">
            <div class="mb-4">
              <label class="form-label">Balance Due (₹)</label>
              <input type="number" class="form-control" id="checkoutBalance" readonly>
            </div>
            <div class="mb-4">
              <label for="checkoutPaymentType" class="form-label">Payment Mode</label>
              <select class="form-select" id="checkoutPaymentType" required>
                <option value="">Select Payment Mode</option>
                <option value="UPI">UPI</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="NetBanking">Net Banking</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="checkoutComments" class="form-label">Comments</label>
              <textarea class="form-control" id="checkoutComments" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmCheckout">Complete Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Food Orders Modal -->
  <div class="modal fade" id="foodOrdersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Food & Amenities Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="foodOrdersModalBody">
          Loading...
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Room Occupancy Calendar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <label for="calendarRoomFilter" class="form-label">Filter by Room</label>
            <select class="form-select" id="calendarRoomFilter">
              <option value="">All Rooms</option>
              <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
              <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
              <option value="A Frame Cottage">A Frame Cottage</option>
            </select>
          </div>
          <div id="occupancyCalendar" class="mb-4"></div>
          <div class="flex justify-between">
            <button class="btn btn-primary" id="prevMonth"><i class="fas fa-chevron-left"></i> Previous</button>
            <button class="btn btn-primary" id="nextMonth">Next <i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Success Modal -->
  <div class="modal fade" id="registrationSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold">Guest Registered Successfully</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="registration-success-details" id="registrationSuccessDetails"></div>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="guestLinkInput" readonly>
            <button class="btn btn-outline-secondary" id="copyGuestLinkModal" title="Copy Link"><i class="fas fa-copy"></i></button>
          </div>
          <div class="flex justify-center gap-2">
            <button class="btn btn-primary" id="sendEmailFromModal"><i class="fas fa-envelope"></i> Email</button>
            <button class="btn btn-success" id="sendWhatsappFromModal"><i class="fab fa-whatsapp"></i> WhatsApp</button>
          </div>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Deletion Preview Modal -->
  <div class="modal fade" id="deletionPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold danger-text"><i class="fas fa-triangle-exclamation"></i> Delete Records Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-sm text-gray-300">The following records will be permanently deleted from Airtable. Please review carefully.</p>
          <div id="deletionPreviewBody">
            <!-- dynamically populated -->
          </div>
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeletionBtn"><i class="fas fa-trash"></i> Confirm Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Breakdown Modal -->
  <div class="modal fade" id="revenueBreakdownModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-b border-gray-600">
          <h5 class="modal-title text-lg font-semibold" id="revenueBreakdownTitle">Revenue Breakdown</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="revenueBreakdownBody">
          Loading...
        </div>
        <div class="modal-footer border-t border-gray-600">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // WARNING: Move this token server-side in production.
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: { guests: 'Guests', bills: 'Bills', orders: 'Orders' }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"],
      paymentModes: ["UPI", "Cash", "Card", "NetBanking"]
    };

    const utils = {
      generateGuestId: () => 'GST' + Array(5).fill().map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      formatDate: date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
      formatDateTime: date => new Date(date).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true }),
      today: () => new Date().toISOString().split('T')[0],
      nextWeek: () => new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      datesOverlap: (start1, end1, start2, end2) => {
        // Exclusive of checkout: [start, end)
        const s1 = new Date(start1), e1 = new Date(end1);
        const s2 = new Date(start2), e2 = new Date(end2);
        return s1 < e2 && s2 < e1;
      },
      isCurrentStay: (checkin, checkout, refDateStr) => {
        const ref = new Date(refDateStr);
        const cin = new Date(checkin);
        const cout = new Date(checkout);
        return cin <= ref && ref < cout; // current date in [checkin, checkout)
      },
      calculateNights: (checkin, checkout) => Math.round(Math.abs((new Date(checkout) - new Date(checkin)) / (24 * 60 * 60 * 1000))),
      fetchAirtable: async (endpoint, options = {}) => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
        try {
          const response = await fetch(encodeURI(url), {
            headers: { 'Authorization': `Bearer ${config.airtable.token}`, 'Content-Type': 'application/json' },
            ...options
          });
          if (!response.ok) {
            let msg = 'API request failed';
            try { const j = await response.json(); msg = j.error?.message || msg; } catch (_) {}
            throw new Error(msg);
          }
          return response.json();
        } catch (error) {
          console.error('Airtable API error:', error);
          throw error;
        }
      },
      showToast: (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type === 'success' ? 'green-500' : type === 'warning' ? 'yellow-500' : 'red-500'} border-0`;
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.querySelector('.toast-container').appendChild(toast);
        new bootstrap.Toast(toast).show();
        setTimeout(() => toast.remove(), 5000);
      },
      toggleSpinner: (id, show) => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !show); },
      updateElement: (id, content) => { const el = document.getElementById(id); if (el) el.innerHTML = content; },
      uniqBy: (arr, keyFn) => {
        const map = new Map();
        for (const item of arr) map.set(keyFn(item), item);
        return Array.from(map.values());
      }
    };

    const app = {
      cachedGuests: null,
      cachedOrders: null,
      cachedBills: null,
      calendarInstance: null,
      selection: { current: new Set(), past: new Set() },
      deletionCache: null,
      selectedGuestId: null,
      selectedPastGuestId: null,

      init() {
        this.initClock();
        this.initEventListeners();
        this.initCalendar();
        this.loadDashboard();
        this.loadGuests('current');
        this.loadGuests('past');
      },

      initClock() {
        const updateTime = () => {
          const now = new Date();
          document.getElementById('currentTime').textContent = now.toLocaleString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
          });
        };
        updateTime();
        setInterval(updateTime, 1000);
      },

      initEventListeners() {
        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          document.getElementById('themeToggle').className = newTheme === 'dark' ? 'fas fa-sun theme-toggle' : 'fas fa-moon theme-toggle';
          localStorage.setItem('theme', newTheme);
        });

        // Apply saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').className = savedTheme === 'dark' ? 'fas fa-sun theme-toggle' : 'fas fa-moon theme-toggle';

        // Form submissions
        document.getElementById('guestForm').addEventListener('submit', (e) => this.registerGuest(e));
        document.getElementById('saveGuestChanges').addEventListener('click', () => this.saveGuestChanges());
        document.getElementById('confirmCheckout').addEventListener('click', () => this.completeCheckout());
        document.getElementById('generateBill').addEventListener('click', () => this.generateBill(this.selectedGuestId));
        document.getElementById('generatePastBill').addEventListener('click', () => this.generateBill(this.selectedPastGuestId, 'pastBillOutput', 'pastBillSpinner'));
        document.getElementById('checkoutGuest').addEventListener('click', () => this.showCheckoutModal(this.selectedGuestId));

        // Select all checkboxes
        document.getElementById('selectAllCurrent').addEventListener('change', (e) => this.toggleSelectAll('current', e.target.checked));
        document.getElementById('selectAllPast').addEventListener('change', (e) => this.toggleSelectAll('past', e.target.checked));

        // Delete selected
        document.getElementById('deleteSelectedCurrent').addEventListener('click', () => this.showDeletionPreview('current'));
        document.getElementById('deleteSelectedPast').addEventListener('click', () => this.showDeletionPreview('past'));
        document.getElementById('confirmDeletionBtn').addEventListener('click', () => this.confirmDeletion());

        // Tab change events
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
          tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#active-guests') {
              this.loadGuests('current');
            } else if (target === '#past-guests') {
              this.loadGuests('past');
            }
          });
        });
      },

      initCalendar() {
        flatpickr("#dateRange", { mode: "range", minDate: "today", dateFormat: "Y-m-d", onChange: (selectedDates) => { 
          if (selectedDates.length === 2) this.checkRoomAvailability(); 
        }});
        flatpickr("#editCheckin", { minDate: "today", dateFormat: "Y-m-d" });
        flatpickr("#editCheckout", { minDate: "today", dateFormat: "Y-m-d" });
      },

      async loadDashboard() {
        try {
          const today = utils.today();
          const nextWeek = utils.nextWeek();

          // Fetch all guests, orders once
          this.cachedGuests = await utils.fetchAirtable(`${config.airtable.tables.guests}?sort[0][field]=checkin`);
          this.cachedOrders = await utils.fetchAirtable(`${config.airtable.tables.orders}?sort[0][field]=OrderDate&sort[0][direction]=desc`);

          const allGuests = this.cachedGuests.records || [];

          // Dashboard Current Guests by date window
          const currentGuests = allGuests.filter(r => utils.isCurrentStay(r.fields.checkin, r.fields.checkout, today));
          utils.updateElement('currentGuestsCount', `<strong>${currentGuests.length}</strong> guests`);
          utils.updateElement('currentGuestsList', currentGuests.length ? currentGuests.map(r => `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
              <div class="flex justify-between">
                <span>${r.fields.name || 'Unnamed Guest'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${r.fields.guestID}');utils.showToast('Guest ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span></span>
                <span class="text-gray-400">${r.fields.room} (${utils.formatDate(r.fields.checkin)} - ${utils.formatDate(r.fields.checkout)})</span>
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 p-2">No current guests</div>');

          // Upcoming Bookings: checkin in (today, nextWeek]
          const upcomingGuests = allGuests.filter(r => {
            const cin = new Date(r.fields.checkin);
            return cin > new Date(today) && cin <= new Date(nextWeek);
          });
          utils.updateElement('upcomingBookings', upcomingGuests.length ? upcomingGuests.map(r => `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'upcoming')">
              <div class="flex justify-between">
                <span>${r.fields.name || 'Unnamed Guest'}</span>
                <span class="text-gray-400">${r.fields.room} (Check-in: ${utils.formatDate(r.fields.checkin)})</span>
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 p-2">No upcoming bookings</div>');

          // Room Occupancy card
          const occupiedRooms = new Set(currentGuests.map(r => r.fields.room));
          utils.updateElement('roomOccupancy', config.rooms.map(room => `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" onclick="app.showCalendarModal('${room}')">
              <div class="flex justify-between">
                <span>${room}</span>
                <span class="text-${occupiedRooms.has(room) ? 'red' : 'green'}-500">${occupiedRooms.has(room) ? 'Occupied' : 'Available'}</span>
              </div>
            </div>
          `).join(''));

          // Revenue Snapshot
          const advanceTotal = allGuests.reduce((sum, r) => sum + (parseFloat(r.fields.advanceAmount) || 0), 0);
          const balanceTotal = allGuests.reduce((sum, r) => sum + (parseFloat(r.fields.balanceAmount) || 0), 0);
          const foodTotal = (this.cachedOrders.records || []).reduce((sum, r) => sum + (parseFloat(r.fields.TotalAmount) || 0), 0);
          utils.updateElement('revenueSummary', `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" onclick="app.showRevenueBreakdown('advance')"><span>Advance Payments</span><span>₹${advanceTotal.toFixed(2)}</span></div>
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" onclick="app.showRevenueBreakdown('balance')"><span>Balance Payments</span><span>₹${balanceTotal.toFixed(2)}</span></div>
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" onclick="app.showRevenueBreakdown('food')"><span>Food Orders</span><span>₹${foodTotal.toFixed(2)}</span></div>
            <div class="p-2"><span class="font-semibold">Total Revenue</span><span class="font-semibold">₹${(advanceTotal + balanceTotal + foodTotal).toFixed(2)}</span></div>
          `);

          // Pending Balances: only active/current stays with >0 balance
          const pendingGuests = allGuests.filter(r => (parseFloat(r.fields.balanceAmount) || 0) > 0 && r.fields.status === 'Active');
          utils.updateElement('pendingBalances', pendingGuests.length ? pendingGuests.map(r => `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
              <div class="flex justify-between">
                <span>${r.fields.name || 'Unnamed Guest'}</span>
                <span class="text-gray-400">₹${(parseFloat(r.fields.balanceAmount) || 0).toFixed(2)}</span>
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 p-2">No pending balances</div>');

          // Ongoing Food Orders
          utils.updateElement('recentOrders', (this.cachedOrders.records || []).length ? this.cachedOrders.records.map(r => {
            const guest = allGuests.find(g => g.fields.guestID === r.fields.Guest);
            const items = [];
            try { (r.fields.Items) && items.push(...JSON.parse(r.fields.Items || '[]')); } catch(_) {}
            const totalAmount = r.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            return `
              <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${guest?.id || ''}" onclick="app.selectGuestFromDashboard('${guest?.id || ''}', 'order')">
                <div class="flex justify-between">
                  <span>${guest?.fields?.name || 'Unknown Guest'} (#${r.fields.OrderID || r.id}) <span class="copy-icon" onclick="navigator.clipboard.writeText('${r.fields.OrderID || r.id}');utils.showToast('Order ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span></span>
                  <span class="text-gray-400">₹${(+totalAmount).toFixed(2)} (${utils.formatDate(r.fields.OrderDate)})</span>
                </div>
              </div>
            `;
          }).join('') : '<div class="text-gray-400 p-2">No ongoing orders</div>');

          // Check-Outs Today (checkout == today)
          const checkouts = allGuests.filter(r => r.fields.checkout === today);
          utils.updateElement('checkoutsToday', checkouts.length ? checkouts.map(r => `
            <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
              <div class="flex justify-between">
                <span>${r.fields.name || 'Unnamed Guest'}</span>
                <span class="text-gray-400">${r.fields.room}</span>
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 p-2">No check-outs today</div>');

        } catch (error) {
          utils.showToast('Error loading dashboard: ' + error.message, 'danger');
          console.error('Dashboard error:', error);
          ['currentGuestsList', 'upcomingBookings', 'roomOccupancy', 'revenueSummary', 'pendingBalances', 'recentOrders', 'checkoutsToday'].forEach(id =>
            utils.updateElement(id, '<div class="text-gray-400 p-2">Failed to load data</div>')
          );
        }
      },

      async selectGuestFromDashboard(guestId, source) {
        if (!guestId) { utils.showToast('Guest not found', 'warning'); return; }
        await this.loadGuests('current');
        const guestItem = document.querySelector(`#guestList [data-guest-id="${guestId}"]`);
        if (guestItem) {
          document.querySelector('#active-tab').click();
          guestItem.click();
        } else {
          await this.loadGuests('past');
          const pastGuestItem = document.querySelector(`#pastGuestList [data-guest-id="${guestId}"]`);
          if (pastGuestItem) {
            document.querySelector('#past-tab').click();
            pastGuestItem.click();
          } else if (source === 'order') {
            this.showFoodOrdersModal(guestId);
          }
        }
      },

      async showCalendarModal(selectedRoom = '') {
        const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
        document.getElementById('calendarRoomFilter').value = selectedRoom;
        this.initOccupancyCalendar();
        this.updateOccupancyCalendar(selectedRoom);
        modal.show();
      },

      initOccupancyCalendar() {
        if (this.calendarInstance) this.calendarInstance.destroy();
        this.calendarInstance = flatpickr('#occupancyCalendar', {
          inline: true,
          dateFormat: 'Y-m-d',
          onDayCreate: (dObj, dStr, fp, dayElem) => {
            const date = dayElem.dateObj.toISOString().split('T')[0];
            const bookings = (this.cachedGuests?.records || []).filter(r => {
              const cin = new Date(r.fields.checkin);
              const cout = new Date(r.fields.checkout);
              const cur = new Date(date);
              return cin <= cur && cur < cout; // exclusive of checkout
            });
            if (bookings.length) {
              const roomFilter = document.getElementById('calendarRoomFilter').value;
              const filtered = roomFilter ? bookings.filter(b => b.fields.room === roomFilter) : bookings;
              if (filtered.length) {
                dayElem.classList.add('booked');
                dayElem.title = filtered.map(b => `${b.fields.room} (${b.fields.name || 'Unnamed Guest'})`).join('\n');
              }
            }
          }
        });
        document.getElementById('prevMonth').onclick = () => this.calendarInstance.changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => this.calendarInstance.changeMonth(1);
        document.getElementById('calendarRoomFilter').onchange = () => this.updateOccupancyCalendar(document.getElementById('calendarRoomFilter').value);
      },
      
      updateOccupancyCalendar(roomFilter) {
        if (this.calendarInstance) this.calendarInstance.redraw();
      },

      async showRevenueBreakdown(type) {
        const modal = new bootstrap.Modal(document.getElementById('revenueBreakdownModal'));
        const title = document.getElementById('revenueBreakdownTitle');
        const body = document.getElementById('revenueBreakdownBody');
        title.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Breakdown`;
        body.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
          if (type === 'advance') {
            const guests = (this.cachedGuests.records || []).filter(r => (parseFloat(r.fields.advanceAmount) || 0) > 0);
            body.innerHTML = guests.length ? guests.map(r => `
              <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
                <div class="flex justify-between">
                  <span>${r.fields.name || 'Unnamed Guest'} (${r.fields.room})</span>
                  <span class="text-gray-400">₹${(parseFloat(r.fields.advanceAmount) || 0).toFixed(2)} (${r.fields.advanceMode || 'N/A'})</span>
                </div>
              </div>
            `).join('') : '<div class="text-gray-400 p-2">No advance payments</div>';
          } else if (type === 'balance') {
            const guests = (this.cachedGuests.records || []).filter(r => (parseFloat(r.fields.balanceAmount) || 0) > 0);
            body.innerHTML = guests.length ? guests.map(r => `
              <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${r.id}" onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
                <div class="flex justify-between">
                  <span>${r.fields.name || 'Unnamed Guest'} (${r.fields.room})</span>
                  <span class="text-gray-400">₹${(parseFloat(r.fields.balanceAmount) || 0).toFixed(2)}</span>
                </div>
              </div>
            `).join('') : '<div class="text-gray-400 p-2">No balance payments</div>';
          } else if (type === 'food') {
            const orders = this.cachedOrders.records || [];
            body.innerHTML = orders.length ? orders.map(r => {
              const guest = (this.cachedGuests.records || []).find(g => g.fields.guestID === r.fields.Guest);
              return `
                <div class="p-2 border-b border-gray-600 cursor-pointer hover:bg-blue-500/10" data-guest-id="${guest?.id || ''}" onclick="app.selectGuestFromDashboard('${guest?.id || ''}', 'order')">
                  <div class="flex justify-between">
                    <span>${guest?.fields?.name || 'Unknown Guest'} (#${r.fields.OrderID || r.id})</span>
                    <span class="text-gray-400">₹${(r.fields.TotalAmount || 0).toFixed(2)} (${utils.formatDate(r.fields.OrderDate)})</span>
                  </div>
                </div>
              `;
            }).join('') : '<div class="text-gray-400 p-2">No food orders</div>';
          }
          modal.show();
        } catch (error) {
          body.innerHTML = '<div class="text-red-400 p-2">Failed to load data</div>';
          utils.showToast('Error loading breakdown: ' + error.message, 'danger');
        }
      },

      async checkRoomAvailability() {
        const raw = document.getElementById('dateRange').value;
        const [checkin, checkout] = raw.includes(' to ') ? raw.split(' to ') : [null, null];
        const roomSelect = document.getElementById('room');
        const statusDiv = document.getElementById('availabilityStatus');
        statusDiv.innerHTML = '<span class="text-gray-400">Checking availability...</span>';

        if (!checkin || !checkout) {
          statusDiv.innerHTML = '<span class="text-red-500">Please select both check-in and check-out</span>';
          return;
        }

        try {
          const data = await utils.fetchAirtable(`${config.airtable.tables.guests}`);
          const bookedRooms = new Set((data.records || []).filter(r => utils.datesOverlap(r.fields.checkin, r.fields.checkout, checkin, checkout)).map(r => r.fields.room));
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          let availableCount = 0;
          config.rooms.forEach(room => {
            if (!bookedRooms.has(room)) {
              roomSelect.innerHTML += `<option value="${room}">${room}</option>`;
              availableCount++;
            }
          });
          statusDiv.innerHTML = availableCount ? `<span class="text-green-500">${availableCount} room(s) available</span>` : '<span class="text-red-500">No rooms available</span>';
          roomSelect.disabled = !availableCount;
        } catch (error) {
          statusDiv.innerHTML = '<span class="text-red-500">Error checking availability</span>';
        }
      },

      async loadGuests(type) {
        const listId = type === 'current' ? 'guestList' : 'pastGuestList';
        const infoId = type === 'current' ? 'selectedGuestInfo' : 'selectedPastGuestInfo';
        const list = document.getElementById(listId);
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
          const filter = type === 'current'
            ? `{status}='Active'`
            : `{status}='Checked Out'`;
          const data = await utils.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula=${encodeURIComponent(filter)}&sort[0][field]=${type === 'current' ? 'checkin' : 'checkout'}&sort[0][direction]=${type === 'current' ? 'asc' : 'desc'}`);

          const records = data.records || [];
          if (!records.length) {
            list.innerHTML = `<div class="text-center py-3 text-gray-400">No ${type} guests</div>`;
            document.getElementById(infoId).classList.add('hidden');
            return;
          }

          // Build list with checkboxes
          list.innerHTML = records.map(r => `
            <div class="guest-list-item" data-guest-id="${r.id}" data-guest='${JSON.stringify(r.fields).replaceAll("'", "&apos;")}'>
              <input type="checkbox" class="select-row" data-id="${r.id}" onclick="event.stopPropagation(); app.toggleSelection('${type}','${r.id}', this.checked)">
              <div class="flex-1">
                <div class="flex justify-between">
                  <span>${r.fields.name || 'Unnamed Guest'} (${r.fields.guestID || ''})
                    <span class="copy-icon" onclick="navigator.clipboard.writeText('${r.fields.guestID || ''}');utils.showToast('Guest ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span>
                  </span>
                  <span class="text-gray-400">${r.fields.room} (${utils.formatDate(type === 'current' ? r.fields.checkin : r.fields.checkout)})</span>
                </div>
              </div>
            </div>
          `).join('');

          // Restore selection state
          (list.querySelectorAll('.select-row') || []).forEach(cb => {
            cb.checked = this.selection[type].has(cb.dataset.id);
          });

          // Click handling for item selection and detail load
          list.addEventListener('click', async e => {
            const item = e.target.closest('.guest-list-item');
            if (!item) return;
            // Ignore clicks on checkbox
            if (e.target.classList.contains('select-row')) return;

            list.querySelectorAll('.guest-list-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            const guestId = item.dataset.guestId;
            window[listId === 'guestList' ? 'selectedGuestId' : 'selectedPastGuestId'] = guestId;
            const guestData = JSON.parse(item.dataset.guest.replaceAll("&apos;", "'"));
            document.getElementById(infoId).classList.remove('hidden');
            if (type === 'current') await this.loadGuestDetailsForDisplay(guestId, guestData);
            else await this.loadPastGuestDetails(guestId);
          }, { once: true }); // attach once per load to avoid duplicates

          // Update selected count label
          this.updateSelectedCount(type);
        } catch (error) {
          list.innerHTML = `<div class="text-center py-3 text-red-500">Failed to load ${type} guests</div>`;
          utils.showToast(`Error loading ${type} guests: ${error.message}`, 'danger');
        }
      },

      toggleSelection(type, id, checked) {
        if (checked) this.selection[type].add(id);
        else this.selection[type].delete(id);
        this.updateSelectedCount(type);
      },

      toggleSelectAll(type, checked) {
        const listId = type === 'current' ? 'guestList' : 'pastGuestList';
        const checkboxes = document.querySelectorAll(`#${listId} .select-row`);
        checkboxes.forEach(cb => {
          cb.checked = checked;
          this.toggleSelection(type, cb.dataset.id, checked);
        });
      },

      updateSelectedCount(type) {
        const el = document.getElementById(type === 'current' ? 'currentSelectedCount' : 'pastSelectedCount');
        el.textContent = `${this.selection[type].size} selected`;
        // Update "select all" checkbox state
        const listId = type === 'current' ? 'guestList' : 'pastGuestList';
        const allBoxes = document.querySelectorAll(`#${listId} .select-row`);
        const allChecked = allBoxes.length && Array.from(allBoxes).every(cb => cb.checked);
        document.getElementById(type === 'current' ? 'selectAllCurrent' : 'selectAllPast').checked = !!allChecked;
      },

      async loadGuestDetails(guestId) {
        const response = await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`);
        return response.fields;
      },

      async loadGuestDetailsForDisplay(guestId, guestData) {
        const guest = guestData || await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);
        const totalDue = (parseFloat(guest.balanceAmount) || 0) + foodTotal;

        utils.updateElement('guestDetailsContent', `
          <div class="mb-4">
            <h6 class="text-lg font-semibold mb-2">Guest Information</h6>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div><span class="text-gray-400">Name</span><br>${guest.name || 'Unnamed Guest'}</div>
              <div><span class="text-gray-400">Mobile</span><br>${guest.mobile || 'Not provided'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${guest.mobile || ''}');utils.showToast('Mobile copied!', 'success');"><i class="fas fa-copy"></i></span></div>
              <div><span class="text-gray-400">Room</span><br>${guest.room}</div>
              <div><span class="text-gray-400">Nights</span><br>${nights}</div>
              <div><span class="text-gray-400">Check-in</span><br>${utils.formatDate(guest.checkin)}</div>
              <div><span class="text-gray-400">Check-out</span><br>${utils.formatDate(guest.checkout)}</div>
            </div>
            ${guest.Comments ? `<div class="mt-4"><span class="text-gray-400">Notes</span><br><div class="p-2 bg-gray-700 rounded">${guest.Comments}</div></div>` : ''}
            <div class="mt-4 p-2 bg-gray-700 rounded cursor-pointer" id="viewFoodOrders"><h6 class="text-base font-semibold"><span>Food & Amenities</span><span class="ml-2 bg-blue-600 text-white px-2 py-1 rounded">₹${foodTotal.toFixed(2)}</span></h6></div>
          </div>
          <div>
            <h6 class="text-lg font-semibold mb-2">Payment Summary</h6>
            <div class="p-2 bg-gray-700 rounded">
              <div class="flex justify-between mb-2"><span>Advance Paid</span><span>₹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</span></div>
              <div class="flex justify-between mb-2"><span>Food Orders</span><span>₹${foodTotal.toFixed(2)}</span></div>
              <div class="flex justify-between mb-2"><span>Balance Due</span><span>₹${guest.balanceAmount || 0}</span></div>
              <div class="flex justify-between font-semibold"><span>Total Due</span><span>₹${totalDue.toFixed(2)}</span></div>
            </div>
          </div>
        `);

        const homeLink = guest.homeLink;
        document.getElementById('copyGuestLink').onclick = () => { navigator.clipboard.writeText(homeLink || ''); utils.showToast('Link copied!', 'success'); };
        document.getElementById('sendEmailToGuest').onclick = () => window.open(`mailto:?subject=OCB Stays Information&body=${encodeURIComponent(this.generateEmailBody(guest, homeLink || ''))}`);
        document.getElementById('sendWhatsappToGuest').onclick = () => window.open(`https://wa.me/${guest.mobile}?text=${encodeURIComponent(this.generateWhatsappMessage(guest, homeLink || ''))}`);
        document.getElementById('callGuest').href = `tel:${guest.mobile || ''}`;
        document.getElementById('viewFoodOrders').onclick = () => this.showFoodOrdersModal(guestId);
        document.getElementById('editGuestBtn').onclick = () => this.showEditGuestModal(guestId);
        document.getElementById('checkoutGuest').onclick = () => this.showCheckoutModal(guestId);
        document.getElementById('placeOrder').onclick = () => window.open(`${config.urls.guestMenu}?guestID=${encodeURIComponent(guest.guestID)}&room=${encodeURIComponent(guest.room)}`);
      },

      async loadPastGuestDetails(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);
        utils.updateElement('pastGuestDetailsContent', `
          <div class="mb-4">
            <h6 class="text-lg font-semibold mb-2">Guest Information</h6>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div><span class="text-gray-400">Name</span><br>${guest.name || 'Unnamed Guest'}</div>
              <div><span class="text-gray-400">Mobile</span><br>${guest.mobile || 'Not provided'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${guest.mobile || ''}');utils.showToast('Mobile copied!', 'success');"><i class="fas fa-copy"></i></span></div>
              <div><span class="text-gray-400">Room</span><br>${guest.room}</div>
              <div><span class="text-gray-400">Nights</span><br>${nights}</div>
              <div><span class="text-gray-400">Check-in</span><br>${utils.formatDate(guest.checkin)}</div>
              <div><span class="text-gray-400">Check-out</span><br>${utils.formatDate(guest.checkout)}</div>
            </div>
            ${guest.Comments ? `<div class="mt-4"><span class="text-gray-400">Notes</span><br><div class="p-2 bg-gray-700 rounded">${guest.Comments}</div></div>` : ''}
            <div class="mt-4 p-2 bg-gray-700 rounded cursor-pointer" id="viewPastFoodOrders"><h6 class="text-base font-semibold"><span>Food & Amenities</span><span class="ml-2 bg-blue-600 text-white px-2 py-1 rounded">₹${foodTotal.toFixed(2)}</span></h6></div>
          </div>
          <div>
            <h6 class="text-lg font-semibold mb-2">Payment Summary</h6>
            <div class="p-2 bg-gray-700 rounded">
              <div class="flex justify-between mb-2"><span>Advance Paid</span><span>₹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</span></div>
              <div class="flex justify-between mb-2"><span>Food Orders</span><span>₹${foodTotal.toFixed(2)}</span></div>
              <div class="flex justify-between mb-2"><span>Balance Paid</span><span>₹${guest.balanceAmount || 0}${guest.PaymentType ? ` (${guest.PaymentType})` : ''}</span></div>
              <div class="flex justify-between font-semibold"><span>Total Paid</span><span>₹${((parseFloat(guest.advanceAmount) || 0) + (parseFloat(guest.balanceAmount) || 0) + foodTotal).toFixed(2)}</span></div>
            </div>
          </div>
        `);
        document.getElementById('viewPastFoodOrders').onclick = () => this.showFoodOrdersModal(guestId);
      },

      async calculateFoodTotal(guestID) {
        const orders = await this.getGuestOrders(guestID);
        return orders.reduce((total, order) => total + (order.fields.TotalAmount || 0), 0);
      },

      async getGuestOrders(guestID) {
        try {
          const res = await utils.fetchAirtable(`${config.airtable.tables.orders}?filterByFormula=${encodeURIComponent(`AND({Guest}='${guestID}', {Status} != 'Cancelled')`)}`);
          return res.records || [];
        } catch (error) {
          utils.showToast('Error fetching orders: ' + error.message, 'danger');
          return [];
        }
      },

      async showFoodOrdersModal(guestId) {
        const modal = new bootstrap.Modal(document.getElementById('foodOrdersModal'));
        const modalBody = document.getElementById('foodOrdersModalBody');
        modalBody.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-blue-500" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        modal.show();

        try {
          const guest = await this.loadGuestDetails(guestId);
          const orders = await this.getGuestOrders(guest.guestID);
          modalBody.innerHTML = orders.length ? orders.map(order => {
            const orderDate = utils.formatDateTime(order.fields.OrderDate || new Date());
            let items = [];
            try { items = JSON.parse(order.fields.Items || '[]'); } catch(_) {}
            const totalAmount = order.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            return `
              <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <div class="flex justify-between mb-2">
                  <div>Order #${order.fields.OrderID || order.id} <span class="copy-icon" onclick="navigator.clipboard.writeText('${order.fields.OrderID || order.id}');utils.showToast('Order ID copied!', 'success');"><i class="fas fa-copy"></i></span></div>
                  <div>${orderDate}</div>
                </div>
                <div class="flex justify-between mb-2">
                  <div>Status: <span class="bg-${order.fields.Status === 'Delivered' ? 'green' : 'yellow'}-500 text-white px-2 py-1 rounded">${order.fields.Status}</span></div>
                  <div>Total: ₹${(+totalAmount).toFixed(2)}</div>
                </div>
                <div class="mt-2">
                  <h6 class="text-sm font-semibold">Items</h6>
                  ${items.map(item => `
                    <div class="flex justify-between py-1">
                      <div>${item.quantity} × ${item.name || 'Item'}${item.specialInstructions ? `<div class="text-gray-400 text-sm">${item.specialInstructions}</div>` : ''}</div>
                      <div>₹${(((item.price || 0) * (item.quantity || 1))).toFixed(2)}</div>
                    </div>
                  `).join('')}
                </div>
                ${order.fields.SpecialInstructions ? `<div class="mt-2"><strong>Special Instructions:</strong> ${order.fields.SpecialInstructions}</div>` : ''}
              </div>
            `;
          }).join('') : '<div class="p-4 bg-blue-500/10 text-blue-400 rounded-lg">No food orders found</div>';
        } catch (error) {
          modalBody.innerHTML = '<div class="p-4 bg-red-500/10 text-red-400 rounded-lg">Failed to load food orders</div>';
          utils.showToast('Error loading orders: ' + error.message, 'danger');
        }
      },

      async createFoodBill(guestId, guestDetails, orders) {
        let totalAmount = 0;
        const itemMap = new Map();
        (orders || []).forEach(order => {
          let items = [];
          try { items = JSON.parse(order.fields.Items || '[]'); } catch(_) {}
          const orderTotal = order.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
          totalAmount += (orderTotal || 0);
          items.forEach(item => {
            const key = `${item.name || 'Item'}-${item.price || 0}`;
            const existing = itemMap.get(key);
            const q = (item.quantity || 1);
            const p = (item.price || 0);
            if (existing) {
              existing.quantity += q;
              existing.amount = existing.price * existing.quantity;
            } else {
              itemMap.set(key, {
                item: item.name || 'Item',
                quantity: q,
                price: p,
                amount: p * q,
                date: order.fields.OrderDate
              });
            }
          });
        });

        const allOrderItems = Array.from(itemMap.values());
        const existingBills = await utils.fetchAirtable(`${config.airtable.tables.bills}?filterByFormula=${encodeURIComponent(`{guestID}='${guestDetails.guestID}'`)}`);
        let billId;
        if ((existingBills.records || []).length) {
          billId = existingBills.records[0].id;
          await utils.fetchAirtable(`${config.airtable.tables.bills}/${billId}`, {
            method: 'PATCH',
            body: JSON.stringify({ fields: { totalAmount, orderDetails: JSON.stringify(allOrderItems), updatedAt: new Date().toISOString() } })
          });
        } else {
          const created = await utils.fetchAirtable(config.airtable.tables.bills, {
            method: 'POST',
            body: JSON.stringify({ fields: { billID: `BIL-${Date.now().toString().slice(-6)}`, guestID: guestDetails.guestID, totalAmount, status: "Pending", orderDetails: JSON.stringify(allOrderItems) } })
          });
          billId = created.id;
        }
        return { guest: guestDetails, orders: allOrderItems, totalAmount, billId };
      },

      generateEmailBody(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays.

Your booking for ${guest.room} from ${utils.formatDate(guest.checkin)} is confirmed with advance payment of ₹${guest.advanceAmount || 0} (non-refundable), balance ₹${guest.balanceAmount || 0} due on arrival.

Check-in: ${utils.formatDate(guest.checkin)} 1pm
Check Out: ${utils.formatDate(guest.checkout)} 11am

Link: ${link}

Thanks,
Prateek & Ishika
OCB Stays`;
      },

      generateWhatsappMessage(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays.
Link: ${link}

Cheers,
Team OCB Stays`;
      },

      async showCheckoutModal(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        document.getElementById('checkoutBalance').value = ((parseFloat(guest.balanceAmount) || 0) + foodTotal).toFixed(2);
        document.getElementById('checkoutPaymentType').value = '';
        document.getElementById('checkoutComments').value = '';
        new bootstrap.Modal(document.getElementById('checkoutModal')).show();
      },

      async showEditGuestModal(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        document.getElementById('editName').value = guest.name || '';
        document.getElementById('editMobile').value = guest.mobile || '';
        document.getElementById('editRoom').value = guest.room || '';
        document.getElementById('editCheckin').value = guest.checkin || '';
        document.getElementById('editCheckout').value = guest.checkout || '';
        document.getElementById('editAdvance').value = guest.advanceAmount || '';
        document.getElementById('editAdvanceMode').value = guest.advanceMode || '';
        document.getElementById('editBalance').value = guest.balanceAmount || '';
        document.getElementById('editComments').value = guest.Comments || '';
        document.getElementById('editGuestId').value = guestId;
        document.getElementById('editCallMobile').href = `tel:${guest.mobile || ''}`;
        document.getElementById('editWhatsappMobile').onclick = () => window.open(`https://wa.me/${guest.mobile || ''}`);
        document.getElementById('editCopyMobile').onclick = () => { navigator.clipboard.writeText(guest.mobile || ''); utils.showToast('Mobile copied!', 'success'); };
        new bootstrap.Modal(document.getElementById('editGuestModal')).show();
      },

      async saveGuestChanges() {
        const guestId = document.getElementById('editGuestId').value;
        const btn = document.getElementById('saveGuestChanges');
        btn.disabled = true;

        try {
          const formData = {
            name: document.getElementById('editName').value,
            mobile: document.getElementById('editMobile').value,
            room: document.getElementById('editRoom').value,
            checkin: document.getElementById('editCheckin').value,
            checkout: document.getElementById('editCheckout').value,
            advanceAmount: parseFloat(document.getElementById('editAdvance').value) || 0,
            advanceMode: document.getElementById('editAdvanceMode').value || '',
            balanceAmount: parseFloat(document.getElementById('editBalance').value) || 0,
            Comments: document.getElementById('editComments').value || ''
          };
          if (!formData.name || !formData.mobile || !formData.room || !formData.checkin || !formData.checkout) {
            throw new Error('Please fill all required fields');
          }
          await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`, {
            method: 'PATCH',
            body: JSON.stringify({ fields: formData })
          });
          utils.showToast('Guest details updated successfully', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editGuestModal')).hide();
          await this.loadGuests('current');
          const guestItem = document.querySelector(`#guestList [data-guest-id="${guestId}"]`);
          if (guestItem) guestItem.click();
        } catch (error) {
          utils.showToast('Error updating guest: ' + error.message, 'danger');
        } finally {
          btn.disabled = false;
        }
      },

      async registerGuest(event) {
        event.preventDefault();
        const btn = document.getElementById('registerBtn');
        utils.toggleSpinner('registerSpinner', true);
        btn.disabled = true;

        try {
          const raw = document.getElementById('dateRange').value;
          const [checkin, checkout] = raw.includes(' to ') ? raw.split(' to ') : [null, null];

          const newGuestId = utils.generateGuestId();
          const guestData = {
            guestID: newGuestId,
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            room: document.getElementById('room').value,
            checkin,
            checkout,
            advanceAmount: parseFloat(document.getElementById('advanceAmount').value) || 0,
            advanceMode: document.getElementById('advanceMode').value || '',
            balanceAmount: parseFloat(document.getElementById('balanceAmount').value) || 0,
            Comments: document.getElementById('comments').value || '',
            status: 'Active',
            homeLink: `${config.urls.guestPortal}?guestID=${encodeURIComponent(newGuestId)}`
          };

          if (!guestData.name || !guestData.mobile || !guestData.room || !guestData.checkin || !guestData.checkout) {
            throw new Error('Please fill all required fields');
          }

          await utils.fetchAirtable(config.airtable.tables.guests, {
            method: 'POST',
            body: JSON.stringify({ fields: guestData })
          });

          document.getElementById('guestForm').reset();
          document.getElementById('room').innerHTML = '<option value="">Select Room</option>';
          document.getElementById('room').disabled = true;
          document.getElementById('availabilityStatus').innerHTML = '';
          bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();

          const successModal = new bootstrap.Modal(document.getElementById('registrationSuccessModal'));
          document.getElementById('registrationSuccessDetails').innerHTML = `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
              <div><strong>Name:</strong> ${guestData.name}</div>
              <div><strong>Mobile:</strong> ${guestData.mobile}</div>
              <div><strong>Room:</strong> ${guestData.room}</div>
              <div><strong>Check-in:</strong> ${utils.formatDate(guestData.checkin)}</div>
              <div><strong>Check-out:</strong> ${utils.formatDate(guestData.checkout)}</div>
              <div><strong>Advance:</strong> ₹${guestData.advanceAmount.toFixed(2)} (${guestData.advanceMode || 'N/A'})</div>
              <div><strong>Balance:</strong> ₹${guestData.balanceAmount.toFixed(2)}</div>
            </div>
          `;
          document.getElementById('guestLinkInput').value = guestData.homeLink;
          document.getElementById('copyGuestLinkModal').onclick = () => {
            navigator.clipboard.writeText(guestData.homeLink);
            utils.showToast('Link copied!', 'success');
          };
          document.getElementById('sendEmailFromModal').onclick = () => window.open(`mailto:?subject=OCB Stays Information&body=${encodeURIComponent(this.generateEmailBody(guestData, guestData.homeLink))}`);
          document.getElementById('sendWhatsappFromModal').onclick = () => window.open(`https://wa.me/${guestData.mobile}?text=${encodeURIComponent(this.generateWhatsappMessage(guestData, guestData.homeLink))}`);
          successModal.show();

          utils.showToast('Guest registered successfully', 'success');
          this.loadDashboard();
          await this.loadGuests('current');
        } catch (error) {
          utils.showToast('Error registering guest: ' + error.message, 'danger');
        } finally {
          utils.toggleSpinner('registerSpinner', false);
          btn.disabled = false;
        }
      },

      async generateBill(guestId, target = 'billOutput', spinnerId = 'billSpinner') {
        utils.toggleSpinner(spinnerId, true);
        try {
          const guest = await this.loadGuestDetails(guestId);
          const orders = await this.getGuestOrders(guest.guestID);
          const billData = await this.createFoodBill(guestId, guest, orders);
          const nights = utils.calculateNights(guest.checkin, guest.checkout);
          const billContent = `
            <div class="bg-gray-700 p-4 rounded-lg">
              <h5 class="text-lg font-semibold mb-4">Bill for ${guest.name || 'Unnamed Guest'}</h5>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div><strong>Guest ID:</strong> ${guest.guestID} <span class="copy-icon" onclick="navigator.clipboard.writeText('${guest.guestID}');utils.showToast('Guest ID copied!', 'success');"><i class="fas fa-copy"></i></span></div>
                <div><strong>Room:</strong> ${guest.room}</div>
                <div><strong>Check-in:</strong> ${utils.formatDate(guest.checkin)}</div>
                <div><strong>Check-out:</strong> ${utils.formatDate(guest.checkout)}</div>
                <div><strong>Nights:</strong> ${nights}</div>
                <div><strong>Advance Paid:</strong> ₹${(parseFloat(guest.advanceAmount) || 0).toFixed(2)} (${guest.advanceMode || 'N/A'})</div>
              </div>
              <h6 class="text-base font-semibold mb-2">Food & Amenities</h6>
              <div class="mb-4">
                ${billData.orders.length ? billData.orders.map(item => `
                  <div class="flex justify-between py-1">
                    <span>${item.quantity} × ${item.item}</span>
                    <span>₹${item.amount.toFixed(2)}</span>
                  </div>
                `).join('') : '<div class="text-gray-400">No orders</div>'}
              </div>
              <div class="flex justify-between font-semibold">
                <span>Total Due:</span>
                <span>₹${(billData.totalAmount + (parseFloat(guest.balanceAmount) || 0)).toFixed(2)}</span>
              </div>
            </div>
          `;
          utils.updateElement(target, billContent);
          utils.showToast('Bill generated successfully', 'success');
          return billData;
        } catch (error) {
          utils.showToast('Error generating bill: ' + error.message, 'danger');
          utils.updateElement(target, '<div class="text-red-400 p-4">Failed to generate bill</div>');
        } finally {
          utils.toggleSpinner(spinnerId, false);
        }
      },

      async completeCheckout() {
        const guestId = this.selectedGuestId;
        const btn = document.getElementById('confirmCheckout');
        btn.disabled = true;

        try {
          const checkoutData = {
            status: 'Checked Out',
            PaymentType: document.getElementById('checkoutPaymentType').value,
            Comments: document.getElementById('checkoutComments').value || ''
          };
          if (!checkoutData.PaymentType) throw new Error('Please select a payment mode');
          await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`, {
            method: 'PATCH',
            body: JSON.stringify({ fields: checkoutData })
          });
          bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
          utils.showToast('Checkout completed successfully', 'success');
          await this.loadDashboard();
          await this.loadGuests('current');
          document.getElementById('selectedGuestInfo').classList.add('hidden');
        } catch (error) {
          utils.showToast('Error during checkout: ' + error.message, 'danger');
        } finally {
          btn.disabled = false;
        }
      },

      // Deletion Flow
      async showDeletionPreview(type) {
        const ids = Array.from(this.selection[type]);
        if (!ids.length) { utils.showToast('No records selected', 'warning'); return; }

        // Load selected guests
        const guestRecords = [];
        for (const id of ids) {
          try {
            const rec = await utils.fetchAirtable(`${config.airtable.tables.guests}/${id}`);
            guestRecords.push({ id, fields: rec.fields });
          } catch (e) {
            // ignore missing
          }
        }

        // Collect related Orders and Bills by guestID
        const guestIDs = guestRecords.map(g => g.fields.guestID).filter(Boolean);
        const allOrders = [];
        const allBills = [];

        // Fetch related orders for each guestID
        for (const gid of guestIDs) {
          try {
            const o = await utils.fetchAirtable(`${config.airtable.tables.orders}?filterByFormula=${encodeURIComponent(`{Guest}='${gid}'`)}`);
            (o.records || []).forEach(r => allOrders.push(r));
          } catch (e) {}
          try {
            const b = await utils.fetchAirtable(`${config.airtable.tables.bills}?filterByFormula=${encodeURIComponent(`{guestID}='${gid}'`)}`);
            (b.records || []).forEach(r => allBills.push(r));
          } catch (e) {}
        }

        // Deduplicate
        const orders = utils.uniqBy(allOrders, r => r.id);
        const bills = utils.uniqBy(allBills, r => r.id);

        this.deletionCache = { type, guests: guestRecords, orders, bills };

        // Build preview UI
        const body = document.getElementById('deletionPreviewBody');
        const guestHtml = guestRecords.length ? `
          <div class="mb-4">
            <h6 class="mb-2">Guests (${guestRecords.length})</h6>
            <div class="table-responsive">
              <table class="table table-sm table-dark align-middle">
                <thead><tr><th>Name</th><th>GuestID</th><th>Room</th><th>Check-in</th><th>Check-out</th><th>Status</th></tr></thead>
                <tbody>
                  ${guestRecords.map(g => `
                    <tr>
                      <td>${g.fields.name || ''}</td>
                      <td>${g.fields.guestID || ''}</td>
                      <td>${g.fields.room || ''}</td>
                      <td>${utils.formatDate(g.fields.checkin)}</td>
                      <td>${utils.formatDate(g.fields.checkout)}</td>
                      <td>${g.fields.status || ''}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : '<div class="mb-4">No guest records found.</div>';

        const ordersHtml = orders.length ? `
          <div class="mb-4">
            <h6 class="mb-2">Orders (${orders.length})</h6>
            <div class="table-responsive">
              <table class="table table-sm table-dark align-middle">
                <thead><tr><th>Order ID</th><th>Guest</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                <tbody>
                  ${orders.map(o => `
                    <tr>
                      <td>${o.fields.OrderID || o.id}</td>
                      <td>${o.fields.Guest || ''}</td>
                      <td>${utils.formatDate(o.fields.OrderDate)}</td>
                      <td>₹${(o.fields.TotalAmount || 0).toFixed(2)}</td>
                      <td>${o.fields.Status || ''}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : '<div class="mb-4">No order records found.</div>';

        const billsHtml = bills.length ? `
          <div class="mb-4">
            <h6 class="mb-2">Bills (${bills.length})</h6>
            <div class="table-responsive">
              <table class="table table-sm table-dark align-middle">
                <thead><tr><th>Bill ID</th><th>GuestID</th><th>Amount</th><th>Status</th></tr></thead>
                <tbody>
                  ${bills.map(b => `
                    <tr>
                      <td>${b.fields.billID || b.id}</td>
                      <td>${b.fields.guestID || ''}</td>
                      <td>₹${(b.fields.totalAmount || 0).toFixed(2)}</td>
                      <td>${b.fields.status || ''}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : '<div class="mb-4">No bill records found.</div>';

        body.innerHTML = guestHtml + ordersHtml + billsHtml;
        new bootstrap.Modal(document.getElementById('deletionPreviewModal')).show();
      },

      async confirmDeletion() {
        if (!this.deletionCache) return;
        
        const { type, guests, orders, bills } = this.deletionCache;
        const btn = document.getElementById('confirmDeletionBtn');
        btn.disabled = true;
        
        try {
          // Delete bills first
          for (const bill of bills) {
            await utils.fetchAirtable(`${config.airtable.tables.bills}/${bill.id}`, {
              method: 'DELETE'
            });
          }
          
          // Delete orders
          for (const order of orders) {
            await utils.fetchAirtable(`${config.airtable.tables.orders}/${order.id}`, {
              method: 'DELETE'
            });
          }
          
          // Delete guests last
          for (const guest of guests) {
            await utils.fetchAirtable(`${config.airtable.tables.guests}/${guest.id}`, {
              method: 'DELETE'
            });
          }
          
          utils.showToast(`Successfully deleted ${guests.length} guest(s) and related records`, 'success');
          bootstrap.Modal.getInstance(document.getElementById('deletionPreviewModal')).hide();
          
          // Clear selection and reload data
          this.selection[type].clear();
          this.updateSelectedCount(type);
          
          if (type === 'current') {
            await this.loadGuests('current');
          } else {
            await this.loadGuests('past');
          }
          
          await this.loadDashboard();
          
        } catch (error) {
          utils.showToast('Error deleting records: ' + error.message, 'danger');
        } finally {
          btn.disabled = false;
        }
      }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>

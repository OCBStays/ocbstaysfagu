<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCB Haven - Host Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@5.10.1/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.10.1/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@5.10.1/main.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.10.1/main.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-200 { border-color: #4a5568; }
    .dark .bg-gray-50 { background-color: #4a5568; }
    .dark .bg-blue-600 { background-color: #63b3ed; }
    .modal-overlay { backdrop-filter: blur(5px); z-index: 1000; }
    .modal-content { animation: slide-up 0.3s ease-out; }
    .assistant { animation: pulse 2s infinite; }
    @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .logo { width: 120px; height: auto; animation: fade-in 1s ease-out; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .fallback { display: none; }
    .error .fallback { display: block; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>
  <div class="fallback text-center p-6 bg-red-100 dark:bg-red-900 rounded-lg hidden">
    <h3 class="text-lg font-semibold">Oops! Something Went Wrong</h3>
    <p>Please check your internet connection or try refreshing the page. Contact support if the issue persists.</p>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configuration
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: { guests: 'Guests', bills: 'Bills', orders: 'Orders' }
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"],
      paymentMethods: ["UPI", "Cash", "Card", "NetBanking"],
      currentDate: new Date('2025-07-10T16:39:00+05:30'),
      mockData: {
        guests: [
          { id: 'g1', fields: { name: 'John Doe', guestID: 'G001', room: 'Stargazing Deck (0)', checkin: '2025-07-09', checkout: '2025-07-11', status: 'Active', advance: 5000, advanceMode: 'UPI' } },
          { id: 'g2', fields: { name: 'Jane Smith', guestID: 'G002', room: 'A Frame Cottage', checkin: '2025-07-08', checkout: '2025-07-10', status: 'Checked Out', advance: 3000, advanceMode: 'Cash' } }
        ],
        bills: [{ id: 'b1', fields: { billID: 'B001', guestID: ['g1'], totalAmount: 7500, status: 'Pending' } }],
        orders: []
      }
    };

    // Utility Functions
    const utils = {
      formatDate: dateString => new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
      fetchAirtable: async (endpoint, options = {}) => {
        try {
          const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
          const response = await axios({ url, headers: { 'Authorization': `Bearer ${config.airtable.token}`, 'Content-Type': 'application/json' }, ...options });
          return response.data;
        } catch (error) {
          console.error('Airtable fetch error (CORS likely):', error);
          return null; // Return null to trigger mock data
        }
      },
      showToast: (message, type = 'info') => {
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 p-3 rounded shadow-lg text-white ${type === 'info' ? 'bg-blue-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'} animate-slide-up`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      },
      calculateNights: (checkin, checkout) => Math.round(Math.abs((new Date(checkin) - new Date(checkout)) / (24 * 60 * 60 * 1000))),
      exportCSV: (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.csv`;
        link.click();
      },
      exportPDF: async (data, filename) => {
        const element = document.createElement('div');
        element.innerHTML = `<h2>${filename}</h2><table>${data.map(row => `<tr>${Object.values(row).map(v => `<td>${v || 'N/A'}</td>`).join('')}</tr>`).join('')}</table>`;
        document.body.appendChild(element);
        const canvas = await html2canvas(element);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${filename}.pdf`);
        element.remove();
      },
      triggerConfetti: () => confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } })
    };

    // Main App Component
    const App = () => {
      const [theme, setTheme] = useState('mountain');
      const [activeTab, setActiveTab] = useState('dashboard');
      const [guests, setGuests] = useState([]);
      const [pastGuests, setPastGuests] = useState([]);
      const [bills, setBills] = useState([]);
      const [orders, setOrders] = useState([]);
      const [selectedGuest, setSelectedGuest] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [filterRoom, setFilterRoom] = useState('');
      const [modal, setModal] = useState(null);
      const [tasks, setTasks] = useState([]);
      const chartRefs = useRef({});
      const [error, setError] = useState(false);

      useEffect(() => {
        loadData();
        const interval = setInterval(checkForUpdates, 30000);
        return () => clearInterval(interval);
      }, []);

      const loadData = async () => {
        try {
          const [guestData, billData, orderData] = await Promise.all([
            utils.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"&sort[0][field]=checkin`),
            utils.fetchAirtable(config.airtable.tables.bills),
            utils.fetchAirtable(`${config.airtable.tables.orders}?filterByFormula={Status}!="Cancelled"`)
          ]);
          if (guestData && billData && orderData) {
            setGuests(guestData.records);
            setPastGuests(guestData.records.filter(g => g.fields.status === 'Checked Out'));
            setBills(billData.records);
            setOrders(orderData.records);
          } else {
            // Fallback to mock data if API fails
            setGuests(config.mockData.guests.filter(g => g.fields.status === 'Active'));
            setPastGuests(config.mockData.guests.filter(g => g.fields.status === 'Checked Out'));
            setBills(config.mockData.bills);
            setOrders(config.mockData.orders);
            utils.showToast('Using mock data due to API issue.', 'warning');
          }
          updateTasks(guests, bills);
          setError(false);
        } catch (error) {
          console.error('Data load failed:', error);
          setGuests(config.mockData.guests.filter(g => g.fields.status === 'Active'));
          setPastGuests(config.mockData.guests.filter(g => g.fields.status === 'Checked Out'));
          setBills(config.mockData.bills);
          setOrders(config.mockData.orders);
          setError(true);
          utils.showToast('Failed to load data. Using mock data.', 'error');
        }
      };

      const checkForUpdates = async () => {
        try {
          const newGuests = await utils.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"`);
          if (newGuests && newGuests.records.length > guests.length) {
            utils.showToast('New guest registered!', 'success');
            loadData();
          }
        } catch (error) {
          console.error('Update check failed:', error);
        }
      };

      const updateTasks = (guests, bills) => {
        const current = config.currentDate;
        const todayTasks = [
          ...guests.filter(g => new Date(g.fields.checkout) <= current && g.fields.status === 'Active').map(g => ({ text: `Check out ${g.fields.name}`, done: false })),
          ...bills.filter(b => b.fields.status === 'Overdue' && new Date(b.fields.checkoutDate) < current).map(b => ({ text: `Overdue bill for ${b.fields.guestName || 'Guest'}`, done: false }))
        ];
        setTasks(todayTasks);
      };

      const filterGuests = (list) => {
        return list.filter(g => {
          const fields = g.fields;
          return (fields.name?.toLowerCase().includes(searchQuery.toLowerCase()) || fields.guestID?.toLowerCase().includes(searchQuery.toLowerCase())) &&
                 (!filterRoom || fields.room === filterRoom);
        }).sort((a, b) => a.fields.name.localeCompare(b.fields.name));
      };

      const generateBill = async (guestId, isPast = false) => {
        try {
          const guest = (isPast ? pastGuests : guests).find(g => g.id === guestId);
          if (!guest) return utils.showToast('Guest not found', 'error');
          const existingBills = bills.filter(b => b.fields.guestID.includes(guest.fields.guestID));
          if (existingBills.length) {
            setModal({ type: 'bill', data: { guest: guest.fields, bills: existingBills } });
          } else {
            const orders = orders.filter(o => o.fields.guestID === guest.fields.guestID);
            const nights = guest.fields.nightsStayed || utils.calculateNights(guest.fields.checkin, guest.fields.checkout);
            const roomSubtotal = (guest.fields.roomRate || 5000) * nights;
            const orderSubtotal = orders.reduce((sum, o) => sum + (o.fields.TotalAmount || 0), 0);
            const subtotal = roomSubtotal + orderSubtotal;
            const taxes = subtotal * 0.18;
            const totalAmount = subtotal + taxes;
            const billData = {
              fields: {
                guestID: [guest.id],
                room: guest.fields.room,
                checkinDate: guest.fields.checkin,
                checkoutDate: guest.fields.checkout,
                nightsStayed: nights,
                roomRate: guest.fields.roomRate || 5000,
                subtotal: roomSubtotal,
                taxes,
                totalAmount,
                status: 'Pending',
                paymentMethod: guest.fields.advanceMode || 'UPI',
                notes: `Generated on ${new Date().toISOString()}`,
                orderDetails: JSON.stringify(orders.map(o => JSON.parse(o.fields.Items || '[]')).flat())
              }
            };
            const newBill = { id: `b${Date.now()}`, fields: billData.fields }; // Mock new bill
            setBills([...bills, newBill]);
            setModal({ type: 'bill', data: { guest: guest.fields, bills: [newBill] } });
            utils.triggerConfetti();
          }
        } catch (error) {
          console.error('Bill generation error:', error);
          utils.showToast('Error generating bill', 'error');
        }
      };

      const handleDelete = async (guestId) => {
        try {
          const guest = pastGuests.find(g => g.id === guestId);
          const affectedBills = bills.filter(b => b.fields.guestID.includes(guest.fields.guestID));
          const affectedOrders = orders.filter(o => o.fields.guestID === guest.fields.guestID);
          setModal({
            type: 'deleteConfirm',
            data: { guest, affected: { guests: [guest], bills: affectedBills, orders: affectedOrders } }
          });
        } catch (error) {
          console.error('Delete preparation error:', error);
          utils.showToast('Error preparing delete', 'error');
        }
      };

      const confirmDelete = async () => {
        try {
          const { guest, affected } = modal.data;
          setPastGuests(pastGuests.filter(g => g.id !== guest.id));
          setBills(bills.filter(b => !affected.bills.some(ab => ab.id === b.id)));
          setOrders(orders.filter(o => !affected.orders.some(ao => ao.id === o.id)));
          setModal(null);
          utils.showToast('Deletion successful', 'success');
          utils.triggerConfetti();
        } catch (error) {
          console.error('Delete error:', error);
          utils.showToast('Error deleting records', 'error');
        }
      };

      const exportData = (type) => {
        try {
          const start = new Date(document.getElementById('exportStart').value || '2025-01-01');
          const end = new Date(document.getElementById('exportEnd').value || '2025-12-31');
          const filteredGuests = guests.filter(g => new Date(g.fields.checkin) >= start && new Date(g.fields.checkin) <= end);
          const filteredOrders = orders.filter(o => {
            const orderDate = new Date(o.fields.createdTime || o.fields.updatedTime);
            return orderDate >= start && orderDate <= end;
          });
          if (type === 'csv') {
            utils.exportCSV(filteredGuests.map(g => ({ ...g.fields, amenities: g.fields.amenities || 'N/A' })), 'ocb_guests');
            utils.exportCSV(filteredOrders.map(o => ({ ...o.fields, items: JSON.stringify(o.fields.Items) })), 'ocb_orders');
          } else if (type === 'pdf') {
            utils.exportPDF(filteredGuests.map(g => ({ ...g.fields, amenities: g.fields.amenities || 'N/A' })), 'ocb_guests');
            utils.exportPDF(filteredOrders.map(o => ({ ...o.fields, items: JSON.stringify(o.fields.Items) })), 'ocb_orders');
          }
          utils.showToast('Export successful', 'success');
        } catch (error) {
          console.error('Export error:', error);
          utils.showToast('Error exporting data', 'error');
        }
      };

      useEffect(() => {
        const initCharts = () => {
          if (chartRefs.current.occupancy) {
            new Chart(chartRefs.current.occupancy, {
              type: 'doughnut',
              data: { labels: ['Occupied', 'Available'], datasets: [{ data: [guests.length, config.rooms.length - guests.length], backgroundColor: ['#48bb78', '#a0aec0'], borderWidth: 0 }] },
              options: { responsive: true, maintainAspectRatio: false }
            });
          }
          if (chartRefs.current.revenue) {
            new Chart(chartRefs.current.revenue, {
              type: 'bar',
              data: {
                labels: ['Room Revenue', 'Food Revenue'],
                datasets: [{
                  data: [
                    guests.reduce((sum, g) => sum + (g.fields.advance || 0) + (g.fields.balance || 0), 0),
                    bills.reduce((sum, b) => sum + b.fields.totalAmount, 0)
                  ],
                  backgroundColor: '#48bb78'
                }]
              },
              options: { responsive: true, maintainAspectRatio: false }
            });
          }
        };
        initCharts();
      }, [guests, bills]);

      useEffect(() => {
        const initCalendar = () => {
          const calendarEl = document.getElementById('calendar');
          if (calendarEl && !calendarEl._fullCalendar) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              events: guests.map(g => ({
                title: `${g.fields.name} - ${g.fields.room}`,
                start: g.fields.checkin,
                end: g.fields.checkout,
                color: '#48bb78'
              })),
              dateClick: info => console.log('Clicked:', info.dateStr),
              height: '100%'
            });
            calendar.render();
          }
        };
        initCalendar();
      }, [guests]);

      if (error) return <div className="error"><div className="fallback"></div></div>;

      return (
        <div className={`min-h-screen ${theme === 'mountain' ? 'bg-green-50' : 'bg-gray-900'} ${theme === 'snowy' ? 'text-gray-100' : 'text-gray-900'}`}>
          {/* Navbar */}
          <nav className="fixed top-0 w-full bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center z-900">
            <h2 className="text-xl font-bold">OCB Haven Dashboard</h2>
            <div className="flex gap-4">
              <select value={theme} onChange={e => setTheme(e.target.value)} className="border rounded px-3 py-2">
                <option value="mountain">Mountain Day</option>
                <option value="snowy">Snowy Night</option>
              </select>
              <button onClick={() => setModal({ type: 'register' })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                <i className="fas fa-user-plus mr-2"></i> Register Guest
              </button>
            </div>
          </nav>

          {/* Sidebar */}
          <div className="fixed left-0 top-16 h-[calc(100%-4rem)] w-64 bg-white dark:bg-gray-800 shadow-lg p-4 transition-all duration-300 z-900">
            <button onClick={() => setActiveTab('dashboard')} className={`w-full text-left p-3 mb-2 ${activeTab === 'dashboard' ? 'bg-green-100 dark:bg-green-900' : ''} rounded`}>
              <i className="fas fa-tachometer-alt mr-2"></i> Dashboard
            </button>
            <button onClick={() => setActiveTab('active')} className={`w-full text-left p-3 mb-2 ${activeTab === 'active' ? 'bg-green-100 dark:bg-green-900' : ''} rounded`}>
              <i className="fas fa-users mr-2"></i> Active Guests
            </button>
            <button onClick={() => setActiveTab('past')} className={`w-full text-left p-3 ${activeTab === 'past' ? 'bg-green-100 dark:bg-green-900' : ''} rounded`}>
              <i className="fas fa-history mr-2"></i> Past Guests
            </button>
          </div>

          {/* Main Content */}
          <main className="ml-64 mt-20 p-6">
            {activeTab === 'dashboard' && (
              <div>
                {/* Hero Section */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 animate-fade-in">
                  <h3 className="text-2xl font-bold mb-4">Welcome to OCB Haven</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                      <h4 className="font-semibold">Occupancy</h4>
                      <canvas ref={el => chartRefs.current.occupancy = el} className="w-full h-32"></canvas>
                      <p className="text-center">{guests.length} / {config.rooms.length} Rooms</p>
                    </div>
                    <div className="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                      <h4 className="font-semibold">Revenue</h4>
                      <canvas ref={el => chartRefs.current.revenue = el} className="w-full h-32"></canvas>
                      <p className="text-center">₹{bills.reduce((sum, b) => sum + b.fields.totalAmount, 0) + guests.reduce((sum, g) => sum + (g.fields.advance || 0) + (g.fields.balance || 0), 0)}</p>
                    </div>
                    <div className="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
                      <h4 className="font-semibold">Tasks</h4>
                      {tasks.map((task, i) => (
                        <div key={i} className="flex items-center mb-2">
                          <input type="checkbox" checked={task.done} onChange={() => {
                            const newTasks = tasks.map((t, idx) => idx === i ? { ...t, done: !t.done } : t);
                            setTasks(newTasks);
                          }} className="mr-2" />
                          <span>{task.text}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Calendar */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                  <h3 className="text-xl font-semibold mb-4">Booking Calendar</h3>
                  <div id="calendar" className="h-64"></div>
                </div>
              </div>
            )}

            {activeTab === 'active' && (
              <div>
                <h2 className="text-2xl font-bold mb-4">Active Guests</h2>
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                  <div className="flex justify-between mb-4">
                    <input type="text" placeholder="Search by name or ID" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="border rounded px-3 py-2" />
                    <select value={filterRoom} onChange={e => setFilterRoom(e.target.value)} className="border rounded px-3 py-2">
                      <option value="">All Rooms</option>
                      {config.rooms.map(room => <option key={room} value={room}>{room}</option>)}
                    </select>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="bg-gray-100 dark:bg-gray-700 text-left">
                          <th className="p-3">Name</th>
                          <th className="p-3">Room</th>
                          <th className="p-3">Dates</th>
                          <th className="p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filterGuests(guests).map(guest => (
                          <tr key={guest.id} className="border-b hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors" onClick={() => setSelectedGuest(guest)}>
                            <td className="p-3">{guest.fields.name} ({guest.fields.guestID})</td>
                            <td className="p-3">{guest.fields.room}</td>
                            <td className="p-3">{utils.formatDate(guest.fields.checkin)} - {utils.formatDate(guest.fields.checkout)}</td>
                            <td className="p-3 flex gap-2">
                              <button onClick={() => generateBill(guest.id)} className="text-blue-600 hover:text-blue-800"><i className="fas fa-file-invoice"></i></button>
                              <button onClick={() => setModal({ type: 'checkout', data: guest })} className="text-red-600 hover:text-red-800"><i className="fas fa-sign-out-alt"></i></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
                {selectedGuest && (
                  <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mt-6">
                    <h3 className="text-xl font-semibold mb-4">Guest Details</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <p className="mb-2"><strong>Name:</strong> {selectedGuest.fields.name}</p>
                        <p className="mb-2"><strong>Mobile:</strong> {selectedGuest.fields.mobile}</p>
                        <p className="mb-2"><strong>Room:</strong> {selectedGuest.fields.room}</p>
                        <p className="mb-2"><strong>Dates:</strong> {utils.formatDate(selectedGuest.fields.checkin)} - {utils.formatDate(selectedGuest.fields.checkout)}</p>
                        <p className="mb-2"><strong>Advance:</strong> ₹{selectedGuest.fields.advance || 0} ({selectedGuest.fields.advanceMode || 'N/A'})</p>
                        <p className="mb-2"><strong>Balance:</strong> ₹{selectedGuest.fields.balance || 0}</p>
                      </div>
                      <div>
                        <h4 className="font-medium mb-2">Food & Bills</h4>
                        {bills.filter(b => b.fields.guestID.includes(selectedGuest.fields.guestID)).map(b => (
                          <div key={b.id} className="mb-2 p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <p><strong>Bill ID:</strong> {b.fields.billID}</p>
                            <p><strong>Total:</strong> ₹{b.fields.totalAmount}</p>
                            <p><strong>Status:</strong> {b.fields.status}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="mt-4 flex gap-2">
                      <button onClick={() => setModal({ type: 'edit', data: selectedGuest.fields })} className="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                        <i className="fas fa-edit mr-2"></i> Edit
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'past' && (
              <div>
                <h2 className="text-2xl font-bold mb-4">Past Guests</h2>
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                  <div className="flex justify-between mb-4">
                    <input type="text" placeholder="Search by name or ID" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="border rounded px-3 py-2" />
                    <select value={filterRoom} onChange={e => setFilterRoom(e.target.value)} className="border rounded px-3 py-2">
                      <option value="">All Rooms</option>
                      {config.rooms.map(room => <option key={room} value={room}>{room}</option>)}
                    </select>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="bg-gray-100 dark:bg-gray-700 text-left">
                          <th className="p-3">Name</th>
                          <th className="p-3">Room</th>
                          <th className="p-3">Dates</th>
                          <th className="p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filterGuests(pastGuests).map(guest => (
                          <tr key={guest.id} className="border-b hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors" onClick={() => setSelectedGuest(guest)}>
                            <td className="p-3">{guest.fields.name} ({guest.fields.guestID})</td>
                            <td className="p-3">{guest.fields.room}</td>
                            <td className="p-3">{utils.formatDate(guest.fields.checkin)} - {utils.formatDate(guest.fields.checkout)}</td>
                            <td className="p-3 flex gap-2">
                              <button onClick={() => generateBill(guest.id, true)} className="text-blue-600 hover:text-blue-800"><i className="fas fa-file-invoice"></i></button>
                              <button onClick={() => handleDelete(guest.id)} className="text-red-600 hover:text-red-800"><i className="fas fa-trash"></i></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
                {selectedGuest && (
                  <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mt-6">
                    <h3 className="text-xl font-semibold mb-4">Guest Details</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <p className="mb-2"><strong>Name:</strong> {selectedGuest.fields.name}</p>
                        <p className="mb-2"><strong>Mobile:</strong> {selectedGuest.fields.mobile}</p>
                        <p className="mb-2"><strong>Room:</strong> {selectedGuest.fields.room}</p>
                        <p className="mb-2"><strong>Dates:</strong> {utils.formatDate(selectedGuest.fields.checkin)} - {utils.formatDate(selectedGuest.fields.checkout)}</p>
                        <p className="mb-2"><strong>Advance:</strong> ₹{selectedGuest.fields.advance || 0} ({selectedGuest.fields.advanceMode || 'N/A'})</p>
                        <p className="mb-2"><strong>Balance:</strong> ₹{selectedGuest.fields.balance || 0}</p>
                      </div>
                      <div>
                        <h4 className="font-medium mb-2">Food & Bills</h4>
                        {bills.filter(b => b.fields.guestID.includes(selectedGuest.fields.guestID)).map(b => (
                          <div key={b.id} className="mb-2 p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <p><strong>Bill ID:</strong> {b.fields.billID}</p>
                            <p><strong>Total:</strong> ₹{b.fields.totalAmount}</p>
                            <p><strong>Status:</strong> {b.fields.status}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Modals */}
            {modal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-1000">
                <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full modal-content">
                  {modal.type === 'register' && <div>Register Modal Placeholder</div>}
                  {modal.type === 'edit' && <div>Edit Modal Placeholder</div>}
                  {modal.type === 'checkout' && <div>Checkout Modal Placeholder</div>}
                  {modal.type === 'bill' && <BillModal bills={modal.data.bills} onClose={() => setModal(null)} />}
                  {modal.type === 'deleteConfirm' && (
                    <DeleteConfirmModal data={modal.data} onConfirm={confirmDelete} onClose={() => setModal(null)} />
                  )}
                </div>
              </div>
            )}

            {/* Assistant Widget */}
            <div className="fixed bottom-6 right-6 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 assistant">
              <h4 className="font-semibold mb-2">Host Assistant</h4>
              <ul className="text-sm space-y-1">
                {tasks.filter(t => !t.done).map((task, i) => (
                  <li key={i} className="flex items-center">
                    <i className="fas fa-bell mr-2 text-yellow-600"></i> {task.text}
                  </li>
                ))}
              </ul>
              {tasks.every(t => t.done) && <p className="text-green-600 text-sm">All tasks complete!</p>}
            </div>
          </main>

          {/* Footer */}
          <footer className="bg-white dark:bg-gray-800 p-4 mt-6 text-center shadow-inner">
            <p className="text-sm">© 2025 OCB Stays | <a href="#" className="text-blue-600 hover:underline">Support</a></p>
          </footer>

          {/* Logo SVG */}
          <svg className="logo fixed top-4 left-72 hidden" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 15 L40 50 L80 50 L60 15 Z" fill="#8B4513" /> {/* A-Frame Roof */}
            <rect x="50" y="50" width="20" height="60" fill="#D2B48C" /> {/* Cottage Body */}
            <path d="M60 50 L55 110 L65 110 L60 50 Z" fill="#D2B48C" /> {/* Chimney */}
            <path d="M55 50 A 6 6 0 0 1 65 50" fill="#4682B4" /> {/* O as Window */}
            <path d="M60 40 Q 70 30 80 40" fill="none" stroke="#4682B4" strokeWidth="6" /> {/* C as Roofline */}
            <path d="M50 110 L50 90 L70 90 L70 110" fill="#FFD700" /> {/* B as Base */}
            <text x="55" y="70" fontSize="14" fill="#FFD700">OCB</text>
          </svg>
        </div>
      );
    };

    // Modal Components
    const BillModal = ({ bills, onClose }) => (
      <div>
        <h3 className="text-lg font-semibold mb-4">Bills for Guest</h3>
        {bills.map(b => (
          <div key={b.id} className="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <p><strong>Bill ID:</strong> {b.fields.billID}</p>
            <p><strong>Room:</strong> {b.fields.room}</p>
            <p><strong>Dates:</strong> {utils.formatDate(b.fields.checkinDate)} - {utils.formatDate(b.fields.checkoutDate)}</p>
            <p><strong>Nights:</strong> {b.fields.nightsStayed}</p>
            <p><strong>Room Rate:</strong> ₹{b.fields.roomRate}</p>
            <p><strong>Subtotal:</strong> ₹{b.fields.subtotal}</p>
            <p><strong>Taxes:</strong> ₹{b.fields.taxes}</p>
            <p><strong>Total:</strong> ₹{b.fields.totalAmount}</p>
            <p><strong>Status:</strong> {b.fields.status}</p>
            <p><strong>Method:</strong> {b.fields.paymentMethod}</p>
            <p><strong>Notes:</strong> {b.fields.notes}</p>
          </div>
        ))}
        <button onClick={onClose} className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Close</button>
      </div>
    );

    const DeleteConfirmModal = ({ data, onConfirm, onClose }) => {
      const [confirmed, setConfirmed] = useState(false);
      return (
        <div>
          <h3 className="text-lg font-semibold mb-4">Confirm Delete</h3>
          <p>Are you sure you want to delete {data.guest.fields.name}?</p>
          <div className="mt-2 space-y-2">
            <p><strong>Affected Records:</strong></p>
            <p>Guests: 1 (ID: {data.guest.fields.guestID})</p>
            <p>Bills: {data.affected.bills.length} ({data.affected.bills.map(b => b.fields.billID).join(', ')})</p>
            <p>Orders: {data.affected.orders.length}</p>
          </div>
          <div className="mt-4 flex items-center gap-2">
            <input type="checkbox" checked={confirmed} onChange={e => setConfirmed(e.target.checked)} className="mr-2" />
            <label>I understand the consequences</label>
            <button onClick={onConfirm} disabled={!confirmed} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ml-auto">
              Delete
            </button>
            <button onClick={onClose} className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
          </div>
        </div>
      );
    };

    // Render with DOM check
    document.addEventListener('DOMContentLoaded', () => {
      ReactDOM.render(<App />, document.getElementById('root'));
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays – Host Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root {
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #1a1a1a;
      --secondary-text: #6c757d;
      --border-color: #e9ecef;
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --card-bg: #2c2c2c;
      --text-color: #e9ecef;
      --secondary-text: #adb5bd;
      --border-color: #444;
      --primary-color: #66b0ff;
      --primary-hover: #4a90e2;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      max-width: 1400px;
      margin: auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 600;
    }

    .theme-toggle {
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 50%;
      border: 1px solid var(--border-color);
    }

    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .action-icon {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      width: 2.5rem;
      height: 2.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .action-icon:hover {
      transform: translateY(-2px);
    }

    .email-icon { background-color: var(--primary-color); color: white; }
    .whatsapp-icon { background-color: #25D366; color: white; }
    .copy-icon { background-color: var(--secondary-text); color: white; }
    .food-icon { background-color: #ff6b6b; color: white; }
    .call-icon { background-color: #4caf50; color: white; }

    .guest-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
    }

    .guest-list-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }

    .guest-list-item:last-child { border-bottom: none; }
    .guest-list-item:hover { background-color: #e9ecef; }
    .guest-list-item.active { background-color: #e7f5ff; }
    .guest-list-name { font-weight: 500; flex: 1; }
    .guest-list-room { color: var(--secondary-text); font-size: 0.9rem; width: 150px; text-align: center; }
    .guest-list-dates { color: var(--secondary-text); font-size: 0.85rem; width: 200px; text-align: right; }

    .guest-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      position: relative;
    }

    .guest-details-section {
      margin-bottom: 1.5rem;
    }

    .guest-details-section h6 {
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .guest-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

    .detail-item {
      padding: 0.75rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .detail-label {
      font-weight: 500;
      font-size: 0.8rem;
      color: var(--secondary-text);
      text-transform: uppercase;
    }

    .detail-value {
      margin-top: 0.25rem;
    }

    .payment-summary {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .payment-summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .payment-summary-item.total {
      font-weight: 600;
      border-top: 1px solid var(--border-color);
      padding-top: 0.5rem;
    }

    .payment-mode {
      font-size: 0.8rem;
      color: var(--secondary-text);
      margin-left: 0.5rem;
    }

    .food-orders-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .food-orders-card:hover { background-color: #e9ecef; }

    .food-orders-card h6 {
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edit-icon-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      color: var(--secondary-text);
      transition: color 0.2s;
    }

    .edit-icon-btn:hover { color: var(--primary-color); }

    .notes-section {
      margin-top: 1rem;
    }

    .notes-content {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .modal-content {
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow);
      background: var(--card-bg);
    }

    .modal-header {
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      border-top: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }

    .form-label {
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      color: var(--text-color);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }

    .payment-mode-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .payment-mode-group .form-control:first-child { flex: 2; }
    .payment-mode-group .form-select { flex: 1; min-width: 120px; }

    .contact-button-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .contact-icon {
      color: var(--secondary-text);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .contact-icon:hover { background-color: #e9ecef; }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }

    .order-item {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }

    .order-item:last-child { border-bottom: none; }
    .order-item-details { flex: 1; }
    .order-item-price { font-weight: 500; width: 80px; text-align: right; }

    .bill-container {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-top: 1rem;
    }

    .bill-header {
      text-align: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1rem;
    }

    .bill-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .bill-subtitle {
      color: var(--secondary-text);
      margin-bottom: 0.5rem;
    }

    .bill-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .bill-items {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }

    .bill-items th {
      text-align: left;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }

    .bill-items td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .bill-items .text-right { text-align: right; }
    .bill-items .text-center { text-align: center; }

    .bill-total {
      font-weight: 600;
      text-align: right;
      font-size: 1.1rem;
      margin-top: 1rem;
    }

    .dashboard-card {
      transition: transform 0.2s;
    }

    .dashboard-card:hover {
      transform: translateY(-4px);
    }
  </style>
</head>
<body>
  <div class="toast-container"></div>

  <div class="container">
    <div class="header">
      <h1>OCB Stays – Host Management</h1>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
          <i class="fas fa-user-plus"></i> Register Guest
        </button>
        <i class="fas fa-moon theme-toggle" id="themeToggle" title="Toggle Theme"></i>
      </div>
    </div>

    <div class="manage-content">
      <ul class="nav nav-tabs mb-3" id="manageTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-guests" type="button" role="tab">Active Guests</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-guests" type="button" role="tab">Past Guests</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Current Guests</h6>
                <div id="currentGuestsCount" class="mb-2"><strong>0</strong> guests</div>
                <div id="currentGuestsList"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Upcoming Bookings (Next 7 Days)</h6>
                <div id="upcomingBookings"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Room Occupancy</h6>
                <div id="roomOccupancy"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Revenue Snapshot</h6>
                <div id="revenueSummary"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Pending Balances</h6>
                <div id="pendingBalances"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Recent Food Orders</h6>
                <div id="recentOrders"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="guest-card dashboard-card">
                <h6>Check-Outs Today</h6>
                <div id="checkoutsToday"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="active-guests" role="tabpanel">
          <div class="mb-3">
            <label class="form-label">Select Active Guest</label>
            <div class="guest-list" id="guestList">
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <div id="selectedGuestInfo" style="display: none;">
            <div class="guest-card position-relative">
              <i class="fas fa-edit edit-icon-btn" id="editGuestBtn"></i>
              <div id="guestDetailsContent"></div>
            </div>

            <div class="action-buttons mt-3">
              <a class="action-icon call-icon" id="callGuest" title="Call Guest">
                <i class="fas fa-phone"></i>
              </a>
              <div class="action-icon whatsapp-icon" id="sendWhatsappToGuest" title="Send WhatsApp">
                <i class="fab fa-whatsapp"></i>
              </div>
              <div class="action-icon email-icon" id="sendEmailToGuest" title="Send Email">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="action-icon copy-icon" id="copyGuestLink" title="Copy Link">
                <i class="fas fa-copy"></i>
              </div>
              <div class="action-icon food-icon" id="placeOrder" title="Place Food Order">
                <i class="fas fa-utensils"></i>
              </div>
              <button id="generateBill" class="btn btn-primary">
                <i class="fas fa-file-invoice"></i> Generate Bill
                <span id="billSpinner" class="loading-spinner" style="display: none;"></span>
              </button>
              <button id="checkoutGuest" class="btn btn-danger">
                <i class="fas fa-sign-out-alt"></i> Checkout
                <span id="checkoutSpinner" class="loading-spinner" style="display: none;"></span>
              </button>
            </div>
            <div id="billOutput" class="mt-3"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="past-guests" role="tabpanel">
          <div class="mb-3">
            <label class="form-label">Select Past Guest</label>
            <div class="guest-list" id="pastGuestList">
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <div id="selectedPastGuestInfo" style="display: none;">
            <div class="guest-card">
              <div id="pastGuestDetailsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register New Guest</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="guestForm">
            <div class="mb-3">
              <label for="dateRange" class="form-label">Dates</label>
              <input type="text" class="form-control flatpickr-input" id="dateRange" placeholder="Select check-in and check-out dates" required>
            </div>
            <div class="mb-3">
              <label for="room" class="form-label">Room</label>
              <select class="form-select" id="room" required disabled>
                <option value="">Select dates first</option>
              </select>
            </div>
            <div id="availabilityStatus" class="availability-status"></div>
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
              <label for="mobile" class="form-label">Mobile Number</label>
              <div class="contact-button-wrapper">
                <input type="tel" class="form-control" id="mobile" required>
                <a class="contact-icon call-icon" id="callMobile" title="Call"><i class="fas fa-phone"></i></a>
                <div class="contact-icon whatsapp-icon" id="whatsappMobile" title="WhatsApp"><i class="fab fa-whatsapp"></i></div>
                <div class="contact-icon copy-icon" id="copyMobile" title="Copy Number"><i class="fas fa-copy"></i></div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Advance Payment</label>
              <div class="payment-mode-group">
                <input type="number" class="form-control" id="advanceAmount" placeholder="Amount (₹)">
                <select class="form-select" id="advanceMode">
                  <option value="">Payment Mode</option>
                  <option value="UPI">UPI</option>
                  <option value="Cash">Cash</option>
                  <option value="Card">Card</option>
                  <option value="NetBanking">Net Banking</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="balanceAmount" class="form-label">Balance Amount (₹)</label>
              <input type="number" class="form-control" id="balanceAmount">
            </div>
            <div class="mb-3">
              <label for="comments" class="form-label">Notes</label>
              <textarea class="form-control" id="comments" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="registerBtn" form="guestForm">
            Register
            <span id="registerSpinner" class="loading-spinner" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Guest Modal -->
  <div class="modal fade" id="editGuestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Guest Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editGuestForm">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="mb-3">
              <label for="editMobile" class="form-label">Mobile Number</label>
              <div class="contact-button-wrapper">
                <input type="tel" class="form-control" id="editMobile" required>
                <a class="contact-icon call-icon" id="editCallMobile" title="Call"><i class="fas fa-phone"></i></a>
                <div class="contact-icon whatsapp-icon" id="editWhatsappMobile" title="WhatsApp"><i class="fab fa-whatsapp"></i></div>
                <div class="contact-icon copy-icon" id="editCopyMobile" title="Copy Number"><i class="fas fa-copy"></i></div>
              </div>
            </div>
            <div class="mb-3">
              <label for="editRoom" class="form-label">Room</label>
              <select class="form-select" id="editRoom" required>
                <option value="">Select Room</option>
                <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
                <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
                <option value="A Frame Cottage">A Frame Cottage</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editCheckin" class="form-label">Check-in Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckin" required>
            </div>
            <div class="mb-3">
              <label for="editCheckout" class="form-label">Check-out Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckout" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Advance Payment</label>
              <div class="payment-mode-group">
                <input type="number" class="form-control" id="editAdvance" placeholder="Amount (₹)">
                <select class="form-select" id="editAdvanceMode">
                  <option value="">Payment Mode</option>
                  <option value="UPI">UPI</option>
                  <option value="Cash">Cash</option>
                  <option value="Card">Card</option>
                  <option value="NetBanking">Net Banking</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="editBalance" class="form-label">Balance Amount (₹)</label>
              <input type="number" class="form-control" id="editBalance">
            </div>
            <div class="mb-3">
              <label for="editComments" class="form-label">Notes</label>
              <textarea class="form-control" id="editComments" rows="2"></textarea>
            </div>
            <input type="hidden" id="editGuestId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveGuestChanges">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Confirmation Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Checkout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="checkoutForm">
            <div class="mb-3">
              <label class="form-label">Balance Due (₹)</label>
              <input type="number" class="form-control" id="checkoutBalance" readonly>
            </div>
            <div class="mb-3">
              <label for="checkoutPaymentType" class="form-label">Payment Mode</label>
              <select class="form-select" id="checkoutPaymentType" required>
                <option value="">Select Payment Mode</option>
                <option value="UPI">UPI</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="NetBanking">Net Banking</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="checkoutComments" class="form-label">Comments</label>
              <textarea class="form-control" id="checkoutComments" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmCheckout">Complete Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Food Orders Modal -->
  <div class="modal fade" id="foodOrdersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Food & Amenities Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="foodOrdersModalBody">
          Loading...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Success Modal -->
  <div class="modal fade" id="registrationSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Guest Registered Successfully</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="registration-success-details" id="registrationSuccessDetails"></div>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="guestLinkInput" readonly>
            <button class="btn btn-outline-secondary" id="copyGuestLinkModal" title="Copy Link"><i class="fas fa-copy"></i></button>
          </div>
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-primary" id="sendEmailFromModal">
              <i class="fas fa-envelope"></i> Email
            </button>
            <button class="btn btn-success" id="sendWhatsappFromModal">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Configuration
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: {
          guests: 'Guests',
          bills: 'Bills',
          orders: 'Orders'
        }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"],
      paymentModes: ["UPI", "Cash", "Card", "NetBanking"]
    };

    // Utility Functions
    const utils = {
      generateGuestId: () => 'GST' + Array(5).fill().map(() => 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      
      formatDate: (dateString) => new Date(dateString).toLocaleDateString('en-US', { 
        month: 'short', day: 'numeric', year: 'numeric' 
      }),

      fetchAirtable: async (endpoint, options = {}) => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
        try {
          const response = await fetch(url, {
            headers: { 
              'Authorization': `Bearer ${config.airtable.token}`,
              'Content-Type': 'application/json'
            },
            ...options
          });
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API request failed');
          return response.json();
        } catch (error) {
          console.error('Airtable API error:', error);
          throw error;
        }
      },

      showToast: (message, type = 'success') => {
        const toastContainer = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        toastContainer.appendChild(toast);
        new bootstrap.Toast(toast).show();
        setTimeout(() => toast.remove(), 5000);
      },

      toggleSpinner: (elementId, show) => {
        const spinner = document.getElementById(elementId);
        if (spinner) spinner.style.display = show ? 'inline-block' : 'none';
      },

      datesOverlap: (start1, end1, start2, end2) => {
        const d1 = new Date(start1), d2 = new Date(end1), d3 = new Date(start2), d4 = new Date(end2);
        return (d1 < d4) && (d3 < d2);
      },

      calculateNights: (checkin, checkout) => {
        const oneDay = 24 * 60 * 60 * 1000;
        return Math.round(Math.abs((new Date(checkin) - new Date(checkout)) / oneDay));
      }
    };

    // Core Application Logic
    const app = {
      async loadDashboard() {
        try {
          // Current Guests
          const activeGuests = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"&sort[0][field]=checkin`
          );
          document.getElementById('currentGuestsCount').innerHTML = `<strong>${activeGuests.records.length}</strong> guests`;
          document.getElementById('currentGuestsList').innerHTML = activeGuests.records.length
            ? activeGuests.records.map(r => `
                <div class="detail-item mb-2" data-guest-id="${r.id}" style="cursor: pointer;" onclick="app.selectGuestFromDashboard('${r.id}')">
                  <div class="detail-label">${r.fields.name || 'Unnamed Guest'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${r.fields.guestID}');utils.showToast('Guest ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span></div>
                  <div class="detail-value">${r.fields.room} (${utils.formatDate(r.fields.checkin)} - ${utils.formatDate(r.fields.checkout)})</div>
                </div>
              `).join('')
            : '<div class="text-muted">No active guests</div>';

          // Upcoming Bookings
          const today = new Date().toISOString().split('T')[0];
          const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          const upcomingGuests = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula=AND({status}="Active", {checkin}>="${today}", {checkin}<="${nextWeek}")&sort[0][field]=checkin`
          );
          document.getElementById('upcomingBookings').innerHTML = upcomingGuests.records.length
            ? upcomingGuests.records.map(r => `
                <div class="detail-item mb-2" data-guest-id="${r.id}" style="cursor: pointer;" onclick="app.selectGuestFromDashboard('${r.id}')">
                  <div class="detail-label">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="detail-value">${r.fields.room} (Check-in: ${utils.formatDate(r.fields.checkin)})</div>
                </div>
              `).join('')
            : '<div class="text-muted">No upcoming bookings</div>';

          // Room Occupancy
          const occupiedRooms = new Set(activeGuests.records.map(r => r.fields.room));
          document.getElementById('roomOccupancy').innerHTML = config.rooms.map(room => `
            <div class="detail-item mb-2">
              <div class="detail-label">${room}</div>
              <div class="detail-value">
                <span class="badge bg-${occupiedRooms.has(room) ? 'danger' : 'success'}">
                  ${occupiedRooms.has(room) ? 'Occupied' : 'Available'}
                </span>
              </div>
            </div>
          `).join('');

          // Revenue Snapshot
          const allGuests = await utils.fetchAirtable(config.airtable.tables.guests);
          const orders = await utils.fetchAirtable(config.airtable.tables.orders);
          const advanceTotal = allGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.advanceAmount) || 0), 0);
          const balanceTotal = allGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.balanceAmount) || 0), 0);
          const foodTotal = orders.records.reduce((sum, r) => sum + (parseFloat(r.fields.TotalAmount) || 0), 0);
          document.getElementById('revenueSummary').innerHTML = `
            <div class="detail-item mb-2"><div class="detail-label">Advance Payments</div><div class="detail-value">₹${advanceTotal.toFixed(2)}</div></div>
            <div class="detail-item mb-2"><div class="detail-label">Balance Payments</div><div class="detail-value">₹${balanceTotal.toFixed(2)}</div></div>
            <div class="detail-item mb-2"><div class="detail-label">Food Orders</div><div class="detail-value">₹${foodTotal.toFixed(2)}</div></div>
            <div class="detail-item"><div class="detail-label">Total Revenue</div><div class="detail-value">₹${(advanceTotal + balanceTotal + foodTotal).toFixed(2)}</div></div>
          `;

          // Pending Balances
          const pendingGuests = activeGuests.records.filter(r => (parseFloat(r.fields.balanceAmount) || 0) > 0);
          document.getElementById('pendingBalances').innerHTML = pendingGuests.length
            ? pendingGuests.map(r => `
                <div class="detail-item mb-2" data-guest-id="${r.id}" style="cursor: pointer;" onclick="app.selectGuestFromDashboard('${r.id}')">
                  <div class="detail-label">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="detail-value">₹${(parseFloat(r.fields.balanceAmount) || 0).toFixed(2)}</div>
                </div>
              `).join('')
            : '<div class="text-muted">No pending balances</div>';

          // Recent Food Orders
          const recentOrders = await utils.fetchAirtable(
            `${config.airtable.tables.orders}?sort[0][field]=createdAt&sort[0][direction]=desc&maxRecords=3`
          );
          document.getElementById('recentOrders').innerHTML = recentOrders.records.length
            ? recentOrders.records.map(r => {
                const guest = allGuests.records.find(g => g.fields.guestID === r.fields.Guest);
                return `
                  <div class="detail-item mb-2">
                    <div class="detail-label">${guest?.fields.name || 'Unknown Guest'} (#${r.fields.OrderID || r.id}) <span class="copy-icon" onclick="navigator.clipboard.writeText('${r.fields.OrderID || r.id}');utils.showToast('Order ID copied!', 'success');"><i class="fas fa-copy"></i></span></div>
                    <div class="detail-value">₹${(r.fields.TotalAmount || 0).toFixed(2)}</div>
                  </div>
                `;
              }).join('')
            : '<div class="text-muted">No recent orders</div>';

          // Check-Outs Today
          const checkouts = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula=AND({status}="Active", {checkout}="${today}")`
          );
          document.getElementById('checkoutsToday').innerHTML = checkouts.records.length
            ? checkouts.records.map(r => `
                <div class="detail-item mb-2" data-guest-id="${r.id}" style="cursor: pointer;" onclick="app.selectGuestFromDashboard('${r.id}')">
                  <div class="detail-label">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="detail-value">${r.fields.room}</div>
                </div>
              `).join('')
            : '<div class="text-muted">No check-outs today</div>';

        } catch (error) {
          utils.showToast('Error loading dashboard', 'danger');
          console.error('Dashboard error:', error);
        }
      },

      async selectGuestFromDashboard(guestId) {
        await app.loadActiveGuests();
        const guestItem = document.querySelector(`#guestList [data-guest-id="${guestId}"]`);
        if (guestItem) {
          document.querySelector('#active-tab').click();
          guestItem.click();
        }
      },

      async loadAvailableRooms() {
        const roomSelect = document.getElementById('room');
        roomSelect.disabled = true;
        try {
          const data = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"`
          );
          const occupiedRooms = new Set(data.records.map(r => r.fields.room));
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          config.rooms.forEach(room => {
            if (!occupiedRooms.has(room)) {
              roomSelect.innerHTML += `<option value="${room}">${room}</option>`;
            }
          });
        } catch (error) {
          utils.showToast('Error loading rooms', 'danger');
          roomSelect.innerHTML = '<option value="">Error loading rooms</option>';
        } finally {
          roomSelect.disabled = false;
        }
      },

      async checkRoomAvailability() {
        const dateRange = document.getElementById('dateRange').value;
        const [checkin, checkout] = dateRange.split(' to ');
        const roomSelect = document.getElementById('room');
        const statusDiv = document.getElementById('availabilityStatus');
        
        statusDiv.innerHTML = '<span>Checking availability...</span>';
        try {
          const data = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"`
          );
          const bookedRooms = new Set(data.records.filter(r => 
            utils.datesOverlap(r.fields.checkin, r.fields.checkout, checkin, checkout)
          ).map(r => r.fields.room));

          roomSelect.innerHTML = '<option value="">Select Room</option>';
          let availableCount = 0;
          config.rooms.forEach(room => {
            if (!bookedRooms.has(room)) {
              roomSelect.innerHTML += `<option value="${room}">${room}</option>`;
              availableCount++;
            }
          });

          statusDiv.innerHTML = availableCount === 0 
            ? '<span class="text-danger">No rooms available</span>'
            : `<span class="text-success">${availableCount} room(s) available</span>`;
          roomSelect.disabled = availableCount === 0;
        } catch (error) {
          statusDiv.innerHTML = '<span class="text-danger">Error checking availability</span>';
        }
      },

      async loadActiveGuests() {
        const guestList = document.getElementById('guestList');
        guestList.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
        try {
          const data = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"&sort[0][field]=checkin`
          );
          if (!data.records.length) {
            guestList.innerHTML = '<div class="text-center py-3 text-muted">No active guests</div>';
            document.getElementById('selectedGuestInfo').style.display = 'none';
            return;
          }

          guestList.innerHTML = data.records.map(record => `
            <div class="guest-list-item" data-guest-id="${record.id}" data-guest='${JSON.stringify(record.fields)}'>
              <div class="guest-list-name">${record.fields.name || 'Unnamed Guest'} (${record.fields.guestID}) <span class="copy-icon" onclick="navigator.clipboard.writeText('${record.fields.guestID}');utils.showToast('Guest ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span></div>
              <div class="guest-list-room">${record.fields.room}</div>
              <div class="guest-list-dates">${utils.formatDate(record.fields.checkin)} - ${utils.formatDate(record.fields.checkout)}</div>
            </div>
          `).join('');

          if (window.selectedGuestId) {
            const selectedItem = guestList.querySelector(`[data-guest-id="${window.selectedGuestId}"]`);
            if (selectedItem) {
              selectedItem.classList.add('active');
              document.getElementById('selectedGuestInfo').style.display = 'block';
              this.loadGuestDetailsForDisplay(window.selectedGuestId, JSON.parse(selectedItem.dataset.guest));
            }
          }
        } catch (error) {
          guestList.innerHTML = '<div class="text-center py-3 text-danger">Failed to load guests</div>';
        }
      },

      async loadPastGuests() {
        const pastGuestList = document.getElementById('pastGuestList');
        pastGuestList.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
        try {
          const data = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Checked Out"&sort[0][field]=checkout&sort[0][direction]=desc`
          );
          if (!data.records.length) {
            pastGuestList.innerHTML = '<div class="text-center py-3 text-muted">No past guests</div>';
            document.getElementById('selectedPastGuestInfo').style.display = 'none';
            return;
          }

          pastGuestList.innerHTML = data.records.map(record => `
            <div class="guest-list-item" data-guest-id="${record.id}" data-guest='${JSON.stringify(record.fields)}'>
              <div class="guest-list-name">${record.fields.name || 'Unnamed Guest'} (${record.fields.guestID}) <span class="copy-icon" onclick="navigator.clipboard.writeText('${record.fields.guestID}');utils.showToast('Guest ID copied!', 'success');event.stopPropagation();"><i class="fas fa-copy"></i></span></div>
              <div class="guest-list-room">${record.fields.room}</div>
              <div class="guest-list-dates">${utils.formatDate(record.fields.checkout)}</div>
            </div>
          `).join('');

          if (window.selectedPastGuestId) {
            const selectedItem = pastGuestList.querySelector(`[data-guest-id="${window.selectedPastGuestId}"]`);
            if (selectedItem) {
              selectedItem.classList.add('active');
              document.getElementById('selectedPastGuestInfo').style.display = 'block';
              this.loadPastGuestDetails(window.selectedPastGuestId);
            }
          }
        } catch (error) {
          pastGuestList.innerHTML = '<div class="text-center py-3 text-danger">Failed to load past guests</div>';
        }
      },

      async loadGuestDetails(guestId) {
        const response = await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`);
        if (!response.id) throw new Error('Guest not found');
        return response.fields;
      },

      async loadGuestDetailsForDisplay(guestId, guestData) {
        const guest = guestData || await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);
        const totalDue = (parseFloat(guest.balanceAmount) || 0) + foodTotal;

        document.getElementById('guestDetailsContent').innerHTML = `
          <div class="guest-details-section">
            <h6>Guest Information</h6>
            <div class="guest-details-grid">
              <div class="detail-item"><div class="detail-label">Name</div><div class="detail-value">${guest.name || 'Unnamed Guest'}</div></div>
              <div class="detail-item"><div class="detail-label">Mobile</div><div class="detail-value">${guest.mobile || 'Not provided'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${guest.mobile}');utils.showToast('Mobile copied!', 'success');"><i class="fas fa-copy"></i></span></div></div>
              <div class="detail-item"><div class="detail-label">Room</div><div class="detail-value">${guest.room}</div></div>
              <div class="detail-item"><div class="detail-label">Nights</div><div class="detail-value">${nights}</div></div>
              <div class="detail-item"><div class="detail-label">Check-in</div><div class="detail-value">${utils.formatDate(guest.checkin)}</div></div>
              <div class="detail-item"><div class="detail-label">Check-out</div><div class="detail-value">${utils.formatDate(guest.checkout)}</div></div>
            </div>
            ${guest.Comments ? `<div class="notes-section"><div class="detail-label">Notes</div><div class="notes-content">${guest.Comments}</div></div>` : ''}
            <div class="food-orders-card" id="viewFoodOrders"><h6><span>Food & Amenities</span><span class="badge bg-primary">₹${foodTotal.toFixed(2)}</span></h6></div>
          </div>
          <div class="guest-details-section">
            <h6>Payment Summary</h6>
            <div class="payment-summary">
              <div class="payment-summary-item"><span>Advance Paid:</span><span>₹${guest.advanceAmount || 0}${guest.advanceMode ? ` <span class="payment-mode">(${guest.advanceMode})</span>` : ''}</span></div>
              <div class="payment-summary-item"><span>Food Orders:</span><span>₹${foodTotal.toFixed(2)}</span></div>
              <div class="payment-summary-item"><span>Balance Due:</span><span>₹${guest.balanceAmount || 0}</span></div>
              <div class="payment-summary-item total"><span>Total Due:</span><span>₹${totalDue.toFixed(2)}</span></div>
            </div>
          </div>
        `;

        const homeLink = guest.homeLink;
        document.getElementById('copyGuestLink').onclick = () => {
          navigator.clipboard.writeText(homeLink);
          utils.showToast('Link copied to clipboard!', 'success');
        };
        document.getElementById('sendEmailToGuest').onclick = () => window.open(
          `mailto:?subject=OCB Stays Information&body=${encodeURIComponent(this.generateEmailBody(guest, homeLink))}`
        );
        document.getElementById('sendWhatsappToGuest').onclick = () => window.open(
          `https://wa.me/${guest.mobile}?text=${encodeURIComponent(this.generateWhatsappMessage(guest, homeLink))}`
        );
        document.getElementById('callGuest').href = `tel:${guest.mobile}`;
        document.getElementById('viewFoodOrders').onclick = () => this.showFoodOrdersModal(guestId);
      },

      async loadPastGuestDetails(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);

        document.getElementById('pastGuestDetailsContent').innerHTML = `
          <div class="guest-details-section">
            <h6>Guest Information</h6>
            <div class="guest-details-grid">
              <div class="detail-item"><div class="detail-label">Name</div><div class="detail-value">${guest.name || 'Unnamed Guest'}</div></div>
              <div class="detail-item"><div class="detail-label">Mobile</div><div class="detail-value">${guest.mobile || 'Not provided'} <span class="copy-icon" onclick="navigator.clipboard.writeText('${guest.mobile}');utils.showToast('Mobile copied!', 'success');"><i class="fas fa-copy"></i></span></div></div>
              <div class="detail-item"><div class="detail-label">Room</div><div class="detail-value">${guest.room}</div></div>
              <div class="detail-item"><div class="detail-label">Nights</div><div class="detail-value">${nights}</div></div>
              <div class="detail-item"><div class="detail-label">Check-in</div><div class="detail-value">${utils.formatDate(guest.checkin)}</div></div>
              <div class="detail-item"><div class="detail-label">Check-out</div><div class="detail-value">${utils.formatDate(guest.checkout)}</div></div>
            </div>
            ${guest.Comments ? `<div class="notes-section"><div class="detail-label">Notes</div><div class="notes-content">${guest.Comments}</div></div>` : ''}
            <div class="food-orders-card" id="viewPastFoodOrders"><h6><span>Food & Amenities</span><span class="badge bg-primary">₹${foodTotal.toFixed(2)}</span></h6></div>
          </div>
          <div class="guest-details-section">
            <h6>Payment Summary</h6>
            <div class="payment-summary">
              <div class="payment-summary-item"><span>Advance Paid:</span><span>₹${guest.advanceAmount || 0}${guest.advanceMode ? ` <span class="payment-mode">(${guest.advanceMode})</span>` : ''}</span></div>
              <div class="payment-summary-item"><span>Food Orders:</span><span>₹${foodTotal.toFixed(2)}</span></div>
              <div class="payment-summary-item"><span>Balance Paid:</span><span>₹${guest.balanceAmount || 0}${guest.PaymentType ? ` <span class="payment-mode">(${guest.PaymentType})</span>` : ''}</span></div>
              <div class="payment-summary-item total"><span>Total Paid:</span><span>₹${((parseFloat(guest.advanceAmount) || 0) + (parseFloat(guest.balanceAmount) || 0) + foodTotal).toFixed(2)}</span></div>
            </div>
          </div>
        `;
        document.getElementById('viewPastFoodOrders').onclick = () => this.showFoodOrdersModal(guestId);
      },

      async calculateFoodTotal(guestId) {
        const orders = await this.getGuestOrders(guestId);
        return orders.reduce((total, order) => total + (order.fields.TotalAmount || 0), 0);
      },

      async getGuestOrders(guestID) {
        try {
          return (await utils.fetchAirtable(
            `${config.airtable.tables.orders}?filterByFormula=AND({Guest} = '${guestID}', {Status} != 'Cancelled')`
          )).records;
        } catch (error) {
          utils.showToast('Error fetching orders', 'danger');
          return [];
        }
      },

      async showFoodOrdersModal(guestId) {
        const modal = new bootstrap.Modal(document.getElementById('foodOrdersModal'));
        const modalBody = document.getElementById('foodOrdersModalBody');
        modalBody.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
        modal.show();

        try {
          const guest = await this.loadGuestDetails(guestId);
          const orders = await this.getGuestOrders(guest.guestID);
          if (!orders.length) {
            modalBody.innerHTML = '<div class="alert alert-info">No food orders found</div>';
            return;
          }

          modalBody.innerHTML = orders.map(order => {
            const orderDate = new Date(order.fields.createdAt || order.createdTime).toLocaleString();
            const items = JSON.parse(order.fields.Items || '[]');
            const totalAmount = order.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            return `
              <div class="card mb-3">
                <div class="card-header">
                  <div class="d-flex justify-content-between">
                    <div>Order #${order.fields.OrderID || order.id} <span class="copy-icon" onclick="navigator.clipboard.writeText('${order.fields.OrderID || order.id}');utils.showToast('Order ID copied!', 'success');"><i class="fas fa-copy"></i></span></div>
                    <div>${orderDate}</div>
                  </div>
                  <div class="d-flex justify-content-between mt-1">
                    <div>Status: <span class="badge bg-${order.fields.Status === 'Delivered' ? 'success' : 'warning'}">${order.fields.Status}</span></div>
                    <div>Total: ₹${totalAmount.toFixed(2)}</div>
                  </div>
                </div>
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">Items</h6>
                  <div class="order-items">
                    ${items.map(item => `
                      <div class="order-item">
                        <div class="order-item-details">
                          ${item.quantity} × ${item.name}
                          ${item.specialInstructions ? `<div class="text-muted small">${item.specialInstructions}</div>` : ''}
                        </div>
                        <div class="order-item-price">₹${(item.price * item.quantity).toFixed(2)}</div>
                      </div>
                    `).join('')}
                  </div>
                  ${order.fields.SpecialInstructions ? `
                    <div class="mt-2"><strong>Special Instructions:</strong><div>${order.fields.SpecialInstructions}</div></div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        } catch (error) {
          modalBody.innerHTML = '<div class="alert alert-danger">Failed to load food orders</div>';
        }
      },

      async createFoodBill(guestRecordId, guestDetails, orders) {
        let totalAmount = 0;
        const itemMap = new Map();
        orders.forEach(order => {
          const items = JSON.parse(order.fields.Items || '[]');
          const orderTotal = order.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
          totalAmount += orderTotal;

          items.forEach(item => {
            const itemKey = `${item.name || 'Unspecified item'}-${item.price || 0}`;
            const existingItem = itemMap.get(itemKey);
            if (existingItem) {
              existingItem.quantity += item.quantity || 1;
              existingItem.amount = existingItem.price * existingItem.quantity;
              if (order.fields.createdAt && (!existingItem.date || order.fields.createdAt < existingItem.date)) {
                existingItem.date = order.fields.createdAt;
              }
            } else {
              itemMap.set(itemKey, {
                item: item.name || 'Unspecified item',
                quantity: item.quantity || 1,
                price: item.price || 0,
                amount: (item.price || 0) * (item.quantity || 1),
                date: order.fields.createdAt || new Date().toISOString()
              });
            }
          });
        });

        const allOrderItems = Array.from(itemMap.values());
        const existingBills = await utils.fetchAirtable(
          `${config.airtable.tables.bills}?filterByFormula={guestID} = '${guestRecordId}'`
        );

        let billId;
        if (existingBills.records.length > 0) {
          billId = existingBills.records[0].id;
          await utils.fetchAirtable(`${config.airtable.tables.bills}/${billId}`, {
            method: 'PATCH',
            body: JSON.stringify({
              fields: {
                totalAmount: totalAmount,
                orderDetails: JSON.stringify(allOrderItems),
                updatedAt: new Date().toISOString()
              }
            })
          });
        } else {
          const billData = {
            fields: {
              billID: `BIL-${Date.now().toString().slice(-6)}`,
              guestID: [guestRecordId],
              totalAmount: totalAmount,
              status: "Pending",
              orderDetails: JSON.stringify(allOrderItems)
            }
          };
          billId = (await utils.fetchAirtable(config.airtable.tables.bills, {
            method: 'POST',
            body: JSON.stringify(billData)
          })).id;
        }

        return { guest: guestDetails, orders: allOrderItems, totalAmount, billId };
      },

      downloadBillAsImage() {
        const billDetails = document.querySelector('.bill-container');
        if (!billDetails) return utils.showToast('No bill generated to download', 'warning');
        html2canvas(billDetails).then(canvas => {
          const link = document.createElement('a');
          link.download = 'food-bill.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      },

      generateEmailBody(guest, link) {
        return `Hi ${guest.name},\nThank you for choosing OCB Stays for your upcoming trip to Fagu.\n\nYour booking for ${guest.room} for ${utils.formatDate(guest.checkin)} is confirmed with advance payment of ₹${guest.advanceAmount || 0} (non-refundable), balance ₹${guest.balanceAmount || 0} to be transferred on arrival.\n\nCheck-in: ${utils.formatDate(guest.checkin)} 1pm\nCheck Out: ${utils.formatDate(guest.checkout)} 11am\n\nPlease follow the below link for CheckIn instructions and other important info:\n${link}\n\nPlease share your Id's for the record purpose & feel free to get in touch anytime in case you have any queries or need any assistance.\n\nHope you have a great time !!\n\nThanks,\nPrateek & Ishika\nOCB Stays, Curated with Love..`;
      },

      generateWhatsappMessage(guest, link) {
        return `Hi ${guest.name},\nThank you for choosing OCB Stays for your upcoming trip to Fagu.\nPlease follow the below link:\n${link}\n\nCheers,\nTeam OCB Stays`;
      },

      initCalendar() {
        flatpickr("#dateRange", {
          mode: "range",
          minDate: "today",
          dateFormat: "Y-m-d",
          onChange: selectedDates => {
            if (selectedDates.length === 2) this.checkRoomAvailability();
          }
        });
        flatpickr("#editCheckin", { minDate: "today", dateFormat: "Y-m-d" });
        flatpickr("#editCheckout", { minDate: "today", dateFormat: "Y-m-d" });
      },

      async showCheckoutModal(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        const foodTotal = await this.calculateFoodTotal(guest.guestID);
        const totalDue = (parseFloat(guest.balanceAmount) || 0) + foodTotal;

        document.getElementById('checkoutBalance').value = totalDue.toFixed(2);
        document.getElementById('checkoutPaymentType').value = '';
        document.getElementById('checkoutComments').value = '';

        new bootstrap.Modal(document.getElementById('checkoutModal')).show();
      },

      showRegistrationSuccess(guest, homeLink) {
        const modal = new bootstrap.Modal(document.getElementById('registrationSuccessModal'));
        document.getElementById('registrationSuccessDetails').innerHTML = `
          <div class="mb-2"><strong>Name:</strong> ${guest.name || 'Unnamed Guest'}</div>
          <div class="mb-2"><strong>Room:</strong> ${guest.room}</div>
          <div class="mb-2"><strong>Dates:</strong> ${utils.formatDate(guest.checkin)} to ${utils.formatDate(guest.checkout)}</div>
          <div class="mb-2"><strong>Mobile:</strong> ${guest.mobile || 'Not provided'}</div>
          <div class="mb-2"><strong>Advance:</strong> ₹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</div>
        `;
        document.getElementById('guestLinkInput').value = homeLink;
        document.getElementById('copyGuestLinkModal').onclick = () => {
          navigator.clipboard.writeText(homeLink);
          utils.showToast('Link copied to clipboard!', 'success');
        };
        document.getElementById('sendEmailFromModal').onclick = () => window.open(
          `mailto:?subject=OCB Stays Booking Confirmation&body=${encodeURIComponent(this.generateEmailBody(guest, homeLink))}`
        );
        document.getElementById('sendWhatsappFromModal').onclick = () => window.open(
          `https://wa.me/${guest.mobile}?text=${encodeURIComponent(this.generateWhatsappMessage(guest, homeLink))}`
        );
        modal.show();
      },

      async showEditGuestModal(guestId) {
        const guest = await this.loadGuestDetails(guestId);
        document.getElementById('editName').value = guest.name || '';
        document.getElementById('editMobile').value = guest.mobile || '';
        document.getElementById('editRoom').value = guest.room || '';
        document.getElementById('editCheckin').value = guest.checkin || '';
        document.getElementById('editCheckout').value = guest.checkout || '';
        document.getElementById('editAdvance').value = guest.advanceAmount || '';
        document.getElementById('editAdvanceMode').value = guest.advanceMode || '';
        document.getElementById('editBalance').value = guest.balanceAmount || '';
        document.getElementById('editComments').value = guest.Comments || '';
        document.getElementById('editGuestId').value = guestId;

        document.getElementById('editCallMobile').href = `tel:${guest.mobile}`;
        document.getElementById('editWhatsappMobile').onclick = () => window.open(`https://wa.me/${guest.mobile}`);
        document.getElementById('editCopyMobile').onclick = () => {
          navigator.clipboard.writeText(guest.mobile);
          utils.showToast('Mobile copied!', 'success');
        };

        new bootstrap.Modal(document.getElementById('editGuestModal')).show();
      },

      async saveGuestChanges() {
        const guestId = document.getElementById('editGuestId').value;
        const btn = document.getElementById('saveGuestChanges');
        btn.disabled = true;

        try {
          const formData = {
            name: document.getElementById('editName').value,
            mobile: document.getElementById('editMobile').value,
            room: document.getElementById('editRoom').value,
            checkin: document.getElementById('editCheckin').value,
            checkout: document.getElementById('editCheckout').value,
            advanceAmount: parseFloat(document.getElementById('editAdvance').value) || 0,
            advanceMode: document.getElementById('editAdvanceMode').value || '',
            balanceAmount: parseFloat(document.getElementById('editBalance').value) || 0,
            Comments: document.getElementById('editComments').value || ''
          };

          if (!formData.name) throw new Error('Please enter guest name');
          if (!formData.mobile) throw new Error('Please enter mobile number');
          if (!formData.room) throw new Error('Please select a room');
          if (!formData.checkin || !formData.checkout) throw new Error('Please select valid dates');

          await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`, {
            method: 'PATCH',
            body: JSON.stringify({ fields: formData })
          });

          utils.showToast('Guest details updated successfully', 'success');
          await this.loadActiveGuests();
          await this.loadDashboard();
          bootstrap.Modal.getInstance(document.getElementById('editGuestModal')).hide();
        } catch (error) {
          utils.showToast(`Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
        }
      }
    };

    // Event Handlers
    const handlers = {
      async registerGuest(e) {
        e.preventDefault();
        const btn = document.getElementById('registerBtn');
        btn.disabled = true;
        utils.toggleSpinner('registerSpinner', true);

        try {
          const dateRange = document.getElementById('dateRange').value;
          if (!dateRange) throw new Error('Please select dates');
          const [checkin, checkout] = dateRange.split(' to ');
          const formData = {
            room: document.getElementById('room').value,
            checkin,
            checkout,
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            advanceAmount: parseFloat(document.getElementById('advanceAmount').value) || 0,
            advanceMode: document.getElementById('advanceMode').value || '',
            balanceAmount: parseFloat(document.getElementById('balanceAmount').value) || 0,
            Comments: document.getElementById('comments').value || ''
          };

          if (!formData.room) throw new Error('Please select a room');
          if (!formData.name) throw new Error('Please enter guest name');
          if (!formData.mobile) throw new Error('Please enter mobile number');

          const guestID = utils.generateGuestId();
          const homeLink = `${config.urls.guestPortal}?guestID=${guestID}&room=${encodeURIComponent(formData.room)}`;

          await utils.fetchAirtable(config.airtable.tables.guests, {
            method: 'POST',
            body: JSON.stringify({
              fields: { ...formData, guestID, status: "Active", homeLink }
            })
          });

          document.getElementById('guestForm').reset();
          app.showRegistrationSuccess(formData, homeLink);
          await app.loadActiveGuests();
          await app.loadAvailableRooms();
          await app.loadDashboard();
          bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
        } catch (error) {
          utils.showToast(`Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          utils.toggleSpinner('registerSpinner', false);
        }
      },


  async generateBill() {
    const selectedGuest = document.querySelector('.guest-list-item.active');
    if (!selectedGuest) return utils.showToast('Please select a guest', 'warning');

    const btn = document.getElementById('generateBill');
    btn.disabled = true;
    utils.toggleSpinner('billSpinner', true);
    document.getElementById('billOutput').innerHTML = '<div class="alert alert-info">Generating food bill...</div>';

    try {
      const guestId = selectedGuest.dataset.guestId;
      const guestData = JSON.parse(selectedGuest.dataset.guest);
      const orders = await app.getGuestOrders(guestData.guestID);
      if (!orders.length) {
        document.getElementById('billOutput').innerHTML = '<div class="alert alert-info">No food orders found</div>';
        return utils.showToast('No food orders found', 'warning');
      }

      const billResult = await app.createFoodBill(guestId, guestData, orders);
      document.getElementById('billOutput').innerHTML = `
        <div class="alert alert-success">Food bill generated!</div>
        <div class="bill-container">
          <div class="bill-header">
            <div class="bill-title">OCB Stays</div>
            <div class="bill-subtitle">Food Order Bill</div>
          </div>
          <div class="bill-meta">
            <div>
              <div><strong>Guest:</strong> ${billResult.guest.name || 'Unnamed Guest'}</div>
              <div><strong>Room:</strong> ${billResult.guest.room}</div>
              <div><strong>Bill ID:</strong> ${billResult.billId} <span class="copy-icon" onclick="navigator.clipboard.writeText('${billResult.billId}');utils.showToast('Bill ID copied!', 'success');"><i class="fas fa-copy"></i></span></div>
            </div>
            <div>
              <div><strong>Date:</strong> ${utils.formatDate(new Date())}</div>
            </div>
          </div>
          <table class="bill-items">
            <thead>
              <tr>
                <th style="width: 40%;">Item</th>
                <th class="text-center" style="width: 20%;">Quantity</th>
                <th class="text-center" style="width: 20%;">Price</th>
                <th class="text-right" style="width: 20%;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${billResult.orders.map(item => `
                <tr>
                  <td>${item.item}</td>
                  <td class="text-center">${item.quantity}</td>
                  <td class="text-center">₹${item.price.toFixed(2)}</td>
                  <td class="text-right">₹${item.amount.toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class="bill-total">
            <span>Total: ₹${billResult.totalAmount.toFixed(2)}</span>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="app.downloadBillAsImage()">
              <i class="fas fa-download"></i> Download as Image
            </button>
          </div>
        </div>
      `;
      utils.showToast('Food bill generated successfully', 'success');
    } catch (error) {
      document.getElementById('billOutput').innerHTML = '<div class="alert alert-danger">Failed to generate bill</div>';
      utils.showToast(`Error: ${error.message}`, 'danger');
    } finally {
      btn.disabled = false;
      utils.toggleSpinner('billSpinner', false);
    }
  },

  async confirmCheckout() {
    const selectedGuest = document.querySelector('.guest-list-item.active');
    if (!selectedGuest) return utils.showToast('Please select a guest', 'warning');

    const btn = document.getElementById('confirmCheckout');
    btn.disabled = true;

    try {
      const guestId = selectedGuest.dataset.guestId;
      const paymentType = document.getElementById('checkoutPaymentType').value;
      const comments = document.getElementById('checkoutComments').value;
      const balance = parseFloat(document.getElementById('checkoutBalance').value) || 0;

      if (!paymentType && balance > 0) throw new Error('Please select a payment mode');

      const guestData = JSON.parse(selectedGuest.dataset.guest);
      const orders = await app.getGuestOrders(guestData.guestID);
      if (orders.length) {
        await app.createFoodBill(guestId, guestData, orders);
      }

      await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`, {
        method: 'PATCH',
        body: JSON.stringify({
          fields: {
            status: 'Checked Out',
            checkoutDate: new Date().toISOString().split('T')[0],
            PaymentType: paymentType,
            Comments: comments || guestData.Comments
          }
        })
      });

      utils.showToast('Guest checked out successfully', 'success');
      await app.loadActiveGuests();
      await app.loadPastGuests();
      await app.loadDashboard();
      bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
      document.getElementById('billOutput').innerHTML = '';
      document.getElementById('selectedGuestInfo').style.display = 'none';
    } catch (error) {
      utils.showToast(`Error: ${error.message}`, 'danger');
    } finally {
      btn.disabled = false;
    }
  },

  handleGuestSelection(e) {
    const guestItem = e.target.closest('.guest-list-item');
    if (!guestItem) return;

    document.querySelectorAll('.guest-list-item').forEach(item => item.classList.remove('active'));
    guestItem.classList.add('active');
    window.selectedGuestId = guestItem.dataset.guestId;
    document.getElementById('selectedGuestInfo').style.display = 'block';
    app.loadGuestDetailsForDisplay(guestItem.dataset.guestId, JSON.parse(guestItem.dataset.guest));
  },

  handlePastGuestSelection(e) {
    const guestItem = e.target.closest('.guest-list-item');
    if (!guestItem) return;

    document.querySelectorAll('#pastGuestList .guest-list-item').forEach(item => item.classList.remove('active'));
    guestItem.classList.add('active');
    window.selectedPastGuestId = guestItem.dataset.guestId;
    document.getElementById('selectedPastGuestInfo').style.display = 'block';
    app.loadPastGuestDetails(guestItem.dataset.guestId);
  },

  handleContactActions() {
    const mobileInput = document.getElementById('mobile');
    document.getElementById('callMobile').href = `tel:${mobileInput.value}`;
    document.getElementById('whatsappMobile').onclick = () => window.open(`https://wa.me/${mobileInput.value}`);
    document.getElementById('copyMobile').onclick = () => {
      navigator.clipboard.writeText(mobileInput.value);
      utils.showToast('Mobile number copied!', 'success');
    };
  }
};

// Initialize Application
document.addEventListener('DOMContentLoaded', () => {
  // Theme Toggle
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', () => {
    const isDark = document.documentElement.dataset.theme === 'dark';
    document.documentElement.dataset.theme = isDark ? 'light' : 'dark';
    themeToggle.classList.toggle('fa-moon', isDark);
    themeToggle.classList.toggle('fa-sun', !isDark);
  });

  // Form Submission
  document.getElementById('guestForm').addEventListener('submit', handlers.registerGuest);
  document.getElementById('saveGuestChanges').addEventListener('click', app.saveGuestChanges);
  document.getElementById('confirmCheckout').addEventListener('click', handlers.confirmCheckout);

  // Guest Selection
  document.getElementById('guestList').addEventListener('click', handlers.handleGuestSelection);
  document.getElementById('pastGuestList').addEventListener('click', handlers.handlePastGuestSelection);

  // Action Buttons
  document.getElementById('generateBill').addEventListener('click', handlers.generateBill);
  document.getElementById('checkoutGuest').addEventListener('click', () => {
    const selectedGuest = document.querySelector('.guest-list-item.active');
    if (selectedGuest) app.showCheckoutModal(selectedGuest.dataset.guestId);
    else utils.showToast('Please select a guest', 'warning');
  });
  document.getElementById('editGuestBtn').addEventListener('click', () => {
    const selectedGuest = document.querySelector('.guest-list-item.active');
    if (selectedGuest) app.showEditGuestModal(selectedGuest.dataset.guestId);
  });
  document.getElementById('placeOrder').addEventListener('click', () => {
    const guestData = JSON.parse(document.querySelector('.guest-list-item.active')?.dataset.guest || '{}');
    if (guestData.guestID) window.open(`${config.urls.guestMenu}?guestID=${guestData.guestID}&room=${encodeURIComponent(guestData.room)}`);
    else utils.showToast('Please select a guest', 'warning');
  });

  // Contact Input Handlers
  document.getElementById('mobile').addEventListener('input', handlers.handleContactActions);

  // Initialize Data and UI
  app.initCalendar();
  app.loadActiveGuests();
  app.loadPastGuests();
  app.loadDashboard();
  app.loadAvailableRooms();
});
</script>

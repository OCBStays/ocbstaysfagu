<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCB Stays â€“ Host Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body{font-family:'Segoe UI',sans-serif;background-color:#f9f9f9;padding:1rem;max-width:1000px;margin:auto;padding-bottom:80px;}
    .loading-spinner{display:inline-block;width:1rem;height:1rem;border:2px solid rgba(0,0,0,.1);border-radius:50%;border-top-color:#3498db;animation:spin 1s ease-in-out infinite;margin-left:0.5rem;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .action-icon{font-size:1rem;padding:0.5rem;border-radius:50%;width:2.5rem;height:2.5rem;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;margin:0 0.25rem;}
    .email-icon{background-color:#3498db;color:white;}
    .whatsapp-icon{background-color:#25D366;color:white;}
    .copy-icon{background-color:#6c757d;color:white;}
    .food-icon{background-color:#ff6b6b;color:white;}
    .contact-icon{color:#6c757d;cursor:pointer;margin-left:0.5rem;font-size:1.5rem;padding:0.5rem;}
    .action-buttons{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;}
    .availability-status{margin-top:1rem;font-weight:bold;}
    .available{color:#28a745;}
    .unavailable{color:#dc3545;}
    .footer-tabs{position:fixed;bottom:0;left:0;right:0;background:white;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:1000;padding:0.5rem 1rem;}
    .guest-card{border:1px solid #dee2e6;border-radius:8px;padding:1rem;margin-bottom:1rem;background:white;}
    .guest-meta{font-size:0.9rem;color:#6c757d;margin-bottom:0.5rem;}
    .date-fields-row{display:flex;gap:0.5rem;align-items:flex-end;}
    .month-calendar{background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:1rem;margin-bottom:1rem;}
    .month-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
    .weekdays,.days-grid{display:grid;grid-template-columns:repeat(7,1fr);}
    .weekdays{text-align:center;font-weight:bold;margin-bottom:0.5rem;}
    .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:0.5rem;border-radius:8px;cursor:pointer;transition:all 0.2s;position:relative;}
    .calendar-day:hover{background-color:#f0f0f0;}
    .past-day{color:#ccc;}
    .today{background-color:#e3f2fd;color:#1976d2;}
    .booked-day{background-color:#ffebee;color:#c62828;}
    .available-day{background-color:#e8f5e9;color:#2e7d32;}
    .selected-day{background-color:#bbdefb;color:#0d47a1;font-weight:bold;}
    .dashboard-scrollable{display:flex;flex-direction:column;gap:1.5rem;}
    .dashboard-section{background:white;border-radius:10px;padding:1rem;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
    .dashboard-section h2{font-size:1.2rem;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid #eee;display:flex;align-items:center;gap:0.5rem;}
  </style>
</head>
<body>
  <h1 class="text-center mb-4">OCB Stays â€“ Host Dashboard</h1>

  <div class="main-content">
    <div id="dashboard-content">
      <div class="dashboard-scrollable">
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-day"></i> Today's Guests</h2>
          <div id="today-guests-list"><div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div></div>
        </div>
        
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-week"></i> Upcoming Guests</h2>
          <div id="upcoming-guests-list"><div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div></div>
        </div>
        
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-alt"></i> Booking Calendar</h2>
          <div class="mb-3">
            <select class="form-select" id="propertyFilter">
              <option value="all">All Properties</option>
              <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
              <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
              <option value="A Frame Cottage">A Frame Cottage</option>
            </select>
          </div>
          <div id="property-calendar-view"></div>
        </div>
      </div>
    </div>
    
    <div id="register-content" style="display:none;">
      <form id="guestForm">
        <div class="date-selection mb-3">
          <h5>Select Dates</h5>
          <div class="mb-3">
            <input type="text" class="form-control flatpickr-input" id="dateRange" placeholder="Select check-in and check-out dates" required>
          </div>
          <button type="button" class="btn btn-secondary" id="checkAvailability">
            Check Room Availability <span id="availabilitySpinner" class="loading-spinner" style="display:none;"></span>
          </button>
          <div id="availabilityStatus" class="availability-status"></div>
        </div>
        
        <div class="mb-3">
          <label for="room" class="form-label">Room</label>
          <select class="form-select" id="room" required disabled>
            <option value="">First select dates and check availability</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
          <label for="mobile" class="form-label">Mobile Number</label>
          <div class="contact-button-wrapper">
            <input type="tel" class="form-control" id="mobile" required>
            <i class="fas fa-address-book contact-icon" id="openContacts"></i>
          </div>
        </div>
        <div class="mb-3">
          <label for="advanceAmount" class="form-label">Advance Payment (â‚¹)</label>
          <input type="number" class="form-control" id="advanceAmount">
        </div>
        <div class="mb-3">
          <label for="balanceAmount" class="form-label">Balance Amount (â‚¹)</label>
          <input type="number" class="form-control" id="balanceAmount">
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary" id="registerBtn">
            Register <span id="registerSpinner" class="loading-spinner" style="display:none;"></span>
          </button>
          <div class="action-icon email-icon" id="sendEmailBtn" disabled title="Send Email"><i class="fas fa-envelope"></i></div>
          <div class="action-icon whatsapp-icon" id="sendWhatsappBtn" disabled title="Send WhatsApp"><i class="fab fa-whatsapp"></i></div>
        </div>
      </form>
      <div id="linkOutput" class="mt-3"></div>
    </div>
    <>
    <div id="manage-content" style="display:none;">
      <div class="mb-3">
        <label for="guestSelect" class="form-label">Select Active Guest</label>
        <select class="form-select" id="guestSelect"><option value="">Select Guest</option></select>
      </div>
      
      <div id="selectedGuestInfo" style="display:none;">
        <div class="action-buttons">
          <div class="action-icon email-icon" id="sendEmailToGuest" title="Send Email"><i class="fas fa-envelope"></i></div>
          <div class="action-icon whatsapp-icon" id="sendWhatsappToGuest" title="Send WhatsApp"><i class="fab fa-whatsapp"></i></div>
          <div class="action-icon copy-icon" id="copyGuestLink" title="Copy Link"><i class="fas fa-copy"></i></div>
        </div>
      </div>
      
      <div class="action-buttons">
        <div class="action-icon food-icon" id="placeOrder" title="Place Food Order"><i class="fas fa-utensils"></i></div>
        <button id="generateBill" class="btn btn-secondary compact-btn">
          <i class="fas fa-file-invoice"></i> Bill <span id="billSpinner" class="loading-spinner" style="display:none;"></span>
        </button>
        <button id="checkoutGuest" class="btn btn-danger compact-btn">
          <i class="fas fa-sign-out-alt"></i> Checkout <span id="checkoutSpinner" class="loading-spinner" style="display:none;"></span>
        </button>
      </div>
      <div id="billOutput" class="mt-3"></div>
    </div>
  </div>

  <div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dayModalTitle">Day Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="dayModalBody">Loading...</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-tabs">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dashboard-tab" data-tab-target="dashboard" type="button" role="tab">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="register-footer-tab" data-tab-target="register" type="button" role="tab">
          <i class="fas fa-user-plus"></i> Register
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="manage-footer-tab" data-tab-target="manage" type="button" role="tab">
          <i class="fas fa-users-cog"></i> Manage
        </button>
      </li>
    </ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: { guests: 'Guests', bills: 'Bills', orders: 'Orders' }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"]
    };

    const helpers = {
      generateGuestId: () => 'GST' + Array.from({length:5},()=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random()*62)]).join(''),
      formatDate: d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),
      formatShortDate: d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'}),
      async fetchAirtable(endpoint,options={}) {
        const res = await fetch(`https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`,{
          headers:{'Authorization':`Bearer ${config.airtable.token}`,'Content-Type':'application/json'},...options
        });
        if(!res.ok) throw new Error((await res.json()).error?.message||'API request failed');
        return await res.json();
      },
      toggleSpinner:(id,show)=>document.getElementById(id).style.display=show?'inline-block':'none',
      showAlert:(id,msg,type='success')=>{
        const alert=document.createElement('div');
        alert.className=`alert alert-${type} mt-3`;
        alert.textContent=msg;
        document.getElementById(id).prepend(alert);
        setTimeout(()=>alert.remove(),5000);
      },
      datesOverlap:(s1,e1,s2,e2)=>(new Date(s1)<new Date(e2))&&(new Date(s2)<new Date(e1)),
      focusNextInput:el=>{
        const inputs=[...el.closest('form').querySelectorAll('input,select,textarea')];
        const idx=inputs.indexOf(el);
        if(idx<inputs.length-1)inputs[idx+1].focus();
      },
      getDaysInMonth:(y,m)=>new Date(y,m+1,0).getDate(),
      getFirstDayOfMonth:(y,m)=>new Date(y,m,1).getDay()
    };

    const app = {
      async loadAvailableRooms() {
        const sel=document.getElementById('room');
        try {
          sel.disabled=true;
          const data=await helpers.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"`);
          const occupied=new Set(data.records.map(r=>r.fields.room));
          sel.innerHTML='<option value="">Select Room</option>';
          config.rooms.forEach(r=>{if(!occupied.has(r))sel.innerHTML+=`<option value="${r}">${r}</option>`});
        } catch(e){console.error(e);sel.innerHTML='<option value="">Error loading rooms</option>';}
        finally{sel.disabled=false;}
      },
      
      async checkRoomAvailability() {
        const dates=document.getElementById('dateRange').value;
        if(!dates) return document.getElementById('availabilityStatus').innerHTML='<span class="unavailable">Please select dates</span>';
        
        const [ci,co]=dates.split(' to '),roomSel=document.getElementById('room'),status=document.getElementById('availabilityStatus');
        const btn=document.getElementById('checkAvailability');
        btn.disabled=true;
        helpers.toggleSpinner('availabilitySpinner',true);
        status.innerHTML='<span>Checking availability...</span>';
        
        try {
          const data=await helpers.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"`);
          const booked=new Set();
          data.records.forEach(r=>{
            if(helpers.datesOverlap(r.fields.checkin,r.fields.checkout,ci,co))booked.add(r.fields.room);
          });
          
          roomSel.innerHTML='<option value="">Select Room</option>';
          let avail=0;
          config.rooms.forEach(r=>{
            if(!booked.has(r)){roomSel.innerHTML+=`<option value="${r}">${r}</option>`;avail++;}
          });
          
          if(avail===0){
            status.innerHTML='<span class="unavailable">No rooms available</span>';
            roomSel.disabled=true;
          } else {
            status.innerHTML=`<span class="available">${avail} room(s) available</span>`;
            roomSel.disabled=false;
          }
        } catch(e){console.error(e);status.innerHTML='<span class="unavailable">Error checking availability</span>';}
        finally{btn.disabled=false;helpers.toggleSpinner('availabilitySpinner',false);}
      },
      
      async loadActiveGuests() {
        const sel=document.getElementById('guestSelect');
        try {
          sel.disabled=true;
          sel.innerHTML='<option value="">Loading guests...</option>';
          const data=await helpers.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"`);
          sel.innerHTML='<option value="">Select Guest</option>';
          data.records.forEach(r=>{
            const o=new Option(`${r.fields.name||'Unnamed'} (${r.fields.guestID}) - ${r.fields.room}`,r.id);
            o.dataset.guest=JSON.stringify(r.fields);
            sel.add(o);
          });
        } catch(e){console.error(e);helpers.showAlert('billOutput',`Failed to load guests:${e.message}`,'danger');}
        finally{sel.disabled=false;}
      },
      
      async loadGuestList(containerId,formula) {
        const container=document.getElementById(containerId);
        try {
          container.innerHTML='<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
          const data=await helpers.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula=${formula}`);
          
          if(data.records.length===0){
            container.innerHTML='<div class="alert alert-info">No guests found</div>';
            return;
          }
          
          container.innerHTML=data.records.map(r=>{
            const g=r.fields;
            return `<div class="guest-card">
              <h5>${g.name||'Unnamed Guest'}</h5>
              <div class="guest-meta">
                <div><strong>Room:</strong> ${g.room}</div>
                <div><strong>Check-in:</strong> ${helpers.formatDate(g.checkin)}</div>
                <div><strong>Check-out:</strong> ${helpers.formatDate(g.checkout)}</div>
                ${containerId==='today-guests-list'?`<div><strong>Mobile:</strong> ${g.mobile||'Not provided'}</div>`:''}
                ${containerId==='upcoming-guests-list'?`<div><strong>Days to check-in:</strong> ${Math.ceil((new Date(g.checkin)-new Date())/(1000*60*60*24)}</div>`:''}
              </div>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary manage-guest-btn" data-guest-id="${r.id}">
                  <i class="fas fa-cog"></i> Manage
                </button>
              </div>
            </div>`;
          }).join('');
          
          document.querySelectorAll('.manage-guest-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
              document.querySelector('#manage-footer-tab').click();
              setTimeout(()=>{
                const sel=document.getElementById('guestSelect');
                sel.value=btn.dataset.guestId;
                sel.dispatchEvent(new Event('change'));
                document.getElementById('manage-content').scrollIntoView({behavior:'smooth'});
              },100);
            });
          });
        } catch(e){console.error(e);container.innerHTML='<div class="alert alert-danger">Failed to load guests</div>';}
      },
      
      async generateCalendarView(propertyFilter='all') {
        const container=document.getElementById('property-calendar-view');
        try {
          container.innerHTML='<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
          const data=await helpers.fetchAirtable(`${config.airtable.tables.guests}?filterByFormula={status}="Active"`);
          const bookings=propertyFilter==='all'?data.records:data.records.filter(r=>r.fields.room===propertyFilter);
          
          const today=new Date(),month=today.getMonth(),year=today.getFullYear();
          const monthName=today.toLocaleDateString('en-US',{month:'long',year:'numeric'});
          const daysInMonth=helpers.getDaysInMonth(year,month),firstDay=helpers.getFirstDayOfMonth(year,month);
          
          let html=`<div class="month-calendar"><div class="month-header"><div class="month-title">${monthName}</div></div>
            <div class="weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
            <div class="days-grid">`;
          
          for(let i=0;i<firstDay;i++)html+=`<div class="calendar-day"></div>`;
          
          for(let day=1;day<=daysInMonth;day++){
            const date=new Date(year,month,day),dateStr=date.toISOString().split('T')[0];
            const isToday=dateStr===today.toISOString().split('T')[0];
            const dayBookings=bookings.filter(b=>helpers.datesOverlap(b.fields.checkin,b.fields.checkout,dateStr,dateStr));
            const isBooked=dayBookings.length>0;
            
            const dayClass=['calendar-day',isToday?'today':'',isBooked?'booked-day':'available-day',date<today?'past-day':''].filter(Boolean).join(' ');
            
            html+=`<div class="${dayClass}" data-date="${dateStr}">
              <div class="day-number">${day}</div>
              <div class="day-events">${
                isBooked?`<span class="day-event-dot" style="background-color:#c62828;"></span>${
                  dayBookings.length>1?'<span class="day-event-dot" style="background-color:#c62828;"></span>':''}`:''
              }</div></div>`;
          }
          
          container.innerHTML=html+`</div></div>`;
          
          document.querySelectorAll('.calendar-day').forEach(day=>{
            day.addEventListener('click',()=>{
              const date=day.dataset.date;
              if(date) this.showDayDetails(date,bookings);
            });
          });
        } catch(e){console.error(e);container.innerHTML='<div class="alert alert-danger">Failed to load calendar</div>';}
      },
      
      async showDayDetails(date,bookings) {
        const modal=new bootstrap.Modal(document.getElementById('dayModal'));
        document.getElementById('dayModalTitle').textContent=new Date(date).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        
        const dayBookings=bookings.filter(b=>helpers.datesOverlap(b.fields.checkin,b.fields.checkout,date,date));
        
        document.getElementById('dayModalBody').innerHTML=dayBookings.length===0?
          '<div class="alert alert-info">No bookings for this day</div>':
          dayBookings.map(b=>{
            const g=b.fields;
            return `<div class="modal-event">
              <div><strong>${g.name||'Unnamed Guest'}</strong></div>
              <div>Room: ${g.room}</div>
              <div>Dates: ${helpers.formatDate(g.checkin)} to ${helpers.formatDate(g.checkout)}</div>
              <div>Mobile: ${g.mobile||'Not provided'}</div>
            </div>`;
          }).join('');
        
        modal.show();
      },
      
      async getGuestOrders(guestID) {
        const data=await helpers.fetchAirtable(`${config.airtable.tables.orders}?filterByFormula=AND({Guest}='${guestID}',{Status}!='Cancelled')`);
        return data.records;
      },
      
      async createFoodBill(guestRecordId,guestDetails,orders) {
        let total=0;
        const items=orders.flatMap(o=>{
          const i=JSON.parse(o.fields.Items||'[]');
          const t=o.fields.TotalAmount||i.reduce((s,it)=>s+(it.price||0)*(it.quantity||1),0);
          total+=t;
          return i.map(it=>({item:it.name||'Unspecified item',amount:(it.price||0)*(it.quantity||1),date:o.fields.createdAt||new Date().toISOString()}));
        });

        await helpers.fetchAirtable(config.airtable.tables.bills,{
          method:'POST',
          body:JSON.stringify({
            fields:{
              billID:`BIL-${Date.now().toString().slice(-6)}`,
              guestID:[guestRecordId],
              totalAmount:total,
              status:"Pending",
              orderDetails:JSON.stringify(items)
            }
          })
        });

        return{guest:guestDetails,orders:items,totalAmount:total};
      },
      
      downloadBillAsImage() {
        const bill=document.querySelector('.bill-details');
        if(!bill) return alert('No bill generated');
        html2canvas(bill).then(canvas=>{
          const a=document.createElement('a');
          a.download='food-bill.png';
          a.href=canvas.toDataURL();
          a.click();
        });
      },
      
      generateEmailBody(g,l) {
        return `Hi ${g.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu. 

Your booking for ${g.room} for ${helpers.formatDate(g.checkin)} is confirmed with advance payment of â‚¹${g.advanceAmount||0} (non-refundable), balance â‚¹${g.balanceAmount||0} to be transferred on arrival.

Check-in : ${helpers.formatDate(g.checkin)} 1pm || Check Out: ${helpers.formatDate(g.checkout)} 11am

Please follow the below link for CheckIn instructions and other important info:
${l}

Please share your Id's for the record purpose & feel free to get in touch anytime in case you have any queries or need any assistance. 

Hope you have a great time !! 

Thanks, 
Prateek & Ishika 
OCB Stays, Curated with Love..`;
      },
      
      generateWhatsappMessage(g,l) {
        return `Hi ${g.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu.
Please follow the below link:
${l}

Cheers,
Team OCB Stays`;
      },
      
      initCalendar() {
        flatpickr("#dateRange",{
          mode:"range",
          minDate:"today",
          dateFormat:"Y-m-d",
          onChange:s=>{if(s.length===2)document.getElementById('checkAvailability').click();}
        });
      }
    };

    const handlers = {
      async registerGuest(e) {
        e.preventDefault();
        const btn=e.target.querySelector('button[type="submit"]')||e.target;
        btn.disabled=true;
        helpers.toggleSpinner('registerSpinner',true);
        
        try {
          const dates=document.getElementById('dateRange').value;
          if(!dates) throw new Error('Please select dates');
          
          const [ci,co]=dates.split(' to ');
          const fd={
            room:document.getElementById('room').value,
            checkin:ci,
            checkout:co,
            name:document.getElementById('name').value,
            mobile:document.getElementById('mobile').value,
            advanceAmount:document.getElementById('advanceAmount').value||0,
            balanceAmount:document.getElementById('balanceAmount').value||0
          };
          
          const gid=helpers.generateGuestId();
          const link=`${config.urls.guestPortal}?guestID=${gid}&room=${encodeURIComponent(fd.room)}`;
          
          const res=await helpers.fetchAirtable(config.airtable.tables.guests,{
            method:'POST',
            body:JSON.stringify({
              fields:{
                ...fd,
                guestID:gid,
                status:"Active",
                homeLink:link,
                advanceAmount:parseFloat(fd.advanceAmount),
                balanceAmount:parseFloat(fd.balanceAmount)
              }
            })
          });

          if(!res.id) throw new Error('Failed to create guest record');
          
          document.getElementById('linkOutput').innerHTML=`
            <div class="alert alert-success">Guest registered successfully! Record ID: ${res.id}</div>
            <div class="input-group-copy">
              <input type="text" class="form-control" value="${link}" readonly>
              <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('${link}');alert('Copied!')">ðŸ“‹ Copy</button>
            </div>
          `;
          
          const guest={...fd,guestID:gid};
          document.getElementById('sendEmailBtn').onclick=()=>window.open(
            `mailto:?subject=OCB Stays Booking Confirmation&body=${encodeURIComponent(app.generateEmailBody(guest,link))}`
          );
          document.getElementById('sendWhatsappBtn').onclick=()=>window.open(
            `https://wa.me/?text=${encodeURIComponent(app.generateWhatsappMessage(guest,link))}`
          );
          document.getElementById('sendEmailBtn').disabled=false;
          document.getElementById('sendWhatsappBtn').disabled=false;
          
          await Promise.all([
            app.loadActiveGuests(),
            app.loadAvailableRooms(),
            app.loadGuestList('today-guests-list',`AND(OR(AND({checkin}<='${new Date().toISOString().split('T')[0]}',{checkout}>='${new Date().toISOString().split('T')[0]}'),{checkin}='${new Date().toISOString().split('T')[0]}',{checkout}='${new Date().toISOString().split('T')[0]}'),{status}="Active")`),
            app.loadGuestList('upcoming-guests-list',`AND({checkin}>'${new Date().toISOString().split('T')[0]}',{status}="Active")`),
            app.generateCalendarView()
          ]);
        } catch(e){console.error(e);helpers.showAlert('linkOutput',`Error:${e.message}`,'danger');}
        finally{btn.disabled=false;helpers.toggleSpinner('registerSpinner',false);}
      },
      
      async generateBill() {
        const sel=document.getElementById('guestSelect');
        const btn=document.getElementById('generateBill');
        if(!sel||!sel.value) return helpers.showAlert('billOutput','Please select a guest','danger');
        
        btn.disabled=true;
        helpers.toggleSpinner('billSpinner',true);
        document.getElementById('billOutput').innerHTML='<div class="alert alert-info">Generating food bill...</div>';
        
        try {
          const g=JSON.parse(sel.options[sel.selectedIndex].dataset.guest);
          const orders=await app.getGuestOrders(g.guestID);
          if(!orders.length) return helpers.showAlert('billOutput','No food orders found','warning');
          
          const bill=await app.createFoodBill(sel.value,g,orders);
          
          let html=bill.orders.map(o=>`
            <div class="order-item">
              <span>${o.item}</span>
              <span>â‚¹${o.amount.toFixed(2)}</span>
            </div>
          `).join('');
          
          html+=`
            <div class="order-total">
              <span>Total:</span>
              <span>â‚¹${bill.totalAmount.toFixed(2)}</span>
            </div>
          `;
          
          document.getElementById('billOutput').innerHTML=`
            <div class="alert alert-success">Food bill generated!</div>
            <div class="bill-details">
              <h5>Guest: ${bill.guest.name||'Unnamed'} (${bill.guest.guestID})</h5>
              <h6>Order Items:</h6>
              ${html}
            </div>
            <div class="action-buttons mt-3">
              <div class="action-icon download-icon" onclick="app.downloadBillAsImage()" title="Download Bill">
                <i class="fas fa-download"></i>
              </div>
            </div>
          `;
        } catch(e){console.error(e);helpers.showAlert('billOutput',`Error:${e.message}`,'danger');}
        finally{btn.disabled=false;helpers.toggleSpinner('billSpinner',false);}
      },
      
      async checkoutGuest() {
        const gid=document.getElementById('guestSelect').value;
        if(!gid||!confirm('Are you sure you want to check out this guest?')) return;
        
        const btn=document.getElementById('checkoutGuest');
        btn.disabled=true;
        helpers.toggleSpinner('checkoutSpinner',true);
        
        try {
          await helpers.fetchAirtable(`${config.airtable.tables.guests}/${gid}`,{
            method:'PATCH',
            body:JSON.stringify({fields:{status:"Checked Out"}})
          });
          
          helpers.showAlert('billOutput','Guest checked out successfully');
          document.getElementById('selectedGuestInfo').style.display='none';
          await Promise.all([
            app.loadActiveGuests(),
            app.loadGuestList('today-guests-list',`AND(OR(AND({checkin}<='${new Date().toISOString().split('T')[0]}',{checkout}>='${new Date().toISOString().split('T')[0]}'),{checkin}='${new Date().toISOString().split('T')[0]}',{checkout}='${new Date().toISOString().split('T')[0]}'),{status}="Active")`),
            app.loadGuestList('upcoming-guests-list',`AND({checkin}>'${new Date().toISOString().split('T')[0]}',{status}="Active")`),
            app.generateCalendarView()
          ]);
        } catch(e){console.error(e);helpers.showAlert('billOutput',`Error:${e.message}`,'danger');}
        finally{btn.disabled=false;helpers.toggleSpinner('checkoutSpinner',false);}
      },
      
      setupGuestSelection() {
        const sel=document.getElementById('guestSelect');
        if(!sel) return;
        
        sel.addEventListener('change',function() {
          const info=document.getElementById('selectedGuestInfo');
          if(!this.value) return info.style.display='none';
          
          const g=JSON.parse(this.options[this.selectedIndex].dataset.guest);
          const link=g.homeLink;
          
          document.getElementById('copyGuestLink').onclick=()=>{
            navigator.clipboard.writeText(link);
            helpers.showAlert('billOutput','Link copied to clipboard!');
          };
          
          document.getElementById('sendEmailToGuest').onclick=()=>window.open(
            `mailto:?subject=OCB Stays Information&body=${encodeURIComponent(app.generateEmailBody(g,link))}`
          );
          
          document.getElementById('sendWhatsappToGuest').onclick=()=>window.open(
            `https://wa.me/${g.mobile}?text=${encodeURIComponent(app.generateWhatsappMessage(g,link))}`
          );
          
          info.style.display='block';
        });
      },
      
      setupPlaceOrder() {
        const btn=document.getElementById('placeOrder');
        if(!btn) return;
        
        btn.addEventListener('click',()=>{
          const sel=document.getElementById('guestSelect');
          if(!sel||!sel.value) return helpers.showAlert('billOutput','Please select a guest','danger');
          
          const g=JSON.parse(sel.options[sel.selectedIndex].dataset.guest);
          window.open(`${config.urls.guestMenu}?guestID=${g.guestID}&room=${encodeURIComponent(g.room)}`,'_blank');
        });
      },
      
      setupContactIcon() {
        const icon=document.getElementById('openContacts');
        if(!icon) return;
        
        icon.addEventListener('click',e=>{
          e.stopPropagation();
          const input=document.getElementById('mobile');
          input.focus();
          
          if(navigator.contacts?.select){
            navigator.contacts.select(['name','tel'],{multiple:false})
              .then(c=>{if(c?.length>0)input.value=c[0].tel?c[0].tel[0]:'';})
              .catch(console.error);
          } else if(typeof input.select==='function') input.select();
        });
      },
      
      setupTabNavigation() {
        document.querySelectorAll('#mainTabs .nav-link').forEach(tab=>{
          tab.addEventListener('click',e=>{
            e.preventDefault();
            const target=tab.dataset.tabTarget;
            
            document.querySelectorAll('.main-content > div').forEach(c=>c.style.display='none');
            document.getElementById(`${target}-content`).style.display='block';
            
            document.querySelectorAll('#mainTabs .nav-link').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            
            if(target==='dashboard'){
              Promise.all([
                app.loadGuestList('today-guests-list',`AND(OR(AND({checkin}<='${new Date().toISOString().split('T')[0]}',{checkout}>='${new Date().toISOString().split('T')[0]}'),{checkin}='${new Date().toISOString().split('T')[0]}',{checkout}='${new Date().toISOString().split('T')[0]}'),{status}="Active")`),
                app.loadGuestList('upcoming-guests-list',`AND({checkin}>'${new Date().toISOString().split('T')[0]}',{status}="Active")`),
                app.generateCalendarView()
              ]);
            } else if(target==='manage') app.loadActiveGuests();
          });
        });
      },
      
      setupAutoFocus() {
        document.querySelectorAll('input,select').forEach(input=>{
          input.addEventListener('change',function(){if(this.value)helpers.focusNextInput(this);});
          input.addEventListener('keypress',function(e){if(e.key==='Enter')helpers.focusNextInput(this);});
        });
      }
    };

    window.addEventListener('DOMContentLoaded',async()=>{
      document.getElementById('guestForm')?.addEventListener('submit',handlers.registerGuest);
      document.getElementById('generateBill')?.addEventListener('click',handlers.generateBill);
      document.getElementById('checkoutGuest')?.addEventListener('click',handlers.checkoutGuest);
      handlers.setupGuestSelection();
      handlers.setupPlaceOrder();
      handlers.setupContactIcon();
      document.getElementById('checkAvailability')?.addEventListener('click',app.checkRoomAvailability);
      document.getElementById('propertyFilter')?.addEventListener('change',()=>app.generateCalendarView(document.getElementById('propertyFilter').value));
      handlers.setupTabNavigation();
      handlers.setupAutoFocus();
      
      app.initCalendar();
      
      await Promise.all([
        app.loadGuestList('today-guests-list',`AND(OR(AND({checkin}<='${new Date().toISOString().split('T')[0]}',{checkout}>='${new Date().toISOString().split('T')[0]}'),{checkin}='${new Date().toISOString().split('T')[0]}',{checkout}='${new Date().toISOString().split('T')[0]}'),{status}="Active")`),
        app.loadGuestList('upcoming-guests-list',`AND({checkin}>'${new Date().toISOString().split('T')[0]}',{status}="Active")`),
        app.generateCalendarView()
      ]);
      
      window.app=app;
    });
  </script>
</body>
</html>

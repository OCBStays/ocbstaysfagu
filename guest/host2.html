<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays â€“ Host Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #64748b;
      --accent: #f59e0b;
      --dark: #1e293b;
      --light: #f8fafc;
      --danger: #ef4444;
      --success: #22c55e;
      --border-radius: 12px;
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.25);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #2b4162;
      color: var(--dark);
      line-height: 1.6;
      padding: 1.5rem;
      max-width: 1200px;
      margin: auto;
      padding-bottom: 80px;
      min-height: 100vh;
      font-weight: 400;
    }

    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .action-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      font-size: 1.1rem;
      border-radius: 50%;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    .email-icon { background-color: #3498db; color: white; }
    .whatsapp-icon { background-color: #25D366; color: white; }
    .copy-icon { background-color: #6c757d; color: white; }
    .food-icon { background-color: #ff6b6b; color: white; }
    .call-icon { background-color: #4caf50; color: white; }
    .contact-icon { 
      color: #6c757d; 
      cursor: pointer; 
      margin-left: 0.5rem;
      font-size: 1.5rem;
      padding: 0.5rem;
    }
    .input-group-copy { margin-bottom: 0.5rem; }
    .compact-btn { padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.5rem; }
    .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
    .mobile-input-group { display: flex; align-items: center; }
    .mobile-input-group input { flex: 1; }
    /* Calendar styling */
    .flatpickr-input {
      background-color: white;
    }
    .availability-status {
      margin-top: 1rem;
      font-weight: bold;
    }
    .available {
      color: #28a745;
    }
    .unavailable {
      color: #dc3545;
    }
    /* Fixed footer tabs */
    .footer-tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.08);
      z-index: 1000;
      padding: 0.5rem 1rem;
    }
    .footer-tabs .nav-link {
      padding: 0.75rem 1rem;
      color: #6c757d;
      transition: all 0.2s;
      border-radius: 8px;
      margin: 0 0.25rem;
    }
    .footer-tabs .nav-link:hover {
      background: rgba(0,0,0,0.04);
    }
    .footer-tabs .nav-link.active {
      background: #0d6efd;
      color: white;
    }
    /* Guest cards */
    .guest-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .guest-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--glass-shadow);
    }

    .guest-card h5 {
      margin-bottom: 0.5rem;
    }
    .guest-meta {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }
    /* Date fields in one row */
    .date-fields-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    .date-fields-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    /* Fix for contact button */
    .contact-button-wrapper {
      display: flex;
      align-items: center;
    }
    .contact-button-wrapper input {
      flex: 1;
    }
    .contact-button-wrapper .contact-icon {
      margin-left: 0.5rem;
      cursor: pointer;
      padding: 0.5rem;
      background: #f0f0f0;
      border-radius: 50%;
    }
    /* New calendar styles */
    .month-calendar {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .month-title {
      font-weight: bold;
      font-size: 1.2rem;
    }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      color: #6c757d;
    }
    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.2rem;
    }
    .calendar-day {
      position: relative;
      padding: 0.5rem;
      min-height: 80px;
    }

    .calendar-day .day-events {
      position: absolute;
      bottom: 0.5rem;
      left: 0.5rem;
      right: 0.5rem;
    }
    
    .calendar-day {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      transition: all 0.2s;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.25rem;
      border: 1px solid #f0f0f0;
    }

    .calendar-day:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 0.1rem;
    }
    .day-events {
      font-size: 0.5rem;
      text-align: center;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .day-event-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin: 0 1px;
    }
    .past-day {
      background-color: #f8f9fa;
      color: #adb5bd;
    }
    .today {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1976d2;
      font-weight: bold;
      border: 2px solid #1976d2;
    }
    .booked-day {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    .available-day {
      background-color: #ffffff;
      color: #495057;
    }
    .selected-day {
      background-color: #bbdefb;
      color: #0d47a1;
      font-weight: bold;
    }
    /* Modal styles */
    .modal-day-header {
      font-weight: bold;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    .modal-event {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      background-color: #f5f5f5;
    }
    .modal-event:hover {
      background-color: #e0f7fa;
      cursor: pointer;
    }
    /* Scrollable dashboard */
    .dashboard-scrollable {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .dashboard-section {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      transition: all 0.2s ease;
      margin-bottom: 1.5rem;
    }

    .dashboard-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--glass-shadow);
    }

    .dashboard-section h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .compact-action-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    .guest-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .guest-actions {
      display: flex;
      gap: 0.25rem;
    }
    .manage-guest-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .guest-details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .detail-item {
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .detail-label {
      font-weight: bold;
      font-size: 0.8rem;
      color: #6c757d;
    }
    .detail-value {
      margin-top: 0.25rem;
    }
    .edit-icon-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      cursor: pointer;
      color: #6c757d;
      transition: color 0.2s;
    }
    .edit-icon-btn:hover {
      color: #0d6efd;
    }
    .compact-guest-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
    }
    .compact-guest-info {
      flex: 1;
    }
    .compact-guest-actions {
      display: flex;
      gap: 0.25rem;
    }
    .compact-meta {
      font-size: 0.8rem;
      color: #6c757d;
    }

    /* Manage tab sub-navigation */
    .manage-subnav {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .manage-subnav .nav-link {
      padding: 1rem 1.5rem;
      color: var(--secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .manage-subnav .nav-link.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* New styles for payment tracking */
    .payment-progress {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      margin: 1rem 0;
      overflow: hidden;
    }

    .payment-progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--success) var(--paid-percent), var(--danger) var(--paid-percent));
      transition: width 0.3s ease;
    }

    .payment-summary {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    /* Food orders section */
    .food-orders-section {
      margin-top: 1.5rem;
      cursor: pointer;
      padding: 1rem;
      border-radius: var(--border-radius);
      background: rgba(0,0,0,0.03);
      transition: all 0.2s ease;
    }

    .food-orders-section:hover {
      background: rgba(0,0,0,0.05);
    }

    .food-order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Loading state improvements */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.5);
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
    }

    .loading-text {
      margin-top: 1rem;
      color: #2d3748;
      font-weight: 500;
    }

    /* Override Bootstrap spinner */
    .spinner-border {
      width: 2rem;
      height: 2rem;
      border-width: 0.25em;
      color: var(--primary);
    }

    /* Improve text readability */
    h1, h2, h3, h4, h5, h6 {
      color: #1a202c;
      font-weight: 600;
    }

    .form-label {
      color: #2d3748;
      font-weight: 500;
    }

    /* Flatpickr calendar styling */
    .flatpickr-calendar {
        background: var(--glass-bg) !important;
        border: 1px solid var(--glass-border) !important;
        box-shadow: var(--glass-shadow) !important;
        border-radius: var(--border-radius) !important;
        font-family: inherit !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
    }

    .flatpickr-day {
        border-radius: 8px !important;
        font-weight: 500 !important;
    }

    .flatpickr-day.selected {
        background: var(--primary) !important;
        border-color: var(--primary) !important;
    }

    .flatpickr-day.today {
        border-color: var(--primary) !important;
    }

    .flatpickr-months .flatpickr-month {
        background: transparent !important;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months {
        background: transparent !important;
    }

    .flatpickr-weekdays {
        background: transparent !important;
    }

    .flatpickr-weekday {
        background: transparent !important;
        color: var(--dark) !important;
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">OCB Stays â€“ Host Dashboard</h1>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Dashboard Tab Content (default) -->
    <div id="dashboard-content">
      <div class="dashboard-scrollable">
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-day"></i> Today's Guests</h2>
          <div id="today-guests-list">
            <div class="loading-container">
              <div class="spinner-border text-primary" role="status"></div>
              <div class="loading-text">Loading guests...</div>
            </div>
          </div>
        </div>
        
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-week"></i> Upcoming Guests</h2>
          <div id="upcoming-guests-list">
            <div class="loading-container">
              <div class="spinner-border text-primary" role="status"></div>
              <div class="loading-text">Loading upcoming guests...</div>
            </div>
          </div>
        </div>
        
        <div class="dashboard-section">
          <h2><i class="fas fa-calendar-alt"></i> Booking Calendar</h2>
          <div class="mb-3">
            <select class="form-select" id="propertyFilter">
              <option value="all">All Properties</option>
              <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
              <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
              <option value="A Frame Cottage">A Frame Cottage</option>
            </select>
          </div>
          <div id="property-calendar-view">
            <div class="loading-container">
              <div class="spinner-border text-primary" role="status"></div>
              <div class="loading-text">Loading calendar...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Register Tab Content (hidden by default) -->
    <div id="register-content" style="display: none;">
      <form id="guestForm">
        <!-- Date Selection Section -->
        <div class="date-selection mb-3">
          <h5>Select Dates</h5>
          <div class="mb-3">
            <input type="text" class="form-control flatpickr-input" id="dateRange" placeholder="Select check-in and check-out dates" required>
          </div>
          <div id="availabilityStatus" class="availability-status"></div>
        </div>
        
        <div class="mb-3">
          <label for="room" class="form-label">Room</label>
          <select class="form-select" id="room" required disabled>
            <option value="">First select dates to see available rooms</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
          <label for="mobile" class="form-label">Mobile Number</label>
          <div class="contact-button-wrapper">
            <input type="tel" class="form-control" id="mobile" required>
            <i class="fas fa-address-book contact-icon" id="openContacts" style="cursor: pointer;"></i>
          </div>
        </div>
        <div class="mb-3">
          <label for="advanceAmount" class="form-label">Advance Payment (â‚¹)</label>
          <input type="number" class="form-control" id="advanceAmount">
        </div>
        <div class="mb-3">
          <label for="balanceAmount" class="form-label">Balance Amount (â‚¹)</label>
          <input type="number" class="form-control" id="balanceAmount">
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary" id="registerBtn">
            Register
            <span id="registerSpinner" class="loading-spinner" style="display: none;"></span>
          </button>
          <div class="action-icon email-icon" id="sendEmailBtn" disabled title="Send Email">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="action-icon whatsapp-icon" id="sendWhatsappBtn" disabled title="Send WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </div>
        </div>
      </form>
      <div id="linkOutput" class="mt-3"></div>
    </div>
    
    <!-- Manage Tab Content (hidden by default) -->
    <div id="manage-content" style="display: none;">
      <!-- Sub navigation -->
      <ul class="nav manage-subnav" id="manageSubnav">
        <li class="nav-item">
          <a class="nav-link active" href="#active-guests">Active Guests</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#past-guests">Past Guests</a>
        </li>
      </ul>

      <!-- Active Guests Section -->
      <div id="active-guests" class="manage-section">
        <div class="mb-3">
          <label for="guestSelect" class="form-label">Select Active Guest</label>
          <select class="form-select" id="guestSelect">
            <option value="">Select Guest</option>
          </select>
        </div>
        <div id="selectedGuestInfo" style="display: none;">
          <div class="guest-card position-relative">
            <i class="fas fa-edit edit-icon-btn" id="editGuestBtn"></i>
            <div id="guestDetailsContent">
              <!-- Guest details will be loaded here -->
            </div>
          </div>
          <div class="action-buttons mt-3">
            <a class="action-icon call-icon" id="callGuest" title="Call Guest">
              <i class="fas fa-phone"></i>
            </a>
            <div class="action-icon whatsapp-icon" id="sendWhatsappToGuest" title="Send WhatsApp">
              <i class="fab fa-whatsapp"></i>
            </div>
            <div class="action-icon email-icon" id="sendEmailToGuest" title="Send Email">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="action-icon copy-icon" id="copyGuestLink" title="Copy Link">
              <i class="fas fa-copy"></i>
            </div>
          </div>
          <div class="action-buttons mt-3">
            <div class="action-icon food-icon" id="placeOrder" title="Place Food Order">
              <i class="fas fa-utensils"></i>
            </div>
            <button id="generateBill" class="btn btn-secondary compact-btn">
              <i class="fas fa-file-invoice"></i> Bill
              <span id="billSpinner" class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="checkoutGuest" class="btn btn-danger compact-btn">
              <i class="fas fa-sign-out-alt"></i> Checkout
              <span id="checkoutSpinner" class="loading-spinner" style="display: none;"></span>
            </button>
          </div>
          <div id="billOutput" class="mt-3"></div>
        </div>
      </div>

      <!-- Past Guests Section -->
      <div id="past-guests" class="manage-section" style="display: none;">
        <div class="mb-3">
          <label for="pastGuestSelect" class="form-label">Select Past Guest</label>
          <select class="form-select" id="pastGuestSelect">
            <option value="">Select Guest</option>
          </select>
        </div>
        <div id="selectedPastGuestInfo" style="display: none;">
          <div class="guest-card position-relative">
            <div id="pastGuestDetailsContent">
              <!-- Past guest details will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Day Modal -->
  <div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dayModalTitle">Day Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="dayModalBody">
          Loading...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Guest Modal -->
  <div class="modal fade" id="editGuestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Guest Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editGuestForm">
            <div class="mb-3">
              <label for="editName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="mb-3">
              <label for="editMobile" class="form-label">Mobile Number</label>
              <input type="tel" class="form-control" id="editMobile" required>
            </div>
            <div class="mb-3">
              <label for="editRoom" class="form-label">Room</label>
              <select class="form-select" id="editRoom" required>
                <option value="">Select Room</option>
                <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
                <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
                <option value="A Frame Cottage">A Frame Cottage</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editCheckin" class="form-label">Check-in Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckin" required>
            </div>
            <div class="mb-3">
              <label for="editCheckout" class="form-label">Check-out Date</label>
              <input type="text" class="form-control flatpickr-input" id="editCheckout" required>
            </div>
            <div class="mb-3">
              <label for="editAdvance" class="form-label">Advance Payment (â‚¹)</label>
              <input type="number" class="form-control" id="editAdvance">
            </div>
            <div class="mb-3">
              <label for="editBalance" class="form-label">Balance Amount (â‚¹)</label>
              <input type="number" class="form-control" id="editBalance">
            </div>
            <input type="hidden" id="editGuestId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveGuestChanges">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed Footer Tabs -->
  <div class="footer-tabs">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dashboard-tab" data-tab-target="dashboard" type="button" role="tab">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="register-footer-tab" data-tab-target="register" type="button" role="tab">
          <i class="fas fa-user-plus"></i> Register
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="manage-footer-tab" data-tab-target="manage" type="button" role="tab">
          <i class="fas fa-users-cog"></i> Manage
        </button>
      </li>
    </ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const handlers = {
      async registerGuest(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]') || e.target;
        btn.disabled = true;
        helpers.toggleSpinner('registerSpinner', true);
        
        try {
          const dateRange = document.getElementById('dateRange').value;
          if (!dateRange) throw new Error('Please select dates');
          
          const [checkin, checkout] = dateRange.split(' to ');
          const formData = {
            room: document.getElementById('room').value,
            checkin,
            checkout,
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            advanceAmount: document.getElementById('advanceAmount').value || 0,
            balanceAmount: document.getElementById('balanceAmount').value || 0
          };
          
          const guestID = helpers.generateGuestId();
          const homeLink = `${config.urls.guestPortal}?guestID=${guestID}&room=${encodeURIComponent(formData.room)}`;
          
          const response = await helpers.fetchAirtable(config.airtable.tables.guests, {
            method: 'POST',
            body: JSON.stringify({
              fields: {
                ...formData,
                guestID,
                status: "Active",
                homeLink,
                advanceAmount: parseFloat(formData.advanceAmount),
                balanceAmount: parseFloat(formData.balanceAmount)
              }
            })
          });

          if (!response.id) throw new Error('Failed to create guest record');
          
          document.getElementById('linkOutput').innerHTML = `
            <div class="alert alert-success">Guest registered successfully!</div>
            <div class="input-group-copy">
              <input type="text" class="form-control" value="${homeLink}" readonly>
              <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('${homeLink}');alert('Copied!')">ðŸ“‹ Copy</button>
            </div>
          `;
          
          const guest = { ...formData, guestID };
          document.getElementById('sendEmailBtn').onclick = () => window.open(
            `mailto:?subject=OCB Stays Booking Confirmation&body=${encodeURIComponent(app.generateEmailBody(guest, homeLink))}`
          );
          document.getElementById('sendWhatsappBtn').onclick = () => window.open(
            app.generateWhatsappLink(guest.mobile, app.generateWhatsappMessage(guest, homeLink))
          );
          document.getElementById('sendEmailBtn').disabled = false;
          document.getElementById('sendWhatsappBtn').disabled = false;
          
          await app.loadActiveGuests();
          await app.loadAvailableRooms();
          await app.loadTodaysGuests();
          await app.loadUpcomingGuests();
          await app.generateCalendarView();
        } catch (error) {
          console.error("Registration error:", error);
          helpers.showAlert('linkOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('registerSpinner', false);
        }
      },

      async generateBill() {
        const guestSelect = document.getElementById('guestSelect');
        if (!guestSelect.value) {
          return helpers.showAlert('billOutput', 'Please select a guest', 'danger');
        }
        
        const guestData = JSON.parse(guestSelect.options[guestSelect.selectedIndex].dataset.guest);
        const btn = document.getElementById('generateBill');
        btn.disabled = true;
        helpers.toggleSpinner('billSpinner', true);
        
        try {
          const orders = await app.getGuestOrders(guestData.guestID);
          if (!orders.length) {
            return helpers.showAlert('billOutput', 'No food orders found', 'warning');
          }
          
          const billHTML = await app.generateBill(guestData, orders);
          document.getElementById('billOutput').innerHTML = `
            <div class="alert alert-success">Bill generated successfully!</div>
            ${billHTML}
            <div class="action-buttons mt-3">
              <button class="btn btn-primary" onclick="app.downloadBillAsImage()">
                <i class="fas fa-download"></i> Download Bill
              </button>
            </div>
          `;
        } catch (error) {
          console.error("Bill generation error:", error);
          helpers.showAlert('billOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('billSpinner', false);
        }
      },

      async checkoutGuest() {
        const guestSelect = document.getElementById('guestSelect');
        const guest = JSON.parse(guestSelect.options[guestSelect.selectedIndex].dataset.guest);
        
        app.showCheckoutConfirmation(guest, async (paymentDetails) => {
          try {
            await helpers.fetchAirtable(`${config.airtable.tables.guests}/${guestSelect.value}`, {
              method: 'PATCH',
              body: JSON.stringify({
                fields: {
                  status: "Checked Out",
                  balanceAmount: paymentDetails.balanceAmount,
                  PaymentStatus: paymentDetails.status,
                  PaymentType: paymentDetails.type,
                  PaymentTo: paymentDetails.paymentTo
                }
              })
            });
            
            helpers.showAlert('billOutput', 'Guest checked out successfully');
            await app.loadActiveGuests();
            await app.loadTodaysGuests();
            await app.loadUpcomingGuests();
            document.getElementById('selectedGuestInfo').style.display = 'none';
          } catch (error) {
            console.error("Checkout error:", error);
            helpers.showAlert('billOutput', `Error: ${error.message}`, 'danger');
          }
        });
      },
      
      setupTabNavigation() {
        document.querySelectorAll('.main-content > div').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById('dashboard-content').style.display = 'block';

        document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
          tab.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelectorAll('.main-content > div').forEach(content => {
              content.style.display = 'none';
            });
            const target = tab.dataset.tabTarget;
            document.getElementById(`${target}-content`).style.display = 'block';
            document.querySelectorAll('#mainTabs .nav-link').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
          });
        });
      },

      async setupGuestSelection() {
        const guestSelect = document.getElementById('guestSelect');
        const pastGuestSelect = document.getElementById('pastGuestSelect');

        if (guestSelect) {
          guestSelect.addEventListener('change', async function() {
            const guestInfoDiv = document.getElementById('selectedGuestInfo');
            if (!this.value) {
              guestInfoDiv.style.display = 'none';
              return;
            }

            const guest = JSON.parse(this.options[this.selectedIndex].dataset.guest);
            const homeLink = guest.homeLink;

            // Show loading state
            document.getElementById('guestDetailsContent').innerHTML = `
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status"></div>
                <div>Loading guest details...</div>
              </div>
            `;
            guestInfoDiv.style.display = 'block';

            try {
              // Calculate food total
              const foodTotal = await app.calculateFoodTotal(guest.guestID);
              // Calculate nights
              const nights = helpers.calculateNights(guest.checkin, guest.checkout);

              // Render guest details
              document.getElementById('guestDetailsContent').innerHTML = `
                <h5>${guest.name || 'Unnamed Guest'}</h5>
                <div class="guest-details-grid">
                  <div class="detail-item">
                    <div class="detail-label">Room</div>
                    <div class="detail-value">${guest.room}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Mobile</div>
                    <div class="detail-value">${guest.mobile || 'Not provided'}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Check-in</div>
                    <div class="detail-value">${helpers.formatDate(guest.checkin)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Check-out</div>
                    <div class="detail-value">${helpers.formatDate(guest.checkout)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Nights</div>
                    <div class="detail-value">${nights}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Advance Paid</div>
                    <div class="detail-value">â‚¹${guest.advanceAmount || 0}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Balance Due</div>
                    <div class="detail-value">â‚¹${guest.balanceAmount || 0}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Food Orders</div>
                    <div class="detail-value">â‚¹${foodTotal}</div>
                  </div>
                </div>
              `;

              // Setup action buttons
              document.getElementById('copyGuestLink').onclick = () => {
                navigator.clipboard.writeText(homeLink);
                helpers.showAlert('billOutput', 'Link copied to clipboard!');
              };
              document.getElementById('sendEmailToGuest').onclick = () => window.open(
                `mailto:?subject=OCB Stays Information&body=${encodeURIComponent(app.generateEmailBody(guest, homeLink))}`
              );
              document.getElementById('sendWhatsappToGuest').onclick = () => window.open(
                `https://wa.me/${guest.mobile}?text=${encodeURIComponent(app.generateWhatsappMessage(guest, homeLink))}`
              );
              document.getElementById('callGuest').href = `tel:${guest.mobile}`;
            } catch (error) {
              console.error('Error loading guest details:', error);
              document.getElementById('guestDetailsContent').innerHTML = `
                <div class="alert alert-danger">Failed to load guest details</div>
              `;
            }
          });
        }

        if (pastGuestSelect) {
          pastGuestSelect.addEventListener('change', function() {
            const pastGuestInfoDiv = document.getElementById('selectedPastGuestInfo');
            if (!this.value) {
              pastGuestInfoDiv.style.display = 'none';
              return;
            }

            const guest = JSON.parse(this.options[this.selectedIndex].dataset.guest);
            document.getElementById('pastGuestDetailsContent').innerHTML = `
              <h5>${guest.name || 'Unnamed Guest'}</h5>
              <div class="guest-details-grid">
                <div class="detail-item">
                  <div class="detail-label">Room</div>
                  <div class="detail-value">${guest.room}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Mobile</div>
                  <div class="detail-value">${guest.mobile || 'Not provided'}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Check-in</div>
                  <div class="detail-value">${helpers.formatDate(guest.checkin)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Check-out</div>
                  <div class="detail-value">${helpers.formatDate(guest.checkout)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Nights</div>
                  <div class="detail-value">${helpers.calculateNights(guest.checkin, guest.checkout)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Advance Paid</div>
                  <div class="detail-value">â‚¹${guest.advanceAmount || 0}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Balance Due</div>
                  <div class="detail-value">â‚¹${guest.balanceAmount || 0}</div>
                </div>
              </div>
            `;
            pastGuestInfoDiv.style.display = 'block';
          });
        }
      },

      // Configuration
      config = {
        airtable: {
          token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
          baseId: 'app2UvEfKduRwGjfR',
          tables: {
            guests: 'Guests',
            bills: 'Bills',
            orders: 'Orders'
          }
        },
        urls: {
          guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
          guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
        },
        rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"]
      };

    // Helper functions 
    const helpers = {
      generateGuestId: () => 'GST' + Array.from({length: 5}, () => 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      
      formatDate: (dateString) => new Date(dateString).toLocaleDateString('en-US', { 
        month: 'short', day: 'numeric', year: 'numeric' 
      }),
      
      formatShortDate: (dateString) => new Date(dateString).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric'
      }),
      
      fetchAirtable: async (endpoint, options = {}) => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
        try {
          const response = await fetch(url, {
            headers: { 
              'Authorization': `Bearer ${config.airtable.token}`,
              'Content-Type': 'application/json'
            },
            ...options
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error.message || 'API request failed');
          }
          return await response.json();
        } catch (error) {
          console.error('Airtable API error:', error);
          throw error;
        }
      },
      
      toggleSpinner: (elementId, show) => {
        const spinner = document.getElementById(elementId);
        if (spinner) spinner.style.display = show ? 'inline-block' : 'none';
      },
      
      showAlert: (containerId, message, type = 'success') => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} mt-3`;
        alert.textContent = message;
        container.prepend(alert);
        setTimeout(() => alert.remove(), 5000);
      },
      
      datesOverlap: (start1, end1, start2, end2) => {
        const d1 = new Date(start1);
        const d2 = new Date(end1);
        const d3 = new Date(start2);
        const d4 = new Date(end2);
        
        return (d1 < d4) && (d3 < d2);
      },
      
      focusNextInput: (currentInput) => {
        const form = currentInput.closest('form');
        if (!form) return;
        
        const inputs = Array.from(form.querySelectorAll('input, select, textarea'));
        const currentIndex = inputs.indexOf(currentInput);
        if (currentIndex < inputs.length - 1) {
          inputs[currentIndex + 1].focus();
        }
      },
      
      getDaysInMonth: (year, month) => {
        return new Date(year, month + 1, 0).getDate();
      },
      
      getFirstDayOfMonth: (year, month) => {
        return new Date(year, month, 1).getDay();
      },
      
      calculateNights: (checkin, checkout) => {
        const oneDay = 24 * 60 * 60 * 1000;
        const start = new Date(checkin);
        const end = new Date(checkout);
        return Math.round(Math.abs((start - end) / oneDay));
      }
    };

    // Core functions
    const app = {
      async loadAvailableRooms() {
        const roomSelect = document.getElementById('room');
        if (!roomSelect) return;
        
        try {
          roomSelect.disabled = true;
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"`
          );
          const occupiedRooms = new Set(data.records.map(r => r.fields.room));
          
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          config.rooms.forEach(room => {
            if (!occupiedRooms.has(room)) {
              const option = document.createElement('option');
              option.value = room;
              option.textContent = room;
              roomSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error('Error loading rooms:', error);
          roomSelect.innerHTML = '<option value="">Error loading rooms</option>';
        } finally {
          roomSelect.disabled = false;
        }
      },
      
      async checkRoomAvailability() {
        const dateRange = document.getElementById('dateRange').value;
        if (!dateRange) {
          document.getElementById('availabilityStatus').innerHTML = '<span class="unavailable">Please select dates</span>';
          return;
        }
        
        const [checkin, checkout] = dateRange.split(' to ');
        const roomSelect = document.getElementById('room');
        const statusDiv = document.getElementById('availabilityStatus');
        
        statusDiv.innerHTML = '<span>Checking availability...</span>';
        
        try {
          // Get all active bookings
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"`
          );
          
          // Find rooms that are booked during the selected dates
          const bookedRooms = new Set();
          data.records.forEach(record => {
            const guest = record.fields;
            if (helpers.datesOverlap(
              guest.checkin, guest.checkout, 
              checkin, checkout
            )) {
              bookedRooms.add(guest.room);
            }
          });
          
          // Update room select with available rooms
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          let availableCount = 0;
          
          config.rooms.forEach(room => {
            if (!bookedRooms.has(room)) {
              const option = document.createElement('option');
              option.value = room;
              option.textContent = room;
              roomSelect.appendChild(option);
              availableCount++;
            }
          });
          
          if (availableCount === 0) {
            statusDiv.innerHTML = '<span class="unavailable">No rooms available for selected dates</span>';
            roomSelect.disabled = true;
          } else {
            statusDiv.innerHTML = `<span class="available">${availableCount} room(s) available for selected dates</span>`;
            roomSelect.disabled = false;
          }
        } catch (error) {
          console.error('Error checking availability:', error);
          statusDiv.innerHTML = '<span class="unavailable">Error checking availability</span>';
        }
      },
      
      async loadActiveGuests() {
        const guestSelect = document.getElementById('guestSelect');
        const pastGuestSelect = document.getElementById('pastGuestSelect');
        if (!guestSelect || !pastGuestSelect) return;

        try {
          guestSelect.disabled = true;
          pastGuestSelect.disabled = true;
          guestSelect.innerHTML = '<option value="">Loading guests...</option>';
          pastGuestSelect.innerHTML = '<option value="">Loading past guests...</option>';

          // Fetch all guests
          const data = await helpers.fetchAirtable(`${config.airtable.tables.guests}`);
          guestSelect.innerHTML = '<option value="">Select Guest</option>';
          pastGuestSelect.innerHTML = '<option value="">Select Past Guest</option>';

          data.records.forEach(record => {
            const guest = record.fields;
            const option = new Option(
              `${guest.name || 'Unnamed'} (${guest.guestID}) - ${guest.room}`,
              record.id
            );
            option.dataset.guest = JSON.stringify(guest);

            if (guest.status === "Active") {
              guestSelect.add(option.cloneNode(true));
            } else if (guest.status === "Checked Out") {
              pastGuestSelect.add(option.cloneNode(true));
            }
          });
        } catch (error) {
          console.error('Error loading guests:', error);
          helpers.showAlert('billOutput', `Failed to load guests: ${error.message}`, 'danger');
        } finally {
          guestSelect.disabled = false;
          pastGuestSelect.disabled = false;
        }
      },
      
      async loadTodaysGuests() {
        const container = document.getElementById('today-guests-list');
        if (!container) return;
        
        try {
          container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
          
          // Get all active guests
          const formula = `{status}="Active"`;
          
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula=${formula}`
          );
          
          if (data.records.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No guests for today</div>';
            return;
          }
          
          container.innerHTML = '';
          data.records.forEach(record => {
            const guest = record.fields;
            const card = document.createElement('div');
            card.className = 'guest-card compact-guest-card';
            card.innerHTML = `
              <div class="compact-guest-info">
                <div><strong>${guest.name || 'Unnamed Guest'}</strong></div>
                <div class="compact-meta">
                  ${guest.room} â€¢ ${helpers.formatShortDate(guest.checkin)} to ${helpers.formatShortDate(guest.checkout)}
                </div>
              </div>
              <div class="compact-guest-actions">
                <button class="btn btn-sm btn-outline-primary manage-guest-btn" data-guest-id="${record.id}">
                  <i class="fas fa-cog"></i>
                </button>
              </div>
            `;
            container.appendChild(card);
          });
          
          // Add event listeners to manage buttons
          document.querySelectorAll('.manage-guest-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              // Switch to manage tab and select this guest
              document.querySelector('#manage-footer-tab').click();
              setTimeout(() => {
                const guestSelect = document.getElementById('guestSelect');
                guestSelect.value = btn.dataset.guestId;
                guestSelect.dispatchEvent(new Event('change'));
                // Scroll to top of manage section
                document.getElementById('manage-content').scrollIntoView({ behavior: 'smooth' });
              }, 100);
            });
          });
        } catch (error) {
          console.error('Error loading today\'s guests:', error);
          container.innerHTML = '<div class="alert alert-danger">Failed to load today\'s guests</div>';
        }
      },
      
      async loadUpcomingGuests() {
        const today = new Date().toISOString().split('T')[0];
        const container = document.getElementById('upcoming-guests-list');
        if (!container) return;
        
        try {
          container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
          
          // Get upcoming guests (checking in after today)
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula=AND({checkin} > '${today}', {status}="Active")`
          );
          
          if (data.records.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No upcoming guests</div>';
            return;
          }
          
          // Sort by check-in date
          data.records.sort((a, b) => new Date(a.fields.checkin) - new Date(b.fields.checkout));
          
          container.innerHTML = '';
          data.records.forEach(record => {
            const guest = record.fields;
            const daysToCheckin = Math.ceil((new Date(guest.checkin) - new Date()) / (1000 * 60 * 60 * 24));
            
            const card = document.createElement('div');
            card.className = 'guest-card compact-guest-card';
            card.innerHTML = `
              <div class="compact-guest-info">
                <div><strong>${guest.name || 'Unnamed Guest'}</strong></div>
                <div class="compact-meta">
                  ${guest.room} â€¢ ${helpers.formatShortDate(guest.checkin)} â€¢ ${daysToCheckin} days
                </div>
              </div>
              <div class="compact-guest-actions">
                <button class="btn btn-sm btn-outline-primary manage-guest-btn" data-guest-id="${record.id}">
                  <i class="fas fa-cog"></i>
                </button>
              </div>
            `;
            container.appendChild(card);
          });
          
          // Add event listeners to manage buttons
          document.querySelectorAll('.manage-guest-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              // Switch to manage tab and select this guest
              document.querySelector('#manage-footer-tab').click();
              setTimeout(() => {
                const guestSelect = document.getElementById('guestSelect');
                guestSelect.value = btn.dataset.guestId;
                guestSelect.dispatchEvent(new Event('change'));
                // Scroll to top of manage section
                document.getElementById('manage-content').scrollIntoView({ behavior: 'smooth' });
              }, 100);
            });
          });
        } catch (error) {
          console.error('Error loading upcoming guests:', error);
          container.innerHTML = '<div class="alert alert-danger">Failed to load upcoming guests</div>';
        }
      },
      
      async generateCalendarView(propertyFilter = 'all') {
        const container = document.getElementById('property-calendar-view');
        if (!container) return;
        
        try {
          container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
          
          // Get all active bookings
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula={status}="Active"`
          );
          
          // Filter by property if needed
          const bookings = propertyFilter === 'all' 
            ? data.records 
            : data.records.filter(r => r.fields.room === propertyFilter);
          
          // Generate calendar for current month
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
          
          // Create month calendar
          const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
          const daysInMonth = helpers.getDaysInMonth(currentYear, currentMonth);
          const firstDayOfMonth = helpers.getFirstDayOfMonth(currentYear, currentMonth);
          
          let html = `<div class="month-calendar">
            <div class="month-header">
              <div class="month-title">${monthName}</div>
            </div>
            <div class="weekdays">
              <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="days-grid">`;
          
          // Add empty cells for days before the first day of the month
          for (let i = 0; i < firstDayOfMonth; i++) {
            html += `<div class="calendar-day"></div>`;
          }
          
          // Add days of the month
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = dateStr === today.toISOString().split('T')[0];
            
            // Find bookings for this day
            const dayBookings = bookings.filter(b => 
              helpers.datesOverlap(
                b.fields.checkin, 
                b.fields.checkout, 
                dateStr, 
                dateStr
              )
            );
            
            const isBooked = dayBookings.length > 0;
            const dayClass = [
              'calendar-day',
              isToday ? 'today' : '',
              isBooked ? 'booked-day' : 'available-day',
              date < today ? 'past-day' : ''
            ].filter(Boolean).join(' ');
            
            html += `<div class="${dayClass}" data-date="${dateStr}">
              <div class="day-number">${day}</div>
              <div class="day-events">`;
            
            if (isBooked) {
              html += `<span class="day-event-dot" style="background-color: #2e7d32;"></span>`;
              if (dayBookings.length > 1) {
                html += `<span class="day-event-dot" style="background-color: #2e7d32;"></span>`;
              }
            }
            
            html += `</div></div>`;
          }
          
          html += `</div></div>`;
          container.innerHTML = html;
          
          // Add click handlers to days
          document.querySelectorAll('.calendar-day').forEach(day => {
            day.addEventListener('click', () => {
              const date = day.dataset.date;
              if (date) {
                this.showDayDetails(date, bookings);
              }
            });
          });
        } catch (error) {
          console.error('Error generating calendar:', error);
          container.innerHTML = '<div class="alert alert-danger">Failed to load calendar</div>';
        }
      },
      
      async showDayDetails(date, allBookings) {
        const modalTitle = document.getElementById('dayModalTitle');
        const modalBody = document.getElementById('dayModalBody');
        const modal = new bootstrap.Modal(document.getElementById('dayModal'));
        
        modalTitle.textContent = new Date(date).toLocaleDateString('en-US', { 
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        
        // Find bookings for this day
        const dayBookings = allBookings.filter(b => 
          helpers.datesOverlap(
            b.fields.checkin, 
            b.fields.checkout, 
            date, 
            date
          )
        );
        
        if (dayBookings.length === 0) {
          modalBody.innerHTML = '<div class="alert alert-info">No bookings for this day</div>';
        } else {
          modalBody.innerHTML = dayBookings.map(booking => {
            const guest = booking.fields;
            return `
              <div class="modal-event manage-guest-btn" data-guest-id="${booking.id}">
                <div><strong>${guest.name || 'Unnamed Guest'}</strong></div>
                <div>Room: ${guest.room}</div>
                <div>Dates: ${helpers.formatDate(guest.checkin)} to ${helpers.formatDate(guest.checkout)}</div>
                <div>Mobile: ${guest.mobile || 'Not provided'}</div>
              </div>
            `;
          }).join('');
        }
        
        modal.show();
        
        // Add event listeners to manage buttons
        document.querySelectorAll('#dayModalBody .manage-guest-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            // Switch to manage tab and select this guest
            modal.hide();
            document.querySelector('#manage-footer-tab').click();
            setTimeout(() => {
              const guestSelect = document.getElementById('guestSelect');
              guestSelect.value = btn.dataset.guestId;
              guestSelect.dispatchEvent(new Event('change'));
              // Scroll to top of manage section
              document.getElementById('manage-content').scrollIntoView({ behavior: 'smooth' });
            }, 100);
          });
        });
      },
      
      async getGuestOrders(guestID) {
        try {
          const data = await helpers.fetchAirtable(
            `${config.airtable.tables.orders}?filterByFormula=AND({Guest} = '${guestID}', {Status} != 'Cancelled')`
          );
          return data.records;
        } catch (error) {
          console.error('Error fetching orders:', error);
          throw error;
        }
      },
      
      async createFoodBill(guestRecordId, guestDetails, orders) {
        try {
          let totalAmount = 0;
          const allOrderItems = orders.flatMap(order => {
            const items = JSON.parse(order.fields.Items || '[]');
            const orderTotal = order.fields.TotalAmount || 
              items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            totalAmount += orderTotal;
            return items.map(item => ({
              item: item.name || 'Unspecified item',
              amount: (item.price || 0) * (item.quantity || 1),
              date: order.fields.createdAt || new Date().toISOString()
            }));
          });

          const billData = {
            fields: {
              billID: `BIL-${Date.now().toString().slice(-6)}`,
              guestID: [guestRecordId],
              totalAmount: totalAmount,
              status: "Pending",
              orderDetails: JSON.stringify(allOrderItems)
            }
          };

          await helpers.fetchAirtable(config.airtable.tables.bills, {
            method: 'POST',
            body: JSON.stringify(billData)
          });

          return { guest: guestDetails, orders: allOrderItems, totalAmount };
        } catch (error) {
          console.error('Error creating food bill:', error);
          throw error;
        }
      },
      
      downloadBillAsImage() {
        const billDetails = document.querySelector('.bill-details');
        if (!billDetails) return alert('No bill generated to download');
        html2canvas(billDetails).then(canvas => {
          const link = document.createElement('a');
          link.download = 'food-bill.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      },
      
      generateEmailBody(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu. 

Your booking for ${guest.room} for ${helpers.formatDate(guest.checkin)} is confirmed with advance payment of â‚¹${guest.advanceAmount || 0} (non-refundable), balance â‚¹${guest.balanceAmount || 0} to be transferred on arrival.

Check-in : ${helpers.formatDate(guest.checkin)} 1pm || Check Out: ${helpers.formatDate(guest.checkout)} 11am

Please follow the below link for CheckIn instructions and other important info:
${link}

Please share your Id's for the record purpose & feel free to get in touch anytime in case you have any queries or need any assistance. 

Hope you have a great time !! 

Thanks, 
Prateek & Ishika 
OCB Stays, Curated with Love..`;
      },
      
      generateWhatsappMessage(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu.
Please follow the below link:
${link}

Cheers,
Team OCB Stays`;
      },
      
      async loadGuestDetails(guestId) {
        try {
          const response = await helpers.fetchAirtable(
            `${config.airtable.tables.guests}/${guestId}`
          );
          
          if (!response.id) throw new Error('Guest not found');
          return response.fields;
        } catch (error) {
          console.error('Error loading guest details:', error);
          throw error;
        }
      },
      
      async calculateFoodTotal(guestId) {
        try {
          const orders = await this.getGuestOrders(guestId);
          if (!orders.length) return 0;
          
          return orders.reduce((total, order) => {
            return total + (order.fields.TotalAmount || 0);
          }, 0);
        } catch (error) {
          console.error('Error calculating food total:', error);
          return 0;
        }
      },
      
      initCalendar() {
        flatpickr("#dateRange", {
          mode: "range",
          minDate: "today",
          dateFormat: "Y-m-d",
          altFormat: "F j, Y",
          altInput: true,
          animate: true,
          closeOnSelect: false,
          disableMobile: false,
          onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
              app.checkRoomAvailability();
            }
          },
          onOpen: function() {
            document.querySelector('.flatpickr-calendar').style.display = 'block';
          }
        });
        
        flatpickr("#editCheckin", {
          minDate: "today",
          dateFormat: "Y-m-d"
        });
        
        flatpickr("#editCheckout", {
          minDate: "today",
          dateFormat: "Y-m-d"
        });
      },
      
      async generateBill(guestData, orders) {
        const billHeader = `
          <div class="bill-header text-center mb-4">
            <h3>OCB Stays</h3>
            <p>Food Bill</p>
            <div class="guest-info mt-3">
              <p><strong>Guest:</strong> ${guestData.name}</p>
              <p><strong>Room:</strong> ${guestData.room}</p>
              <p><strong>Stay:</strong> ${helpers.formatDate(guestData.checkin)} to ${helpers.formatDate(guestData.checkout)}</p>
            </div>
          </div>
        `;

        // Group items by name and calculate totals
        const itemGroups = orders.reduce((acc, order) => {
          const items = JSON.parse(order.fields.Items || '[]');
          items.forEach(item => {
            if (!acc[item.name]) {
              acc[item.name] = { quantity: 0, amount: 0 };
            }
            acc[item.name].quantity += item.quantity;
            acc[item.name].amount += item.price * item.quantity;
          });
          return acc;
        }, {});

        const itemsHTML = Object.entries(itemGroups).map(([name, data]) => `
          <tr>
            <td>${name}</td>
            <td class="text-center">${data.quantity}</td>
            <td class="text-end">â‚¹${data.amount.toFixed(2)}</td>
          </tr>
        `).join('');

        const totalAmount = Object.values(itemGroups).reduce((sum, item) => sum + item.amount, 0);

        return `
          <div class="bill-details p-4">
            ${billHeader}
            <table class="table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHTML}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="2">Total</th>
                  <th class="text-end">â‚¹${totalAmount.toFixed(2)}</th>
                </tr>
              </tfoot>
            </table>
          </div>
        `;
      },
      
      showCheckoutConfirmation(guest, onConfirm) {
        const modal = new bootstrap.Modal(document.getElementById('checkoutConfirmModal'));
        const modalBody = document.getElementById('checkoutConfirmBody');
        
        modalBody.innerHTML = `
          <div class="mb-3">
            <label class="form-label">Payment Status</label>
            <select class="form-select" id="paymentStatus">
              <option value="Cleared">Cleared</option>
              <option value="Pending">Pending</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Payment Type</label>
            <select class="form-select" id="paymentType">
              <option value="UPI">UPI</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="Net Banking">Net Banking</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Payment Received By</label>
            <select class="form-select" id="paymentTo">
              <option value="Prateek">Prateek</option>
              <option value="Gaurav">Gaurav</option>
              <option value="Uncle">Uncle</option>
            </select>
          </div>
        `;

        document.getElementById('confirmCheckout').onclick = async () => {
          const status = document.getElementById('paymentStatus').value;
          const type = document.getElementById('paymentType').value;
          const paymentTo = document.getElementById('paymentTo').value;

          await onConfirm({
            status,
            type,
            paymentTo,
            balanceAmount: status === 'Cleared' ? 0 : guest.balanceAmount
          });
          
          modal.hide();
        };

        modal.show();
      },
      
      showFoodOrders: async function(guestId) {
        const modal = new bootstrap.Modal(document.getElementById('foodOrdersModal'));
        const modalBody = document.getElementById('foodOrdersBody');
        
        try {
          const orders = await this.getGuestOrders(guestId);
          
          modalBody.innerHTML = `
            <div class="mb-3">
              <select class="form-select" id="orderStatusFilter">
                <option value="all">All Orders</option>
                <option value="Pending">Pending</option>
                <option value="Preparing">Preparing</option>
                <option value="Delivered">Delivered</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div id="ordersList">
              ${orders.map(order => `
                <div class="food-order-item" data-status="${order.fields.Status}">
                  <div>
                    <div class="fw-bold">${new Date(order.fields.createdAt).toLocaleString()}</div>
                    <div>${JSON.parse(order.fields.Items).map(item => 
                      `${item.name} x${item.quantity}`).join(', ')}
                    </div>
                    <div class="text-muted">â‚¹${order.fields.TotalAmount}</div>
                  </div>
                  <select class="form-select form-select-sm" style="width: auto;" 
                    onchange="app.updateOrderStatus('${order.id}', this.value)">
                    <option value="Pending" ${order.fields.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Preparing" ${order.fields.Status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                    <option value="Delivered" ${order.fields.Status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                    <option value="Cancelled" ${order.fields.Status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
              `).join('')}
            </div>
          `;

          // Add filter functionality
          document.getElementById('orderStatusFilter').onchange = function() {
            const status = this.value;
            document.querySelectorAll('#ordersList .food-order-item').forEach(item => {
              item.style.display = 
                status === 'all' || item.dataset.status === status ? 'flex' : 'none';
            });
          };

          modal.show();
        } catch (error) {
          console.error('Error loading orders:', error);
          modalBody.innerHTML = '<div class="alert alert-danger">Failed to load orders</div>';
        }
      },
      
      updateOrderStatus: async function(orderId, status) {
        try {
          await helpers.fetchAirtable(`${config.airtable.tables.orders}/${orderId}`, {
            method: 'PATCH',
            body: JSON.stringify({
              fields: { Status: status }
            })
          });
        } catch (error) {
          console.error('Error updating order status:', error);
          alert('Failed to update order status');
        }
      },
      
      async checkoutGuest() {
        const guestId = document.getElementById('guestSelect').value;
        if (!guestId || !confirm('Are you sure you want to check out this guest?')) return;
        
        const btn = document.getElementById('checkoutGuest');
        btn.disabled = true;
        helpers.toggleSpinner('checkoutSpinner', true);
        
        try {
          await helpers.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`, {
            method: 'PATCH',
            body: JSON.stringify({ fields: { status: "Checked Out" } })
          });
          
          helpers.showAlert('billOutput', 'Guest checked out successfully');
          document.getElementById('selectedGuestInfo').style.display = 'none';
          await app.loadActiveGuests();
          await app.loadTodaysGuests();
          await app.loadUpcomingGuests();
          await app.generateCalendarView();
        } catch (error) {
          console.error("Checkout error:", error);
          helpers.showAlert('billOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('checkoutSpinner', false);
        }
      },
      
      async setupGuestSelection() {
        const guestSelect = document.getElementById('guestSelect');
        const pastGuestSelect = document.getElementById('pastGuestSelect');

        if (guestSelect) {
          guestSelect.addEventListener('change', async function() {
            const guestInfoDiv = document.getElementById('selectedGuestInfo');
            if (!this.value) {
              guestInfoDiv.style.display = 'none';
              return;
            }

            const guest = JSON.parse(this.options[this.selectedIndex].dataset.guest);
            const homeLink = guest.homeLink;

            // Show loading state
            document.getElementById('guestDetailsContent').innerHTML = `
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status"></div>
                <div>Loading guest details...</div>
              </div>
            `;
            guestInfoDiv.style.display = 'block';

            try {
              // Calculate food total
              const foodTotal = await app.calculateFoodTotal(guest.guestID);
              // Calculate nights
              const nights = helpers.calculateNights(guest.checkin, guest.checkout);

              // Render guest details
              document.getElementById('guestDetailsContent').innerHTML = `
                <h5>${guest.name || 'Unnamed Guest'}</h5>
                <div class="guest-details-grid">
                  <div class="detail-item">
                    <div class="detail-label">Room</div>
                    <div class="detail-value">${guest.room}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Mobile</div>
                    <div class="detail-value">${guest.mobile || 'Not provided'}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Check-in</div>
                    <div class="detail-value">${helpers.formatDate(guest.checkin)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Check-out</div>
                    <div class="detail-value">${helpers.formatDate(guest.checkout)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Nights</div>
                    <div class="detail-value">${nights}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Advance Paid</div>
                    <div class="detail-value">â‚¹${guest.advanceAmount || 0}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Balance Due</div>
                    <div class="detail-value">â‚¹${guest.balanceAmount || 0}</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Food Orders</div>
                    <div class="detail-value">â‚¹${foodTotal}</div>
                  </div>
                </div>
              `;

              // Setup action buttons
              document.getElementById('copyGuestLink').onclick = () => {
                navigator.clipboard.writeText(homeLink);
                helpers.showAlert('billOutput', 'Link copied to clipboard!');
              };
              document.getElementById('sendEmailToGuest').onclick = () => window.open(
                `mailto:?subject=OCB Stays Information&body=${encodeURIComponent(app.generateEmailBody(guest, homeLink))}`
              );
              document.getElementById('sendWhatsappToGuest').onclick = () => window.open(
                `https://wa.me/${guest.mobile}?text=${encodeURIComponent(app.generateWhatsappMessage(guest, homeLink))}`
              );
              document.getElementById('callGuest').href = `tel:${guest.mobile}`;
            } catch (error) {
              console.error('Error loading guest details:', error);
              document.getElementById('guestDetailsContent').innerHTML = `
                <div class="alert alert-danger">Failed to load guest details</div>
              `;
            }
          });
        }

        if (pastGuestSelect) {
          pastGuestSelect.addEventListener('change', function() {
            const pastGuestInfoDiv = document.getElementById('selectedPastGuestInfo');
            if (!this.value) {
              pastGuestInfoDiv.style.display = 'none';
              return;
            }

            const guest = JSON.parse(this.options[this.selectedIndex].dataset.guest);
            document.getElementById('pastGuestDetailsContent').innerHTML = `
              <h5>${guest.name || 'Unnamed Guest'}</h5>
              <div class="guest-details-grid">
                <div class="detail-item">
                  <div class="detail-label">Room</div>
                  <div class="detail-value">${guest.room}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Mobile</div>
                  <div class="detail-value">${guest.mobile || 'Not provided'}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Check-in</div>
                  <div class="detail-value">${helpers.formatDate(guest.checkin)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Check-out</div>
                  <div class="detail-value">${helpers.formatDate(guest.checkout)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Nights</div>
                  <div class="detail-value">${helpers.calculateNights(guest.checkin, guest.checkout)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Advance Paid</div>
                  <div class="detail-value">â‚¹${guest.advanceAmount || 0}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Balance Due</div>
                  <div class="detail-value">â‚¹${guest.balanceAmount || 0}</div>
                </div>
              </div>
            `;
            pastGuestInfoDiv.style.display = 'block';
          });
        }
      },

      // Setup tab navigation
      setupTabNavigation() {
        // Hide all tab contents except dashboard on load
        document.querySelectorAll('.main-content > div').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById('dashboard-content').style.display = 'block';

        document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
          tab.addEventListener('click', function (e) {
            e.preventDefault();
            // Hide all tab contents
            document.querySelectorAll('.main-content > div').forEach(content => {
              content.style.display = 'none';
            });
            // Show selected tab content
            const target = tab.dataset.tabTarget;
            document.getElementById(`${target}-content`).style.display = 'block';
            // Set active tab
            document.querySelectorAll('#mainTabs .nav-link').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
          });
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      // Pre-load background image
      const img = new Image();
      img.src = 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&q=80';
      
      // Show loading state
      document.querySelectorAll('.loading-container').forEach(container => {
        container.style.display = 'flex';
      });

      // Setup tab navigation FIRST, before any data loading
      handlers.setupTabNavigation();
      
      // Initialize basic UI elements
      app.setupGuestSelection = handlers.setupGuestSelection;
      handlers.setupGuestSelection();
      app.initCalendar();

      // Load data asynchronously without blocking tab switching
      const loadData = async () => {
        try {
          await Promise.all([
            app.loadActiveGuests(),
            app.loadAvailableRooms(),
            app.loadTodaysGuests(),
            app.loadUpcomingGuests(),
            app.generateCalendarView()
          ]);
        } catch (error) {
          console.error('Error loading data:', error);
        } finally {
          // Hide all loading containers when done
          document.querySelectorAll('.loading-container').forEach(container => {
            container.style.display = 'none';
          });
        }
      };

      // Start loading data without awaiting
      loadData();

      // Setup event handlers - these work independently of data loading
      document.getElementById('guestForm').addEventListener('submit', handlers.registerGuest);
      document.getElementById('propertyFilter').addEventListener('change', (e) => {
        app.generateCalendarView(e.target.value);
      });
      document.getElementById('generateBill').addEventListener('click', handlers.generateBill);
      document.getElementById('placeOrder').addEventListener('click', () => {
        const guestSelect = document.getElementById('guestSelect');
        const guest = JSON.parse(guestSelect.options[guestSelect.selectedIndex].dataset.guest);
        app.showFoodOrders(guest.guestID);
      });
      document.getElementById('checkoutGuest').addEventListener('click', handlers.checkoutGuest);
    });

    // Add event handlers for guest card clicks
    document.addEventListener('click', function(e) {
      if (e.target.closest('.guest-card')) {
        const guestId = e.target.closest('.guest-card').dataset.guestId;
        if (guestId) {
          document.querySelector('#manage-footer-tab').click();
          setTimeout(() => {
            const guestSelect = document.getElementById('guestSelect');
            guestSelect.value = guestId;
            guestSelect.dispatchEvent(new Event('change'));
            document.getElementById('manage-content').scrollIntoView({ behavior: 'smooth' });
          }, 100);
        }
      }
    });
  </script>

  <!-- Add these new modals -->
  <div class="modal fade" id="checkoutConfirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Checkout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="checkoutConfirmBody">
          <!-- Content will be dynamically added -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmCheckout">Confirm Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="foodOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Food Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="foodOrdersBody">
          <!-- Content will be dynamically added -->
        </div>
      </div>
    </div>
  </div>

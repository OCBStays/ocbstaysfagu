<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCB Stays â€“ Host Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    .nav-tabs {
      margin-bottom: 1rem;
    }
    .tab-content {
      background-color: #fff;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 1.5rem;
    }
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .action-icon {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 0 0.25rem;
    }
    .email-icon { background-color: #3498db; color: white; }
    .whatsapp-icon { background-color: #25D366; color: white; }
    .copy-icon { background-color: #6c757d; color: white; }
    .food-icon { background-color: #ff6b6b; color: white; }
    .contact-icon { color: #6c757d; cursor: pointer; margin-left: 0.5rem; }
    .input-group-copy { margin-bottom: 0.5rem; }
    .compact-btn { padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.5rem; }
    .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
    .mobile-input-group { display: flex; align-items: center; }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">OCB Stays â€“ Host Dashboard</h1>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">
        <i class="fas fa-user-plus me-1"></i> Register
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
        <i class="fas fa-users-cog me-1"></i> Manage
      </button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <!-- Registration Tab -->
    <div class="tab-pane fade show active" id="register" role="tabpanel">
      <form id="guestForm">
        <div class="mb-3">
          <label for="room" class="form-label">Room</label>
          <select class="form-select" id="room" required>
            <option value="">Loading available rooms...</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="checkin" class="form-label">Check-in Date</label>
          <input type="date" class="form-control" id="checkin" required>
        </div>
        <div class="mb-3">
          <label for="checkout" class="form-label">Check-out Date</label>
          <input type="date" class="form-control" id="checkout" required>
        </div>
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
          <label for="mobile" class="form-label">Mobile Number</label>
          <div class="mobile-input-group">
            <input type="tel" class="form-control" id="mobile" required>
            <i class="fas fa-address-book contact-icon" id="openContacts"></i>
          </div>
        </div>
        <div class="mb-3">
          <label for="advanceAmount" class="form-label">Advance Payment (â‚¹)</label>
          <input type="number" class="form-control" id="advanceAmount">
        </div>
        <div class="mb-3">
          <label for="balanceAmount" class="form-label">Balance Amount (â‚¹)</label>
          <input type="number" class="form-control" id="balanceAmount">
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary" id="registerBtn">
            Register
            <span id="registerSpinner" class="loading-spinner" style="display: none;"></span>
          </button>
          <div class="action-icon email-icon" id="sendEmailBtn" disabled title="Send Email">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="action-icon whatsapp-icon" id="sendWhatsappBtn" disabled title="Send WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </div>
        </div>
      </form>
      <div id="linkOutput" class="mt-3"></div>
    </div>

    <!-- Management Tab -->
    <div class="tab-pane fade" id="manage" role="tabpanel">
      <div class="mb-3">
        <label for="guestSelect" class="form-label">Select Active Guest</label>
        <select class="form-select" id="guestSelect">
          <option value="">Select Guest</option>
        </select>
      </div>
      
      <div id="selectedGuestInfo" style="display: none;">
        <div class="action-buttons">
          <div class="action-icon email-icon" id="sendEmailToGuest" title="Send Email">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="action-icon whatsapp-icon" id="sendWhatsappToGuest" title="Send WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </div>
          <div class="action-icon copy-icon" id="copyGuestLink" title="Copy Link">
            <i class="fas fa-copy"></i>
          </div>
        </div>
      </div>
      
      <div class="action-buttons">
        <div class="action-icon food-icon" id="placeOrder" title="Place Food Order">
          <i class="fas fa-utensils"></i>
        </div>
        <button id="generateBill" class="btn btn-secondary compact-btn">
          <i class="fas fa-file-invoice"></i> Bill
          <span id="billSpinner" class="loading-spinner" style="display: none;"></span>
        </button>
        <button id="checkoutGuest" class="btn btn-danger compact-btn">
          <i class="fas fa-sign-out-alt"></i> Checkout
          <span id="checkoutSpinner" class="loading-spinner" style="display: none;"></span>
        </button>
      </div>
      <div id="billOutput" class="mt-3"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    // Configuration
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: {
          guests: 'Guests',
          bills: 'Bills',
          orders: 'Orders'
        }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"]
    };

    // Helper functions
    const helpers = {
      generateGuestId: () => 'GST' + Array.from({length: 5}, () => 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      
      formatDate: (dateString) => new Date(dateString).toLocaleDateString('en-US', { 
        month: 'short', day: 'numeric', year: 'numeric' 
      }),
      
      fetchAirtable: async (table, params = '') => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${table}${params}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${config.airtable.token}` }
        });
        if (!response.ok) throw new Error(await response.text());
        return await response.json();
      },
      
      toggleSpinner: (elementId, show) => {
        const spinner = document.getElementById(elementId);
        spinner.style.display = show ? 'inline-block' : 'none';
      },
      
      showAlert: (containerId, message, type = 'success') => {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        document.getElementById(containerId).prepend(alert);
        setTimeout(() => alert.remove(), 5000);
      }
    };

    // Core functions
    const app = {
      async loadAvailableRooms() {
        const roomSelect = document.getElementById('room');
        try {
          roomSelect.disabled = true;
          const data = await helpers.fetchAirtable(config.airtable.tables.guests, '?filterByFormula={status}="Active"');
          const occupiedRooms = new Set(data.records.map(r => r.fields.room));
          
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          config.rooms.forEach(room => {
            if (!occupiedRooms.has(room)) {
              roomSelect.innerHTML += `<option value="${room}">${room}</option>`;
            }
          });
        } catch (error) {
          console.error('Error loading rooms:', error);
          roomSelect.innerHTML = '<option value="">Error loading rooms</option>';
        } finally {
          roomSelect.disabled = false;
        }
      },
      
      async loadActiveGuests() {
        const guestSelect = document.getElementById('guestSelect');
        try {
          guestSelect.disabled = true;
          guestSelect.innerHTML = '<option value="">Loading guests...</option>';
          const data = await helpers.fetchAirtable(config.airtable.tables.guests, '?filterByFormula={status}="Active"');
          
          guestSelect.innerHTML = '<option value="">Select Guest</option>';
          data.records.forEach(record => {
            const guest = record.fields;
            const option = new Option(
              `${guest.name || 'Unnamed'} (${guest.guestID}) - ${guest.room}`,
              record.id
            );
            option.dataset.guest = JSON.stringify(guest);
            guestSelect.add(option);
          });
        } catch (error) {
          console.error('Error loading guests:', error);
          helpers.showAlert('billOutput', `Failed to load guests: ${error.message}`, 'danger');
        } finally {
          guestSelect.disabled = false;
        }
      },
      
      async getGuestOrders(guestID) {
        try {
          const params = `?filterByFormula=AND({Guest} = '${guestID}', {Status} != 'Cancelled')`;
          const data = await helpers.fetchAirtable(config.airtable.tables.orders, params);
          return data.records;
        } catch (error) {
          console.error('Error fetching orders:', error);
          throw error;
        }
      },
      
      async createFoodBill(guestRecordId, guestDetails, orders) {
        try {
          let totalAmount = 0;
          const allOrderItems = orders.flatMap(order => {
            const items = JSON.parse(order.fields.Items || '[]');
            const orderTotal = order.fields.TotalAmount || 
              items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            totalAmount += orderTotal;
            return items.map(item => ({
              item: item.name || 'Unspecified item',
              amount: (item.price || 0) * (item.quantity || 1),
              date: order.fields.createdAt || new Date().toISOString()
            }));
          });

          const billData = {
            fields: {
              billID: `BIL-${Date.now().toString().slice(-6)}`,
              guestID: [guestRecordId],
              totalAmount: totalAmount,
              status: "Pending",
              orderDetails: JSON.stringify(allOrderItems)
            }
          };

          await helpers.fetchAirtable(config.airtable.tables.bills, '', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billData)
          });

          return { guest: guestDetails, orders: allOrderItems, totalAmount };
        } catch (error) {
          console.error('Error creating food bill:', error);
          throw error;
        }
      },
      
      downloadBillAsImage() {
        const billDetails = document.querySelector('.bill-details');
        if (!billDetails) return alert('No bill generated to download');
        html2canvas(billDetails).then(canvas => {
          const link = document.createElement('a');
          link.download = 'food-bill.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      },
      
      generateEmailBody(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu. 

Your booking for ${guest.room} for ${helpers.formatDate(guest.checkin)} is confirmed with advance payment of â‚¹${guest.advanceAmount || 0} (non-refundable), balance â‚¹${guest.balanceAmount || 0} to be transferred on arrival.

Check-in : ${helpers.formatDate(guest.checkin)} 1pm || Check Out: ${helpers.formatDate(guest.checkout)} 11am

Please follow the below link for CheckIn instructions and other important info:
${link}

Please share your Id's for the record purpose & feel free to get in touch anytime in case you have any queries or need any assistance. 

Hope you have a great time !! 

Thanks, 
Prateek & Ishika 
OCB Stays, Curated with Love..`;
      },
      
      generateWhatsappMessage(guest, link) {
        return `Hi ${guest.name},
Thank you for choosing OCB Stays for your upcoming trip to Fagu.
Please follow the below link:
${link}

Cheers,
Team OCB Stays`;
      }
    };

    // Event handlers
    const handlers = {
      async registerGuest(e) {
        e.preventDefault();
        const btn = e.target;
        btn.disabled = true;
        helpers.toggleSpinner('registerSpinner', true);
        
        try {
          const formData = {
            room: document.getElementById('room').value,
            checkin: document.getElementById('checkin').value,
            checkout: document.getElementById('checkout').value,
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            advanceAmount: document.getElementById('advanceAmount').value || 0,
            balanceAmount: document.getElementById('balanceAmount').value || 0
          };
          
          const guestID = helpers.generateGuestId();
          const homeLink = `${config.urls.guestPortal}?guestID=${guestID}&room=${encodeURIComponent(formData.room)}`;
          
          await helpers.fetchAirtable(config.airtable.tables.guests, '', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fields: {
                ...formData,
                guestID,
                status: "Active",
                homeLink,
                advanceAmount: parseFloat(formData.advanceAmount),
                balanceAmount: parseFloat(formData.balanceAmount)
              }
            })
          });

          document.getElementById('linkOutput').innerHTML = `
            <div class="alert alert-success">Guest registered successfully!</div>
            <div class="input-group-copy">
              <input type="text" class="form-control" value="${homeLink}" readonly>
              <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('${homeLink}');alert('Copied!')">ðŸ“‹ Copy</button>
            </div>
          `;
          
          // Enable action buttons
          const guest = { ...formData, guestID };
          document.getElementById('sendEmailBtn').onclick = () => window.open(
            `mailto:?subject=OCB Stays Booking Confirmation&body=${encodeURIComponent(app.generateEmailBody(guest, homeLink))}`
          );
          document.getElementById('sendWhatsappBtn').onclick = () => window.open(
            `https://wa.me/?text=${encodeURIComponent(app.generateWhatsappMessage(guest, homeLink))}`
          );
          document.getElementById('sendEmailBtn').disabled = false;
          document.getElementById('sendWhatsappBtn').disabled = false;
          
          await app.loadActiveGuests();
          await app.loadAvailableRooms();
        } catch (error) {
          console.error("Registration error:", error);
          helpers.showAlert('linkOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('registerSpinner', false);
        }
      },
      
      async generateBill() {
        const guestSelect = document.getElementById('guestSelect');
        const btn = document.getElementById('generateBill');
        if (!guestSelect.value) return helpers.showAlert('billOutput', 'Please select a guest', 'danger');
        
        btn.disabled = true;
        helpers.toggleSpinner('billSpinner', true);
        document.getElementById('billOutput').innerHTML = '<div class="alert alert-info">Generating food bill...</div>';
        
        try {
          const guestData = JSON.parse(guestSelect.options[guestSelect.selectedIndex].dataset.guest);
          const orders = await app.getGuestOrders(guestData.guestID);
          if (!orders.length) return helpers.showAlert('billOutput', 'No food orders found', 'warning');
          
          const billResult = await app.createFoodBill(guestSelect.value, guestData, orders);
          
          let ordersHTML = billResult.orders.map(order => `
            <div class="order-item">
              <span>${order.item}</span>
              <span>â‚¹${order.amount.toFixed(2)}</span>
            </div>
          `).join('');
          
          ordersHTML += `
            <div class="order-total">
              <span>Total:</span>
              <span>â‚¹${billResult.totalAmount.toFixed(2)}</span>
            </div>
          `;
          
          document.getElementById('billOutput').innerHTML = `
            <div class="alert alert-success">Food bill generated!</div>
            <div class="bill-details">
              <h5>Guest: ${billResult.guest.name || 'Unnamed'} (${billResult.guest.guestID})</h5>
              <h6>Order Items:</h6>
              ${ordersHTML}
            </div>
            <div class="action-buttons mt-3">
              <div class="action-icon download-icon" onclick="app.downloadBillAsImage()" title="Download Bill">
                <i class="fas fa-download"></i>
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Bill generation error:", error);
          helpers.showAlert('billOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('billSpinner', false);
        }
      },
      
      async checkoutGuest() {
        const guestId = document.getElementById('guestSelect').value;
        if (!guestId || !confirm('Check out this guest?')) return;
        
        const btn = document.getElementById('checkoutGuest');
        btn.disabled = true;
        helpers.toggleSpinner('checkoutSpinner', true);
        
        try {
          await helpers.fetchAirtable(config.airtable.tables.guests, `/${guestId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { status: "Checked Out" } })
          });
          
          helpers.showAlert('billOutput', 'Guest checked out successfully');
          document.getElementById('selectedGuestInfo').style.display = 'none';
          await app.loadActiveGuests();
          await app.loadAvailableRooms();
        } catch (error) {
          console.error("Checkout error:", error);
          helpers.showAlert('billOutput', `Error: ${error.message}`, 'danger');
        } finally {
          btn.disabled = false;
          helpers.toggleSpinner('checkoutSpinner', false);
        }
      },
      
      setupGuestSelection() {
        const guestSelect = document.getElementById('guestSelect');
        const guestInfoDiv = document.getElementById('selectedGuestInfo');
        
        guestSelect.addEventListener('change', function() {
          if (!this.value) return guestInfoDiv.style.display = 'none';
          
          const guest = JSON.parse(this.options[this.selectedIndex].dataset.guest);
          const homeLink = guest.homeLink;
          
          document.getElementById('copyGuestLink').onclick = () => {
            navigator.clipboard.writeText(homeLink);
            helpers.showAlert('billOutput', 'Link copied to clipboard!');
          };
          
          document.getElementById('sendEmailToGuest').onclick = () => window.open(
            `mailto:?subject=OCB Stays Information&body=${encodeURIComponent(app.generateEmailBody(guest, homeLink))}`
          );
          
          document.getElementById('sendWhatsappToGuest').onclick = () => window.open(
            `https://wa.me/${guest.mobile}?text=${encodeURIComponent(app.generateWhatsappMessage(guest, homeLink))}`
          );
          
          guestInfoDiv.style.display = 'block';
        });
      },
      
      setupPlaceOrder() {
        document.getElementById('placeOrder').addEventListener('click', () => {
          const guestSelect = document.getElementById('guestSelect');
          if (!guestSelect.value) return helpers.showAlert('billOutput', 'Please select a guest', 'danger');
          
          const guest = JSON.parse(guestSelect.options[guestSelect.selectedIndex].dataset.guest);
          const menuLink = `${config.urls.guestMenu}?guestID=${guest.guestID}&room=${encodeURIComponent(guest.room)}`;
          window.open(menuLink, '_blank');
        });
      },
      
      setupContactIcon() {
        document.getElementById('openContacts').addEventListener('click', () => {
          document.getElementById('mobile').focus();
        });
      }
    };

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      // Setup event listeners
      document.getElementById('guestForm').addEventListener('submit', handlers.registerGuest);
      document.getElementById('generateBill').addEventListener('click', handlers.generateBill);
      document.getElementById('checkoutGuest').addEventListener('click', handlers.checkoutGuest);
      handlers.setupGuestSelection();
      handlers.setupPlaceOrder();
      handlers.setupContactIcon();
      
      // Load initial data
      await app.loadAvailableRooms();
      await app.loadActiveGuests();
      
      // Make functions available globally
      window.app = app;
    });
  </script>
</body>
</html>

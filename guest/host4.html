<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCB Stays â€“ Host Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <style>
    :root {
      --font-primary: 'Inter', sans-serif;
      --font-secondary: 'JetBrains Mono', monospace;
      --font-accent: 'Playfair Display', serif;
      
      /* Dark theme colors */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border-color: #475569;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      /* Font sizes */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --border-color: #cbd5e1;
    }

    * {
      font-family: var(--font-primary);
    }

    .font-accent { font-family: var(--font-accent); }
    .font-mono { font-family: var(--font-secondary); }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: var(--text-base);
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .btn {
      @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
    }

    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-secondary);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-error { background: var(--error); color: white; }

    .input {
      @apply w-full px-3 py-2 rounded-lg border transition-all duration-200;
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      transition: transform 0.3s ease;
    }

    .tab-button {
      @apply w-full text-left px-4 py-3 rounded-lg transition-all duration-200 flex items-center gap-3;
      color: var(--text-secondary);
    }

    .tab-button:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--accent-primary);
      color: white;
    }

    .settings-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .settings-panel.open {
      transform: translateX(0);
    }

    .toast {
      @apply fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2;
      background: var(--success);
      color: white;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .modal {
      @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 opacity-0 pointer-events-none;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      @apply rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto;
    }

    .guest-item {
      @apply p-4 border-b cursor-pointer transition-all duration-200 hover:bg-opacity-50;
      border-color: var(--border-color);
    }

    .guest-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .guest-item.active {
      background: var(--accent-primary);
      color: white;
    }

    .revenue-item {
      @apply flex justify-between items-center p-3 rounded-lg cursor-pointer transition-all duration-200;
      background: var(--bg-tertiary);
    }

    .revenue-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        position: fixed;
        z-index: 30;
        height: 100vh;
      }

      .sidebar.open {
        transform: translateX(0);
      }
    }

    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Flatpickr theme */
    .flatpickr-calendar {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-color) !important;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
    }

    .flatpickr-day {
      color: var(--text-primary) !important;
    }

    .flatpickr-day:hover {
      background: var(--accent-primary) !important;
      color: white !important;
    }

    .flatpickr-day.selected {
      background: var(--accent-primary) !important;
      color: white !important;
    }

    .flatpickr-day.booked {
      background: var(--warning) !important;
      color: white !important;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Mobile Menu Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

  <!-- Main Layout -->
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 h-full flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <h1 class="font-accent text-2xl font-bold text-balance">OCB Stays</h1>
        <p class="text-sm" style="color: var(--text-muted);">Host Management</p>
        <div id="currentTime" class="font-mono text-xs mt-2" style="color: var(--text-muted);"></div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2">
        <button class="tab-button active" data-tab="dashboard">
          <i class="fas fa-chart-line"></i>
          <span>Dashboard</span>
        </button>
        <button class="tab-button" data-tab="current-guests">
          <i class="fas fa-users"></i>
          <span>Current Guests</span>
        </button>
        <button class="tab-button" data-tab="past-guests">
          <i class="fas fa-history"></i>
          <span>Past Guests</span>
        </button>
        <button class="tab-button" data-tab="calendar">
          <i class="fas fa-calendar-alt"></i>
          <span>Calendar</span>
        </button>
        
        <!-- Custom Tabs Section -->
        <div class="pt-4 border-t" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium" style="color: var(--text-muted);">CUSTOM TABS</span>
            <button id="addTabBtn" class="text-xs" style="color: var(--accent-primary);">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="customTabs" class="space-y-1"></div>
        </div>
      </nav>

      <!-- Footer Actions -->
      <div class="p-4 border-t space-y-2" style="border-color: var(--border-color);">
        <button id="registerGuestBtn" class="btn btn-primary w-full">
          <i class="fas fa-user-plus"></i>
          Register Guest
        </button>
        <div class="flex gap-2">
          <button id="themeToggle" class="btn btn-secondary flex-1">
            <i class="fas fa-sun"></i>
          </button>
          <button id="settingsBtn" class="btn btn-secondary flex-1">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Mobile Header -->
      <div class="md:hidden flex items-center justify-between p-4 border-b" style="border-color: var(--border-color);">
        <button id="mobileMenuBtn" class="btn btn-secondary">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="font-accent text-xl font-bold">OCB Stays</h1>
        <button id="mobileSettingsBtn" class="btn btn-secondary">
          <i class="fas fa-cog"></i>
        </button>
      </div>

      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content p-6">
          <div class="mb-6">
            <h2 class="text-3xl font-bold font-accent mb-2">Dashboard</h2>
            <p style="color: var(--text-muted);">Overview of your property management</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Current Guests Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Current Guests</h3>
                <i class="fas fa-users text-2xl" style="color: var(--accent-primary);"></i>
              </div>
              <div id="currentGuestsCount" class="text-3xl font-bold mb-2">0</div>
              <div id="currentGuestsList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <!-- Upcoming Bookings Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Upcoming Bookings</h3>
                <i class="fas fa-calendar-check text-2xl" style="color: var(--success);"></i>
              </div>
              <div id="upcomingBookings" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <!-- Room Occupancy Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Room Occupancy</h3>
                <button id="viewCalendarBtn" class="btn btn-primary">
                  <i class="fas fa-calendar-alt"></i>
                </button>
              </div>
              <div id="roomOccupancy" class="space-y-2"></div>
            </div>

            <!-- Revenue Snapshot Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Revenue Snapshot</h3>
                <i class="fas fa-chart-bar text-2xl" style="color: var(--warning);"></i>
              </div>
              <div id="revenueSummary" class="space-y-2"></div>
            </div>

            <!-- Pending Balances Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Pending Balances</h3>
                <i class="fas fa-exclamation-triangle text-2xl" style="color: var(--error);"></i>
              </div>
              <div id="pendingBalances" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <!-- Recent Food Orders Card -->
            <div class="card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Recent Orders</h3>
                <i class="fas fa-utensils text-2xl" style="color: var(--accent-secondary);"></i>
              </div>
              <div id="recentOrders" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        <!-- Current Guests Tab -->
        <div id="current-guests" class="tab-content p-6 hidden">
          <div class="mb-6">
            <h2 class="text-3xl font-bold font-accent mb-2">Current Guests</h2>
            <p style="color: var(--text-muted);">Manage your active guests</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Guest List -->
            <div class="card p-6">
              <h3 class="text-lg font-semibold mb-4">Select Guest</h3>
              <div id="currentGuestList" class="space-y-1 max-h-96 overflow-y-auto"></div>
            </div>

            <!-- Guest Details -->
            <div class="lg:col-span-2">
              <div id="selectedGuestInfo" class="hidden">
                <div class="card p-6 mb-6">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Guest Details</h3>
                    <button id="editGuestBtn" class="btn btn-secondary">
                      <i class="fas fa-edit"></i>
                      Edit
                    </button>
                  </div>
                  <div id="guestDetailsContent"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-6">
                  <button id="callGuest" class="btn btn-success">
                    <i class="fas fa-phone"></i>
                    Call
                  </button>
                  <button id="whatsappGuest" class="btn" style="background: #25d366; color: white;">
                    <i class="fab fa-whatsapp"></i>
                    WhatsApp
                  </button>
                  <button id="emailGuest" class="btn btn-primary">
                    <i class="fas fa-envelope"></i>
                    Email
                  </button>
                  <button id="copyGuestLink" class="btn btn-secondary">
                    <i class="fas fa-copy"></i>
                    Copy Link
                  </button>
                  <button id="placeOrder" class="btn btn-warning">
                    <i class="fas fa-utensils"></i>
                    Food Order
                  </button>
                  <button id="generateBill" class="btn btn-primary">
                    <i class="fas fa-file-invoice"></i>
                    Generate Bill
                  </button>
                  <button id="checkoutGuest" class="btn btn-error">
                    <i class="fas fa-sign-out-alt"></i>
                    Checkout
                  </button>
                </div>

                <!-- Bill Output -->
                <div id="billOutput" class="hidden"></div>
              </div>

              <div id="noGuestSelected" class="card p-12 text-center">
                <i class="fas fa-user-friends text-6xl mb-4" style="color: var(--text-muted);"></i>
                <h3 class="text-xl font-semibold mb-2">No Guest Selected</h3>
                <p style="color: var(--text-muted);">Select a guest from the list to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Past Guests Tab -->
        <div id="past-guests" class="tab-content p-6 hidden">
          <div class="mb-6">
            <h2 class="text-3xl font-bold font-accent mb-2">Past Guests</h2>
            <p style="color: var(--text-muted);">View your guest history</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Past Guest List -->
            <div class="card p-6">
              <h3 class="text-lg font-semibold mb-4">Select Past Guest</h3>
              <div id="pastGuestList" class="space-y-1 max-h-96 overflow-y-auto"></div>
            </div>

            <!-- Past Guest Details -->
            <div class="lg:col-span-2">
              <div id="selectedPastGuestInfo" class="hidden">
                <div class="card p-6 mb-6">
                  <h3 class="text-lg font-semibold mb-4">Guest Details</h3>
                  <div id="pastGuestDetailsContent"></div>
                </div>

                <div class="flex gap-3 mb-6">
                  <button id="generatePastBill" class="btn btn-primary">
                    <i class="fas fa-file-invoice"></i>
                    Generate Bill
                  </button>
                </div>

                <div id="pastBillOutput" class="hidden"></div>
              </div>

              <div id="noPastGuestSelected" class="card p-12 text-center">
                <i class="fas fa-history text-6xl mb-4" style="color: var(--text-muted);"></i>
                <h3 class="text-xl font-semibold mb-2">No Past Guest Selected</h3>
                <p style="color: var(--text-muted);">Select a past guest from the list to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content p-6 hidden">
          <div class="mb-6">
            <h2 class="text-3xl font-bold font-accent mb-2">Occupancy Calendar</h2>
            <p style="color: var(--text-muted);">View room availability and bookings</p>
          </div>

          <div class="card p-6">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Filter by Room</label>
              <select id="calendarRoomFilter" class="input max-w-xs">
                <option value="">All Rooms</option>
                <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
                <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
                <option value="A Frame Cottage">A Frame Cottage</option>
              </select>
            </div>
            <div id="occupancyCalendar" class="mb-4"></div>
            <div class="flex justify-between">
              <button id="prevMonth" class="btn btn-secondary">
                <i class="fas fa-chevron-left"></i>
                Previous
              </button>
              <button id="nextMonth" class="btn btn-secondary">
                Next
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel fixed right-0 top-0 h-full w-96 z-30 overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold font-accent">Settings</h2>
          <button id="closeSettings" class="btn btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Theme Settings -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Theme</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Dark Mode</label>
              <button id="themeToggleSettings" class="btn btn-secondary">
                <i class="fas fa-sun"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Font Settings -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Typography</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Primary Font</label>
              <select id="primaryFont" class="input">
                <option value="Inter">Inter</option>
                <option value="Roboto">Roboto</option>
                <option value="Open Sans">Open Sans</option>
                <option value="Lato">Lato</option>
                <option value="Poppins">Poppins</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Accent Font</label>
              <select id="accentFont" class="input">
                <option value="Playfair Display">Playfair Display</option>
                <option value="Merriweather">Merriweather</option>
                <option value="Crimson Text">Crimson Text</option>
                <option value="Libre Baskerville">Libre Baskerville</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Base Font Size</label>
              <input type="range" id="baseFontSize" min="12" max="20" value="16" class="w-full">
              <div class="text-xs text-center mt-1" style="color: var(--text-muted);">
                <span id="baseFontSizeValue">16px</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Heading Size Multiplier</label>
              <input type="range" id="headingMultiplier" min="1.2" max="2.5" step="0.1" value="1.5" class="w-full">
              <div class="text-xs text-center mt-1" style="color: var(--text-muted);">
                <span id="headingMultiplierValue">1.5x</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Message Templates -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Message Templates</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">WhatsApp Template</label>
              <textarea id="whatsappTemplate" rows="4" class="input resize-none" placeholder="Hi {name}, Thank you for choosing OCB Stays..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Email Template</label>
              <textarea id="emailTemplate" rows="6" class="input resize-none" placeholder="Hi {name}, Thank you for choosing OCB Stays..."></textarea>
            </div>
          </div>
        </div>

        <!-- Custom CSS -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Custom CSS</h3>
          <textarea id="customCSS" rows="8" class="input font-mono text-sm resize-none" placeholder="/* Add your custom CSS here */"></textarea>
          <button id="applyCSSBtn" class="btn btn-primary mt-2 w-full">
            <i class="fas fa-paint-brush"></i>
            Apply CSS
          </button>
        </div>

        <!-- Tab Management -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Custom Tabs</h3>
          <div id="tabManagement" class="space-y-3">
            <div class="flex gap-2">
              <input type="text" id="newTabName" placeholder="Tab Name" class="input flex-1">
              <input type="url" id="newTabUrl" placeholder="URL" class="input flex-1">
              <button id="addCustomTab" class="btn btn-primary">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div id="customTabsList" class="space-y-2"></div>
          </div>
        </div>

        <!-- Export/Import Settings -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4">Settings Management</h3>
          <div class="space-y-3">
            <button id="exportSettings" class="btn btn-secondary w-full">
              <i class="fas fa-download"></i>
              Export Settings
            </button>
            <div class="flex gap-2">
              <input type="file" id="importSettings" accept=".json" class="hidden">
              <button id="importSettingsBtn" class="btn btn-secondary flex-1">
                <i class="fas fa-upload"></i>
                Import Settings
              </button>
              <button id="resetSettings" class="btn btn-error flex-1">
                <i class="fas fa-undo"></i>
                Reset
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <!-- Register Guest Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Register New Guest</h2>
          <button id="closeRegisterModal" class="btn btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="guestForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Dates</label>
            <input type="text" id="dateRange" placeholder="Select check-in and check-out dates" class="input" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Room</label>
            <select id="room" class="input" required disabled>
              <option value="">Select dates first</option>
            </select>
            <div id="availabilityStatus" class="text-sm mt-1"></div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Name</label>
            <input type="text" id="name" class="input" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Mobile Number</label>
            <input type="tel" id="mobile" class="input" required>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Advance Amount (â‚¹)</label>
              <input type="number" id="advanceAmount" class="input" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Payment Mode</label>
              <select id="advanceMode" class="input">
                <option value="">Select Mode</option>
                <option value="UPI">UPI</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="NetBanking">Net Banking</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Balance Amount (â‚¹)</label>
            <input type="number" id="balanceAmount" class="input" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Notes</label>
            <textarea id="comments" rows="3" class="input resize-none"></textarea>
          </div>
        </form>
      </div>
      <div class="p-6 border-t flex gap-3 justify-end" style="border-color: var(--border-color);">
        <button id="cancelRegister" class="btn btn-secondary">Cancel</button>
        <button id="registerBtn" class="btn btn-primary">
          <i class="fas fa-user-plus"></i>
          Register Guest
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Guest Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Edit Guest Details</h2>
          <button id="closeEditModal" class="btn btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="editGuestForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Name</label>
            <input type="text" id="editName" class="input" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Mobile Number</label>
            <input type="tel" id="editMobile" class="input" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Room</label>
            <select id="editRoom" class="input" required>
              <option value="">Select Room</option>
              <option value="Stargazing Deck (0)">Stargazing Deck (0)</option>
              <option value="Stargazing Cabin (1)">Stargazing Cabin (1)</option>
              <option value="A Frame Cottage">A Frame Cottage</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Check-in Date</label>
              <input type="text" id="editCheckin" class="input flatpickr-input" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Check-out Date</label>
              <input type="text" id="editCheckout" class="input flatpickr-input" required>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Advance Amount (â‚¹)</label>
              <input type="number" id="editAdvance" class="input" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Payment Mode</label>
              <select id="editAdvanceMode" class="input">
                <option value="">Select Mode</option>
                <option value="UPI">UPI</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="NetBanking">Net Banking</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Balance Amount (â‚¹)</label>
            <input type="number" id="editBalance" class="input" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Notes</label>
            <textarea id="editComments" rows="3" class="input resize-none"></textarea>
          </div>
          <input type="hidden" id="editGuestId">
        </form>
      </div>
      <div class="p-6 border-t flex gap-3 justify-end" style="border-color: var(--border-color);">
        <button id="cancelEdit" class="btn btn-secondary">Cancel</button>
        <button id="saveGuestChanges" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Confirm Checkout</h2>
          <button id="closeCheckoutModal" class="btn btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="checkoutForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Balance Due (â‚¹)</label>
            <input type="number" id="checkoutBalance" class="input" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Payment Mode</label>
            <select id="checkoutPaymentType" class="input" required>
              <option value="">Select Payment Mode</option>
              <option value="UPI">UPI</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="NetBanking">Net Banking</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Comments</label>
            <textarea id="checkoutComments" rows="3" class="input resize-none"></textarea>
          </div>
        </form>
      </div>
      <div class="p-6 border-t flex gap-3 justify-end" style="border-color: var(--border-color);">
        <button id="cancelCheckout" class="btn btn-secondary">Cancel</button>
        <button id="confirmCheckout" class="btn btn-primary">
          <i class="fas fa-check"></i>
          Complete Checkout
        </button>
      </div>
    </div>
  </div>

  <!-- Food Orders Modal -->
  <div id="foodOrdersModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Food & Amenities Orders</h2>
          <button id="closeFoodOrdersModal" class="btn btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="foodOrdersContent">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const config = {
      airtable: {
        token: 'patWo5RyRmRCbKXp3.afc1eefc274991a91c14b6b95b2f5bb726cfb14deee85b57e10e5b0f84bc2980',
        baseId: 'app2UvEfKduRwGjfR',
        tables: { guests: 'Guests', bills: 'Bills', orders: 'Orders' }
      },
      urls: {
        guestPortal: 'https://ocbstays.github.io/ocbstaysfagu/guest/index.html',
        guestMenu: 'https://ocbstays.github.io/ocbstaysfagu/guest/menu.html'
      },
      rooms: ["Stargazing Deck (0)", "Stargazing Cabin (1)", "A Frame Cottage"],
      paymentModes: ["UPI", "Cash", "Card", "NetBanking"]
    };

    // Default message templates
    const defaultMessageTemplates = {
      whatsapp: "Hi {name},\nThank you for choosing OCB Stays.\nLink: {link}\n\nCheers,\nTeam OCB Stays",
      email: "Hi {name},\nThank you for choosing OCB Stays.\n\nYour booking for {room} from {checkin} is confirmed with advance payment of â‚¹{advance} (non-refundable), balance â‚¹{balance} due on arrival.\n\nCheck-in: {checkin} 1pm\nCheck Out: {checkout} 11am\n\nLink: {link}\n\nThanks,\nPrateek & Ishika\nOCB Stays"
    };

    // Utility Functions
    const utils = {
      generateGuestId: () => 'GST' + Array(5).fill().map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join(''),
      formatDate: date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
      formatDateTime: date => new Date(date).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true }),
      today: () => new Date().toISOString().split('T')[0],
      nextWeek: () => new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      datesOverlap: (start1, end1, start2, end2) => {
        const d1 = new Date(start1), d2 = new Date(end1), d3 = new Date(start2), d4 = new Date(end2);
        return d1 < d4 && d3 < d2;
      },
      calculateNights: (checkin, checkout) => Math.round(Math.abs((new Date(checkin) - new Date(checkout)) / (24 * 60 * 60 * 1000))),
      
      fetchAirtable: async (endpoint, options = {}) => {
        const url = `https://api.airtable.com/v0/${config.airtable.baseId}/${endpoint}`;
        try {
          const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${config.airtable.token}`, 'Content-Type': 'application/json' },
            ...options
          });
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API request failed');
          return response.json();
        } catch (error) {
          console.error('Airtable API error:', error);
          throw error;
        }
      },

      showToast: (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.background = type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--error)';
        toast.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'times'}"></i>
          <span>${message}</span>
        `;
        document.getElementById('toastContainer').appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      },

      updateElement: (id, content) => {
        const element = document.getElementById(id);
        if (element) {
          element.innerHTML = content;
        }
      },

      copyToClipboard: async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          utils.showToast('Copied to clipboard!', 'success');
        } catch (err) {
          utils.showToast('Failed to copy', 'error');
        }
      }
    };

    // Settings Management
    const settings = {
      defaults: {
        theme: 'dark',
        primaryFont: 'Inter',
        accentFont: 'Playfair Display',
        baseFontSize: 16,
        headingMultiplier: 1.5,
        whatsappTemplate: defaultMessageTemplates.whatsapp,
        emailTemplate: defaultMessageTemplates.email,
        customCSS: '',
        customTabs: []
      },

      load: () => {
        const saved = localStorage.getItem('ocb-settings');
        return saved ? { ...settings.defaults, ...JSON.parse(saved) } : settings.defaults;
      },

      save: (newSettings) => {
        localStorage.setItem('ocb-settings', JSON.stringify(newSettings));
        settings.apply(newSettings);
      },

      apply: (config) => {
        // Apply theme
        document.documentElement.dataset.theme = config.theme;
        document.getElementById('themeToggle').innerHTML = `<i class="fas fa-${config.theme === 'dark' ? 'sun' : 'moon'}"></i>`;
        document.getElementById('themeToggleSettings').innerHTML = `<i class="fas fa-${config.theme === 'dark' ? 'sun' : 'moon'}"></i>`;

        // Apply fonts
        document.documentElement.style.setProperty('--font-primary', `'${config.primaryFont}', sans-serif`);
        document.documentElement.style.setProperty('--font-accent', `'${config.accentFont}', serif`);
        
        // Apply font sizes
        document.documentElement.style.setProperty('--text-base', `${config.baseFontSize}px`);
        document.documentElement.style.setProperty('--text-lg', `${config.baseFontSize * 1.125}px`);
        document.documentElement.style.setProperty('--text-xl', `${config.baseFontSize * config.headingMultiplier}px`);
        document.documentElement.style.setProperty('--text-2xl', `${config.baseFontSize * config.headingMultiplier * 1.2}px`);
        document.documentElement.style.setProperty('--text-3xl', `${config.baseFontSize * config.headingMultiplier * 1.5}px`);

        // Apply custom CSS
        let customStyleElement = document.getElementById('customStyles');
        if (!customStyleElement) {
          customStyleElement = document.createElement('style');
          customStyleElement.id = 'customStyles';
          document.head.appendChild(customStyleElement);
        }
        customStyleElement.textContent = config.customCSS;

        // Update settings UI
        document.getElementById('primaryFont').value = config.primaryFont;
        document.getElementById('accentFont').value = config.accentFont;
        document.getElementById('baseFontSize').value = config.baseFontSize;
        document.getElementById('baseFontSizeValue').textContent = `${config.baseFontSize}px`;
        document.getElementById('headingMultiplier').value = config.headingMultiplier;
        document.getElementById('headingMultiplierValue').textContent = `${config.headingMultiplier}x`;
        document.getElementById('whatsappTemplate').value = config.whatsappTemplate;
        document.getElementById('emailTemplate').value = config.emailTemplate;
        document.getElementById('customCSS').value = config.customCSS;

        // Apply custom tabs
        settings.renderCustomTabs(config.customTabs);
      },

      renderCustomTabs: (tabs) => {
        const customTabsContainer = document.getElementById('customTabs');
        const customTabsList = document.getElementById('customTabsList');
        
        customTabsContainer.innerHTML = '';
        customTabsList.innerHTML = '';

        tabs.forEach((tab, index) => {
          // Add tab button to sidebar
          const tabButton = document.createElement('button');
          tabButton.className = 'tab-button';
          tabButton.dataset.tab = `custom-${index}`;
          tabButton.innerHTML = `
            <i class="fas fa-external-link-alt"></i>
            <span>${tab.name}</span>
          `;
          tabButton.onclick = () => window.open(tab.url, '_blank');
          customTabsContainer.appendChild(tabButton);

          // Add tab to settings list
          const tabItem = document.createElement('div');
          tabItem.className = 'flex items-center gap-2 p-2 rounded';
          tabItem.style.background = 'var(--bg-tertiary)';
          tabItem.innerHTML = `
            <span class="flex-1 text-sm">${tab.name}</span>
            <button class="btn-error text-xs px-2 py-1" onclick="settings.removeCustomTab(${index})">
              <i class="fas fa-trash"></i>
            </button>
          `;
          customTabsList.appendChild(tabItem);
        });
      },

      addCustomTab: (name, url) => {
        const currentSettings = settings.load();
        currentSettings.customTabs.push({ name, url });
        settings.save(currentSettings);
      },

      removeCustomTab: (index) => {
        const currentSettings = settings.load();
        currentSettings.customTabs.splice(index, 1);
        settings.save(currentSettings);
      },

      export: () => {
        const currentSettings = settings.load();
        const blob = new Blob([JSON.stringify(currentSettings, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ocb-stays-settings.json';
        a.click();
        URL.revokeObjectURL(url);
      },

      import: (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedSettings = JSON.parse(e.target.result);
            settings.save({ ...settings.defaults, ...importedSettings });
            utils.showToast('Settings imported successfully!', 'success');
          } catch (error) {
            utils.showToast('Invalid settings file', 'error');
          }
        };
        reader.readAsText(file);
      },

      reset: () => {
        if (confirm('Are you sure you want to reset all settings to defaults?')) {
          settings.save(settings.defaults);
          utils.showToast('Settings reset to defaults', 'success');
        }
      }
    };

    // Core Application Logic
    const app = {
      cachedGuests: null,
      cachedOrders: null,
      calendarInstance: null,
      selectedGuestId: null,
      selectedPastGuestId: null,

      init: async () => {
        // Load and apply settings
        const currentSettings = settings.load();
        settings.apply(currentSettings);

        // Initialize calendar
        app.initCalendar();

        // Load data
        await app.loadDashboard();
        await app.loadGuests('current');
        await app.loadGuests('past');

        // Start clock
        app.updateClock();
        setInterval(app.updateClock, 1000);

        utils.showToast('OCB Stays Management System loaded!', 'success');
      },

      updateClock: () => {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit', 
          second: '2-digit', 
          hour12: true 
        });
      },

      initCalendar: () => {
        flatpickr("#dateRange", { 
          mode: "range", 
          minDate: "today", 
          dateFormat: "Y-m-d", 
          onChange: selectedDates => { 
            if (selectedDates.length === 2) app.checkRoomAvailability(); 
          }
        });
        
        flatpickr("#editCheckin", { 
          minDate: "today", 
          dateFormat: "Y-m-d" 
        });
        
        flatpickr("#editCheckout", { 
          minDate: "today", 
          dateFormat: "Y-m-d" 
        });

        // Initialize occupancy calendar
        if (app.calendarInstance) app.calendarInstance.destroy();
        app.calendarInstance = flatpickr('#occupancyCalendar', {
          inline: true,
          dateFormat: 'Y-m-d',
          onDayCreate: (dObj, dStr, fp, dayElem) => {
            const date = dayElem.dateObj.toISOString().split('T')[0];
            if (app.cachedGuests) {
              const bookings = app.cachedGuests.records.filter(r => {
                const checkin = new Date(r.fields.checkin);
                const checkout = new Date(r.fields.checkout);
                const currentDate = new Date(date);
                return checkin <= currentDate && currentDate <= checkout;
              });
              
              if (bookings.length) {
                const roomFilter = document.getElementById('calendarRoomFilter').value;
                const filteredBookings = roomFilter ? bookings.filter(b => b.fields.room === roomFilter) : bookings;
                if (filteredBookings.length) {
                  dayElem.classList.add('booked');
                  dayElem.title = filteredBookings.map(b => `${b.fields.room} (${b.fields.name || 'Unnamed Guest'})`).join('\n');
                }
              }
            }
          }
        });
      },

      async loadDashboard() {
        try {
          const today = utils.today();
          const nextWeek = utils.nextWeek();
         
          // Fetch guests and orders
          app.cachedGuests = await utils.fetchAirtable(`${config.airtable.tables.guests}?sort[0][field]=checkin`);
          app.cachedOrders = await utils.fetchAirtable(`${config.airtable.tables.orders}?sort[0][field]=OrderDate&sort[0][direction]=desc&maxRecords=10`);
          
          // Create a map of guests by guestID for faster lookup
          const guestMap = {};
          app.cachedGuests.records.forEach(guest => {
            guestMap[guest.fields.guestID] = guest;
          });
          
          // Current Guests
          const currentGuests = app.cachedGuests.records.filter(r => {
            const checkin = new Date(r.fields.checkin);
            const checkout = new Date(r.fields.checkout);
            const todayDate = new Date(today);
            return checkin <= todayDate && checkout >= todayDate;
          });
          
          utils.updateElement('currentGuestsCount', currentGuests.length.toString());
          utils.updateElement('currentGuestsList', currentGuests.length ? currentGuests.map(r => `
            <div class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-opacity-50" 
                 style="background: rgba(59, 130, 246, 0.1);" 
                 data-guest-id="${r.id}" 
                 onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-medium">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="text-sm" style="color: var(--text-muted);">${r.fields.room}</div>
                </div>
                <button class="text-xs" style="color: var(--text-muted);" onclick="utils.copyToClipboard('${r.fields.guestID}'); event.stopPropagation();">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          `).join('') : '<div class="text-center py-8" style="color: var(--text-muted);">No current guests</div>');

          // Upcoming Bookings
          const upcomingGuests = app.cachedGuests.records.filter(r => new Date(r.fields.checkin) > new Date(today) && new Date(r.fields.checkin) <= new Date(nextWeek));
          utils.updateElement('upcomingBookings', upcomingGuests.length ? upcomingGuests.map(r => `
            <div class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-opacity-50" 
                 style="background: rgba(16, 185, 129, 0.1);" 
                 data-guest-id="${r.id}" 
                 onclick="app.selectGuestFromDashboard('${r.id}', 'upcoming')">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-medium">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="text-sm" style="color: var(--text-muted);">${r.fields.room}</div>
                </div>
                <div class="text-sm" style="color: var(--text-muted);">${utils.formatDate(r.fields.checkin)}</div>
              </div>
            </div>
          `).join('') : '<div class="text-center py-8" style="color: var(--text-muted);">No upcoming bookings</div>');

          // Room Occupancy
          const occupiedRooms = new Set(currentGuests.map(r => r.fields.room));
          utils.updateElement('roomOccupancy', config.rooms.map(room => `
            <div class="flex justify-between items-center p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-opacity-50" 
                 style="background: var(--bg-tertiary);" 
                 onclick="app.showCalendarModal('${room}')">
              <span class="font-medium">${room}</span>
              <span class="px-2 py-1 rounded text-xs font-medium" 
                    style="background: ${occupiedRooms.has(room) ? 'var(--error)' : 'var(--success)'}; color: white;">
                ${occupiedRooms.has(room) ? 'Occupied' : 'Available'}
              </span>
            </div>
          `).join(''));

          // Revenue Snapshot
          const advanceTotal = app.cachedGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.advanceAmount) || 0), 0);
          const balanceTotal = app.cachedGuests.records.reduce((sum, r) => sum + (parseFloat(r.fields.balanceAmount) || 0), 0);
          const foodTotal = app.cachedOrders.records.reduce((sum, r) => sum + (parseFloat(r.fields.TotalAmount) || 0), 0);
         
          utils.updateElement('revenueSummary', `
            <div class="space-y-2">
              <div class="revenue-item" onclick="app.showRevenueBreakdown('advance')">
                <span>Advance Payments</span>
                <span class="font-semibold">â‚¹${advanceTotal.toFixed(2)}</span>
              </div>
              <div class="revenue-item" onclick="app.showRevenueBreakdown('balance')">
                <span>Balance Payments</span>
                <span class="font-semibold">â‚¹${balanceTotal.toFixed(2)}</span>
              </div>
              <div class="revenue-item" onclick="app.showRevenueBreakdown('food')">
                <span>Food Orders</span>
                <span class="font-semibold">â‚¹${foodTotal.toFixed(2)}</span>
              </div>
              <div class="revenue-item" style="background: var(--accent-primary); color: white;">
                <span class="font-bold">Total Revenue</span>
                <span class="font-bold">â‚¹${(advanceTotal + balanceTotal + foodTotal).toFixed(2)}</span>
              </div>
            </div>
          `);

          // Pending Balances
          const pendingGuests = currentGuests.filter(r => (parseFloat(r.fields.balanceAmount) || 0) > 0);
          utils.updateElement('pendingBalances', pendingGuests.length ? pendingGuests.map(r => `
            <div class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-opacity-50" 
                 style="background: rgba(239, 68, 68, 0.1);" 
                 data-guest-id="${r.id}" 
                 onclick="app.selectGuestFromDashboard('${r.id}', 'current')">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-medium">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="text-sm" style="color: var(--text-muted);">${r.fields.room}</div>
                </div>
                <span class="font-semibold" style="color: var(--error);">â‚¹${(parseFloat(r.fields.balanceAmount) || 0).toFixed(2)}</span>
              </div>
            </div>
          `).join('') : '<div class="text-center py-8" style="color: var(--text-muted);">No pending balances</div>');

          // Recent Food Orders
          utils.updateElement('recentOrders', app.cachedOrders.records.length ? app.cachedOrders.records.map(r => {
            const guest = guestMap[r.fields.Guest] || null;
            const items = JSON.parse(r.fields.Items || '[]');
            const totalAmount = r.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            const orderDate = r.fields.OrderDate || new Date();
           
            return `
              <div class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-opacity-50" 
                   style="background: rgba(139, 92, 246, 0.1);" 
                   ${guest ? `data-guest-id="${guest.id}" onclick="app.selectGuestFromDashboard('${guest.id}', 'order')"` : ''}>
                <div class="flex justify-between items-center">
                  <div>
                    <div class="font-medium">${guest ? guest.fields.name : 'Unknown Guest'}</div>
                    <div class="text-sm" style="color: var(--text-muted);">Order #${r.fields.OrderID || r.id}</div>
                  </div>
                  <div class="text-right">
                    <div class="font-semibold">â‚¹${totalAmount.toFixed(2)}</div>
                    <div class="text-xs" style="color: var(--text-muted);">${utils.formatDate(orderDate)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('') : '<div class="text-center py-8" style="color: var(--text-muted);">No recent orders</div>');

        } catch (error) {
          utils.showToast('Error loading dashboard: ' + error.message, 'error');
          console.error('Dashboard error:', error);
        }
      },

      async selectGuestFromDashboard(guestId, source) {
        if (!guestId) return utils.showToast('Guest not found', 'warning');
        
        // Switch to current guests tab and select guest
        app.switchTab('current-guests');
        await app.loadGuests('current');
        
        const guestItem = document.querySelector(`#currentGuestList [data-guest-id="${guestId}"]`);
        if (guestItem) {
          guestItem.click();
        } else {
          // Try past guests
          app.switchTab('past-guests');
          await app.loadGuests('past');
          const pastGuestItem = document.querySelector(`#pastGuestList [data-guest-id="${guestId}"]`);
          if (pastGuestItem) {
            pastGuestItem.click();
          }
        }
      },

      async showCalendarModal(selectedRoom = '') {
        app.switchTab('calendar');
        document.getElementById('calendarRoomFilter').value = selectedRoom;
        app.updateOccupancyCalendar();
      },

      updateOccupancyCalendar: () => {
        if (app.calendarInstance) {
          app.calendarInstance.redraw();
        }
      },

      async showRevenueBreakdown(type) {
        // This would open a modal with detailed breakdown
        // For now, just show a toast
        utils.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} breakdown - Feature coming soon!`, 'warning');
      },

      async checkRoomAvailability() {
        const [checkin, checkout] = document.getElementById('dateRange').value.split(' to ');
        const roomSelect = document.getElementById('room');
        const statusDiv = document.getElementById('availabilityStatus');
        
        statusDiv.innerHTML = '<span style="color: var(--text-muted);">Checking availability...</span>';
        
        try {
          const data = await utils.fetchAirtable(`${config.airtable.tables.guests}`);
          const bookedRooms = new Set(data.records.filter(r => utils.datesOverlap(r.fields.checkin, r.fields.checkout, checkin, checkout)).map(r => r.fields.room));
          
          roomSelect.innerHTML = '<option value="">Select Room</option>';
          let availableCount = 0;
          
          config.rooms.forEach(room => {
            if (!bookedRooms.has(room)) {
              roomSelect.innerHTML += `<option value="${room}">${room}</option>`;
              availableCount++;
            }
          });
          
          statusDiv.innerHTML = availableCount ? 
            `<span style="color: var(--success);">${availableCount} room(s) available</span>` : 
            '<span style="color: var(--error);">No rooms available</span>';
          roomSelect.disabled = !availableCount;
        } catch (error) {
          statusDiv.innerHTML = '<span style="color: var(--error);">Error checking availability</span>';
        }
      },

      async loadGuests(type) {
        const listId = type === 'current' ? 'currentGuestList' : 'pastGuestList';
        const list = document.getElementById(listId);
        
        list.innerHTML = '<div class="text-center py-8"><div class="pulse" style="color: var(--accent-primary);"><i class="fas fa-spinner fa-spin"></i> Loading...</div></div>';
        
        try {
          let filter;
          if (type === 'current') {
            filter = "OR({Status} != 'Checked Out', {Status} = '')";
          } else {
            filter = "{Status} = 'Checked Out'";
          }
         
          const data = await utils.fetchAirtable(
            `${config.airtable.tables.guests}?filterByFormula=${encodeURIComponent(filter)}&sort[0][field]=${type === 'current' ? 'checkin' : 'checkout'}&sort[0][direction]=${type === 'current' ? 'asc' : 'desc'}`
          );
         
          if (!data.records.length) {
            list.innerHTML = `<div class="text-center py-8" style="color: var(--text-muted);">No ${type} guests</div>`;
            if (type === 'current') {
              document.getElementById('selectedGuestInfo').classList.add('hidden');
              document.getElementById('noGuestSelected').classList.remove('hidden');
            } else {
              document.getElementById('selectedPastGuestInfo').classList.add('hidden');
              document.getElementById('noPastGuestSelected').classList.remove('hidden');
            }
            return;
          }
          
          list.innerHTML = data.records.map(r => `
            <div class="guest-item" data-guest-id="${r.id}" data-guest='${JSON.stringify(r.fields)}'>
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-medium">${r.fields.name || 'Unnamed Guest'}</div>
                  <div class="text-sm" style="color: var(--text-muted);">
                    ${r.fields.guestID} â€¢ ${r.fields.room}
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">
                    ${utils.formatDate(type === 'current' ? r.fields.checkin : r.fields.checkout)}
                  </div>
                </div>
                <button class="text-sm" style="color: var(--text-muted);" onclick="utils.copyToClipboard('${r.fields.guestID}'); event.stopPropagation();">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          list.innerHTML = `<div class="text-center py-8" style="color: var(--error);">Failed to load ${type} guests</div>`;
          utils.showToast(`Error loading ${type} guests: ${error.message}`, 'error');
        }
      },

      async loadGuestDetails(guestId) {
        const response = await utils.fetchAirtable(`${config.airtable.tables.guests}/${guestId}`);
        return response.fields;
      },

      async loadGuestDetailsForDisplay(guestId, guestData) {
        const guest = guestData || await app.loadGuestDetails(guestId);
        const foodTotal = await app.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);
        const totalDue = (parseFloat(guest.balanceAmount) || 0) + foodTotal;
        
        utils.updateElement('guestDetailsContent', `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <h4 class="font-semibold text-lg">Guest Information</h4>
              <div class="space-y-3">
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Name</label>
                  <div class="font-medium">${guest.name || 'Unnamed Guest'}</div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Mobile</label>
                  <div class="flex items-center gap-2">
                    <span class="font-medium">${guest.mobile || 'Not provided'}</span>
                    <button onclick="utils.copyToClipboard('${guest.mobile}')" class="text-sm" style="color: var(--accent-primary);">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Room</label>
                  <div class="font-medium">${guest.room}</div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Duration</label>
                  <div class="font-medium">${nights} nights</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm" style="color: var(--text-muted);">Check-in</label>
                    <div class="font-medium">${utils.formatDate(guest.checkin)}</div>
                  </div>
                  <div>
                    <label class="text-sm" style="color: var(--text-muted);">Check-out</label>
                    <div class="font-medium">${utils.formatDate(guest.checkout)}</div>
                  </div>
                </div>
              </div>
              ${guest.Comments ? `
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Notes</label>
                  <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">${guest.Comments}</div>
                </div>
              ` : ''}
            </div>
            
            <div class="space-y-4">
              <h4 class="font-semibold text-lg">Payment Summary</h4>
              <div class="space-y-3 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="flex justify-between">
                  <span>Advance Paid</span>
                  <span class="font-medium">â‚¹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</span>
                </div>
                <div class="flex justify-between cursor-pointer hover:bg-opacity-50 p-2 rounded" onclick="app.showFoodOrdersModal('${guestId}')" style="background: rgba(139, 92, 246, 0.1);">
                  <span>Food Orders</span>
                  <span class="font-medium">â‚¹${foodTotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span>Balance Due</span>
                  <span class="font-medium">â‚¹${guest.balanceAmount || 0}</span>
                </div>
                <div class="border-t pt-2" style="border-color: var(--border-color);">
                  <div class="flex justify-between font-bold">
                    <span>Total Due</span>
                    <span>â‚¹${totalDue.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `);
        
        // Set up action buttons
        const homeLink = guest.homeLink || `${config.urls.guestPortal}?guestID=${guest.guestID}`;
        
        document.getElementById('copyGuestLink').onclick = () => utils.copyToClipboard(homeLink);
        document.getElementById('emailGuest').onclick = () => app.sendEmail(guest, homeLink);
        document.getElementById('whatsappGuest').onclick = () => app.sendWhatsApp(guest, homeLink);
        document.getElementById('callGuest').onclick = () => window.open(`tel:${guest.mobile}`);
        document.getElementById('editGuestBtn').onclick = () => app.showEditGuestModal(guestId);
        document.getElementById('checkoutGuest').onclick = () => app.showCheckoutModal(guestId);
        document.getElementById('placeOrder').onclick = () => window.open(`${config.urls.guestMenu}?guestID=${guest.guestID}&room=${encodeURIComponent(guest.room)}`);
        document.getElementById('generateBill').onclick = () => app.generateBill(guestId, 'billOutput');
      },

      async loadPastGuestDetails(guestId) {
        const guest = await app.loadGuestDetails(guestId);
        const foodTotal = await app.calculateFoodTotal(guest.guestID);
        const nights = utils.calculateNights(guest.checkin, guest.checkout);
        
        utils.updateElement('pastGuestDetailsContent', `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <h4 class="font-semibold text-lg">Guest Information</h4>
              <div class="space-y-3">
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Name</label>
                  <div class="font-medium">${guest.name || 'Unnamed Guest'}</div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Mobile</label>
                  <div class="flex items-center gap-2">
                    <span class="font-medium">${guest.mobile || 'Not provided'}</span>
                    <button onclick="utils.copyToClipboard('${guest.mobile}')" class="text-sm" style="color: var(--accent-primary);">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Room</label>
                  <div class="font-medium">${guest.room}</div>
                </div>
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Duration</label>
                  <div class="font-medium">${nights} nights</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm" style="color: var(--text-muted);">Check-in</label>
                    <div class="font-medium">${utils.formatDate(guest.checkin)}</div>
                  </div>
                  <div>
                    <label class="text-sm" style="color: var(--text-muted);">Check-out</label>
                    <div class="font-medium">${utils.formatDate(guest.checkout)}</div>
                  </div>
                </div>
              </div>
              ${guest.Comments ? `
                <div>
                  <label class="text-sm" style="color: var(--text-muted);">Notes</label>
                  <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">${guest.Comments}</div>
                </div>
              ` : ''}
            </div>
            
            <div class="space-y-4">
              <h4 class="font-semibold text-lg">Payment Summary</h4>
              <div class="space-y-3 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="flex justify-between">
                  <span>Advance Paid</span>
                  <span class="font-medium">â‚¹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</span>
                </div>
                <div class="flex justify-between cursor-pointer hover:bg-opacity-50 p-2 rounded" onclick="app.showFoodOrdersModal('${guestId}')" style="background: rgba(139, 92, 246, 0.1);">
                  <span>Food Orders</span>
                  <span class="font-medium">â‚¹${foodTotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span>Balance Paid</span>
                  <span class="font-medium">â‚¹${guest.balanceAmount || 0}${guest.PaymentType ? ` (${guest.PaymentType})` : ''}</span>
                </div>
                <div class="border-t pt-2" style="border-color: var(--border-color);">
                  <div class="flex justify-between font-bold">
                    <span>Total Paid</span>
                    <span>â‚¹${((parseFloat(guest.advanceAmount) || 0) + (parseFloat(guest.balanceAmount) || 0) + foodTotal).toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `);
        
        document.getElementById('generatePastBill').onclick = () => app.generateBill(guestId, 'pastBillOutput');
      },

      async calculateFoodTotal(guestID) {
        const orders = await app.getGuestOrders(guestID);
        return orders.reduce((total, order) => total + (order.fields.TotalAmount || 0), 0);
      },

      async getGuestOrders(guestID) {
        try {
          return (await utils.fetchAirtable(`${config.airtable.tables.orders}?filterByFormula=AND({Guest} = '${guestID}', {Status} != 'Cancelled')`)).records;
        } catch (error) {
          utils.showToast('Error fetching orders: ' + error.message, 'error');
          return [];
        }
      },

      async showFoodOrdersModal(guestId) {
        const modal = document.getElementById('foodOrdersModal');
        const content = document.getElementById('foodOrdersContent');
        
        content.innerHTML = '<div class="text-center py-8"><div class="pulse" style="color: var(--accent-primary);"><i class="fas fa-spinner fa-spin"></i> Loading...</div></div>';
        modal.classList.add('show');
        
        try {
          const guest = await app.loadGuestDetails(guestId);
          const orders = await app.getGuestOrders(guest.guestID);
          
          content.innerHTML = orders.length ? orders.map(order => {
            const orderDate = utils.formatDateTime(order.fields.OrderDate || new Date());
            const items = JSON.parse(order.fields.Items || '[]');
            const totalAmount = order.fields.TotalAmount || items.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
            
            return `
              <div class="card p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                  <div>
                    <span class="font-semibold">Order #${order.fields.OrderID || order.id}</span>
                    <button onclick="utils.copyToClipboard('${order.fields.OrderID || order.id}')" class="ml-2 text-sm" style="color: var(--accent-primary);">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                  <div class="text-sm" style="color: var(--text-muted);">${orderDate}</div>
                </div>
                <div class="flex justify-between items-center mb-3">
                  <span class="px-2 py-1 rounded text-xs font-medium" style="background: ${order.fields.Status === 'Delivered' ? 'var(--success)' : 'var(--warning)'}; color: white;">
                    ${order.fields.Status}
                  </span>
                  <span class="font-bold">â‚¹${totalAmount.toFixed(2)}</span>
                </div>
                <div>
                  <h5 class="font-medium mb-2">Items</h5>
                  <div class="space-y-1">
                    ${items.map(item => `
                      <div class="flex justify-between text-sm">
                        <span>${item.quantity} Ã— ${item.name}${item.specialInstructions ? `<div class="text-xs" style="color: var(--text-muted);">${item.specialInstructions}</div>` : ''}</span>
                        <span>â‚¹${(item.price * item.quantity).toFixed(2)}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
                ${order.fields.SpecialInstructions ? `
                  <div class="mt-3 p-2 rounded" style="background: var(--bg-tertiary);">
                    <strong>Special Instructions:</strong> ${order.fields.SpecialInstructions}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('') : '<div class="text-center py-8" style="color: var(--text-muted);">No food orders found</div>';
        } catch (error) {
          content.innerHTML = '<div class="text-center py-8" style="color: var(--error);">Failed to load food orders</div>';
          utils.showToast('Error loading orders: ' + error.message, 'error');
        }
      },

      sendEmail: (guest, link) => {
        const currentSettings = settings.load();
        const template = currentSettings.emailTemplate
          .replace('{name}', guest.name || 'Guest')
          .replace('{room}', guest.room)
          .replace('{checkin}', utils.formatDate(guest.checkin))
          .replace('{checkout}', utils.formatDate(guest.checkout))
          .replace('{advance}', guest.advanceAmount || 0)
          .replace('{balance}', guest.balanceAmount || 0)
          .replace('{link}', link);
        
        window.open(`mailto:?subject=OCB Stays Information&body=${encodeURIComponent(template)}`);
      },

      sendWhatsApp: (guest, link) => {
        const currentSettings = settings.load();
        const template = currentSettings.whatsappTemplate
          .replace('{name}', guest.name || 'Guest')
          .replace('{room}', guest.room)
          .replace('{checkin}', utils.formatDate(guest.checkin))
          .replace('{checkout}', utils.formatDate(guest.checkout))
          .replace('{advance}', guest.advanceAmount || 0)
          .replace('{balance}', guest.balanceAmount || 0)
          .replace('{link}', link);
        
        window.open(`https://wa.me/${guest.mobile}?text=${encodeURIComponent(template)}`);
      },

      async registerGuest(event) {
        event.preventDefault();
        const btn = document.getElementById('registerBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        btn.disabled = true;
        
        try {
          const [checkin, checkout] = document.getElementById('dateRange').value.split(' to ');
          const guestData = {
            guestID: utils.generateGuestId(),
            name: document.getElementById('name').value,
            mobile: document.getElementById('mobile').value,
            room: document.getElementById('room').value,
            checkin,
            checkout,
            advanceAmount: parseFloat(document.getElementById('advanceAmount').value) || 0,
            advanceMode: document.getElementById('advanceMode').value || '',
            balanceAmount: parseFloat(document.getElementById('balanceAmount').value) || 0,
            Comments: document.getElementById('comments').value || '',
            homeLink: `${config.urls.guestPortal}?guestID=${utils.generateGuestId()}`
          };
          
          if (!guestData.name || !guestData.mobile || !guestData.room || !guestData.checkin || !guestData.checkout) {
            throw new Error('Please fill all required fields');
          }
          
          await utils.fetchAirtable(config.airtable.tables.guests, {
            method: 'POST',
            body: JSON.stringify({ fields: guestData })
          });
          
          // Clear form
          document.getElementById('guestForm').reset();
          document.getElementById('room').innerHTML = '<option value="">Select dates first</option>';
          document.getElementById('room').disabled = true;
          document.getElementById('availabilityStatus').innerHTML = '';
          
          // Close modal
          document.getElementById('registerModal').classList.remove('show');
          
          // Refresh data
          await app.loadDashboard();
          await app.loadGuests('current');
          
          utils.showToast('Guest registered successfully!', 'success');
        } catch (error) {
          utils.showToast('Error registering guest: ' + error.message, 'error');
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      },

      async generateBill(guestId, outputId) {
        const outputElement = document.getElementById(outputId);
        outputElement.innerHTML = '<div class="text-center py-8"><div class="pulse" style="color: var(--accent-primary);"><i class="fas fa-spinner fa-spin"></i> Generating bill...</div></div>';
        outputElement.classList.remove('hidden');
        
        try {
          const guest = await app.loadGuestDetails(guestId);
          const orders = await app.getGuestOrders(guest.guestID);
          const foodTotal = await app.calculateFoodTotal(guest.guestID);
          const nights = utils.calculateNights(guest.checkin, guest.checkout);
          const totalDue = (parseFloat(guest.balanceAmount) || 0) + foodTotal;
          
          const billHtml = `
            <div class="card p-6">
              <div class="text-center mb-6">
                <h3 class="text-2xl font-bold font-accent">OCB Stays</h3>
                <p style="color: var(--text-muted);">Bill for ${guest.name || 'Unnamed Guest'}</p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <h4 class="font-semibold mb-3">Guest Details</h4>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span>Guest ID:</span>
                      <span class="font-mono">${guest.guestID}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Room:</span>
                      <span>${guest.room}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Check-in:</span>
                      <span>${utils.formatDate(guest.checkin)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Check-out:</span>
                      <span>${utils.formatDate(guest.checkout)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Nights:</span>
                      <span>${nights}</span>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h4 class="font-semibold mb-3">Payment Summary</h4>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span>Advance Paid:</span>
                      <span>â‚¹${guest.advanceAmount || 0}${guest.advanceMode ? ` (${guest.advanceMode})` : ''}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Food Orders:</span>
                      <span>â‚¹${foodTotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Balance Due:</span>
                      <span>â‚¹${guest.balanceAmount || 0}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between font-bold" style="border-color: var(--border-color);">
                      <span>Total Due:</span>
                      <span>â‚¹${totalDue.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              ${orders.length ? `
                <div class="mb-6">
                  <h4 class="font-semibold mb-3">Food & Amenities</h4>
                  <div class="space-y-2">
                    ${orders.map(order => {
                      const items = JSON.parse(order.fields.Items || '[]');
                      return items.map(item => `
                        <div class="flex justify-between text-sm">
                          <span>${item.quantity} Ã— ${item.name}</span>
                          <span>â‚¹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                      `).join('');
                    }).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div class="text-center">
                <button onclick="app.downloadBill('${guest.guestID}')" class="btn btn-primary">
                  <i class="fas fa-download"></i>
                  Download Bill
                </button>
              </div>
            </div>
          `;
          
          outputElement.innerHTML = billHtml;
          utils.showToast('Bill generated successfully', 'success');
        } catch (error) {
          outputElement.innerHTML = '<div class="text-center py-8" style="color: var(--error);">Failed to generate bill</div>';
          utils.showToast('Error generating bill: ' + error.message, 'error');
        }
      },

      async downloadBill(guestID) {
        try {
          const billElement = document.querySelector('.card');
          const canvas = await html2canvas(billElement, {
            scale: 2,
            useCORS: true,
            logging: false
          });
          
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            const imgData = canvas.toDataURL('image/png');
            const newTab = window.open();
            newTab.document.write(`<img src="${imgData}" alt="Bill for ${guestID}" style="max-width:100%;">`);
          } else {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `Bill_${guestID}_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
          utils.showToast('Bill downloaded successfully', 'success');
        } catch (error) {
          utils.showToast('Error downloading bill: ' + error.message, 'error');
        }
      },

      showEditGuestModal: async (guestId) => {
        const guest = await app.loadGuestDetails(guestId);
        
        document.getElementById('editName').value = guest.name || '';
        document.getElementById('editMobile').value = guest.mobile || '';
        document.getElementById('editRoom').value = guest.room || '';
        document.getElementById('editCheckin').value = guest.checkin || '';
        document.getElementById('editCheckout').value = guest.checkout || '';
        document.getElementById('editAdvance').value = guest.advanceAmount || '';
        document.getElementById('editAdvanceMode').value = guest.advanceMode || '';
        document.getElementById('editBalance').value = guest.balanceAmount || '';
        document.getElementById('editComments').value = guest.Comments || '';
        document.getElementById('editGuestId').value = guestId;
        
        document.getElementById('editModal').classList.add('show');
      },

      showCheckoutModal: async (guestId) => {
        const guest = await app.loadGuestDetails(guestId);
        const foodTotal = await app.calculateFoodTotal(guest.guestID);
        
        document.getElementById('checkoutBalance').value = ((parseFloat(guest.balanceAmount) || 0) + foodTotal).toFixed(2);
        document.getElementById('checkoutPaymentType').value = '';
        document.getElementById('checkoutComments').value = '';
        
        document.getElementById('checkoutModal').classList.add('show');
      },

      switchTab: (tabName) => {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
          }
        });
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');
        
        // Close mobile menu
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('mobileOverlay').classList.add('hidden');
      }
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Tab switching
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          app.switchTab(btn.dataset.tab);
        });
      });

      // Mobile menu
      document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('mobileOverlay').classList.remove('hidden');
      });

      document.getElementById('mobileOverlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('mobileOverlay').classList.add('hidden');
      });

      // Settings panel
      document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('settingsPanel').classList.add('open');
      });

      document.getElementById('mobileSettingsBtn').addEventListener('click', () => {
        document.getElementById('settingsPanel').classList.add('open');
      });

      document.getElementById('closeSettings').addEventListener('click', () => {
        document.getElementById('settingsPanel').classList.remove('open');
      });

      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', () => {
        const currentSettings = settings.load();
        currentSettings.theme = currentSettings.theme === 'dark' ? 'light' : 'dark';
        settings.save(currentSettings);
      });

      document.getElementById('themeToggleSettings').addEventListener('click', () => {
        const currentSettings = settings.load();
        currentSettings.theme = currentSettings.theme === 'dark' ? 'light' : 'dark';
        settings.save(currentSettings);
      });

      // Settings controls
      document.getElementById('baseFontSize').addEventListener('input', (e) => {
        document.getElementById('baseFontSizeValue').textContent = `${e.target.value}px`;
      });

      document.getElementById('headingMultiplier').addEventListener('input', (e) => {
        document.getElementById('headingMultiplierValue').textContent = `${e.target.value}x`;
      });

      document.getElementById('applyCSSBtn').addEventListener('click', () => {
        const currentSettings = settings.load();
        currentSettings.primaryFont = document.getElementById('primaryFont').value;
        currentSettings.accentFont = document.getElementById('accentFont').value;
        currentSettings.baseFontSize = parseInt(document.getElementById('baseFontSize').value);
        currentSettings.headingMultiplier = parseFloat(document.getElementById('headingMultiplier').value);
        currentSettings.whatsappTemplate = document.getElementById('whatsappTemplate').value;
        currentSettings.emailTemplate = document.getElementById('emailTemplate').value;
        currentSettings.customCSS = document.getElementById('customCSS').value;
        settings.save(currentSettings);
        utils.showToast('Settings applied successfully!', 'success');
      });

      // Custom tabs
      document.getElementById('addCustomTab').addEventListener('click', () => {
        const name = document.getElementById('newTabName').value.trim();
        const url = document.getElementById('newTabUrl').value.trim();
        
        if (name && url) {
          settings.addCustomTab(name, url);
          document.getElementById('newTabName').value = '';
          document.getElementById('newTabUrl').value = '';
          utils.showToast('Custom tab added!', 'success');
        } else {
          utils.showToast('Please enter both name and URL', 'warning');
        }
      });

      // Settings management
      document.getElementById('exportSettings').addEventListener('click', settings.export);
      
      document.getElementById('importSettingsBtn').addEventListener('click', () => {
        document.getElementById('importSettings').click();
      });
      
      document.getElementById('importSettings').addEventListener('change', (e) => {
        if (e.target.files[0]) {
          settings.import(e.target.files[0]);
        }
      });
      
      document.getElementById('resetSettings').addEventListener('click', settings.reset);

      // Modal controls
      document.getElementById('registerGuestBtn').addEventListener('click', () => {
        document.getElementById('registerModal').classList.add('show');
      });

      document.querySelectorAll('[id^="close"]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
          });
        });
      });

      document.querySelectorAll('[id^="cancel"]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
          });
        });
      });

      // Form submissions
      document.getElementById('guestForm').addEventListener('submit', app.registerGuest);

      // Guest list interactions
      document.getElementById('currentGuestList').addEventListener('click', (e) => {
        const guestItem = e.target.closest('.guest-item');
        if (guestItem) {
          document.querySelectorAll('#currentGuestList .guest-item').forEach(item => {
            item.classList.remove('active');
          });
          guestItem.classList.add('active');
          
          app.selectedGuestId = guestItem.dataset.guestId;
          document.getElementById('selectedGuestInfo').classList.remove('hidden');
          document.getElementById('noGuestSelected').classList.add('hidden');
          
          app.loadGuestDetailsForDisplay(guestItem.dataset.guestId, JSON.parse(guestItem.dataset.guest));
        }
      });

      document.getElementById('pastGuestList').addEventListener('click', (e) => {
        const guestItem = e.target.closest('.guest-item');
        if (guestItem) {
          document.querySelectorAll('#pastGuestList .guest-item').forEach(item => {
            item.classList.remove('active');
          });
          guestItem.classList.add('active');
          
          app.selectedPastGuestId = guestItem.dataset.guestId;
          document.getElementById('selectedPastGuestInfo').classList.remove('hidden');
          document.getElementById('noPastGuestSelected').classList.add('hidden');
          
          app.loadPastGuestDetails(guestItem.dataset.guestId);
        }
      });

      // Calendar controls
      document.getElementById('prevMonth').addEventListener('click', () => {
        if (app.calendarInstance) app.calendarInstance.changeMonth(-1);
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        if (app.calendarInstance) app.calendarInstance.changeMonth(1);
      });

      document.getElementById('calendarRoomFilter').addEventListener('change', () => {
        app.updateOccupancyCalendar();
      });

      document.getElementById('viewCalendarBtn').addEventListener('click', () => {
        app.switchTab('calendar');
      });

      // Initialize app
      app.init();
    });

    // Make functions globally available
    window.app = app;
    window.settings = settings;
    window.utils = utils;
  </script>
</body>
</html>
